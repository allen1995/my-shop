{"version":3,"file":"list.js","sources":["pages/works/list.vue","../../../software/HBuilderX/plugins/uniapp-cli-vite/uniPage:/cGFnZXMvd29ya3MvbGlzdC52dWU"],"sourcesContent":["<template>\n  <view class=\"works-container\">\n    <view class=\"category-section\">\n      <view class=\"category-tabs\">\n        <view \n          class=\"category-tab\" \n          :class=\"{ active: selectedCategory === null }\"\n          @click=\"selectCategory(null)\"\n        >\n          <text>全部</text>\n        </view>\n        <view \n          class=\"category-tab\" \n          v-for=\"cat in categories\" \n          :key=\"cat\"\n          :class=\"{ active: selectedCategory === cat }\"\n          @click=\"selectCategory(cat)\"\n        >\n          <text>{{ cat }}</text>\n        </view>\n        <view class=\"category-tab add-category\" @click=\"showAddCategoryModal\">\n          <text>+ 添加分类</text>\n        </view>\n        <view \n          class=\"category-tab favorite-tab\" \n          :class=\"{ active: showFavorites }\"\n          @click=\"toggleFavorites\"\n        >\n          <text>⭐ 收藏</text>\n        </view>\n      </view>\n    </view>\n    \n    <view class=\"works-grid\" v-if=\"works.length > 0\">\n      <view \n        class=\"work-card\" \n        v-for=\"work in works\" \n        :key=\"work.id\"\n        @click=\"goToDetail(work.id)\"\n      >\n        <image class=\"work-image\" :src=\"work.imageUrl\" mode=\"aspectFill\"></image>\n        <view class=\"work-info\">\n          <view class=\"work-title-row\">\n            <text class=\"work-title\">{{ work.title }}</text>\n            <text class=\"favorite-icon\" :class=\"{ active: work.isFavorite }\" @click.stop=\"toggleFavorite(work)\">⭐</text>\n          </view>\n          <text class=\"work-time\">{{ formatTime(work.createTime) }}</text>\n        </view>\n      </view>\n    </view>\n    \n    <view class=\"empty-state\" v-else>\n      <image class=\"empty-icon\" src=\"/static/icons/empty.png\" mode=\"aspectFit\"></image>\n      <text class=\"empty-text\">还没有作品，快去生成吧~</text>\n      <button class=\"empty-btn\" @click=\"goToGenerate\">去生成</button>\n    </view>\n  </view>\n</template>\n\n<script setup>\nimport { ref, onMounted } from 'vue'\nimport { workApi } from '@/api/work'\nimport { onPullDownRefresh, onReachBottom, onShow } from '@dcloudio/uni-app'\n\nconst works = ref([])\nconst page = ref(0)\nconst size = ref(20)\nconst loading = ref(false)\nconst hasMore = ref(true)\nconst selectedCategory = ref(null)\nconst categories = ref([])\nconst showFavorites = ref(false)\n\nconst loadWorks = async (reset = false) => {\n  if (loading.value) return\n  \n  loading.value = true\n  \n  try {\n    if (reset) {\n      page.value = 0\n      works.value = []\n    }\n    \n    const params = {\n      page: page.value,\n      size: size.value\n    }\n    \n    if (showFavorites.value) {\n      params.favorite = true\n    } else if (selectedCategory.value) {\n      params.category = selectedCategory.value\n    }\n    \n    const res = await workApi.getWorks(params)\n    \n    if (res.code === 200 && res.data) {\n      const newWorks = res.data.content || []\n      works.value = reset ? newWorks : [...works.value, ...newWorks]\n      hasMore.value = newWorks.length === size.value\n      page.value++\n      \n      // 提取所有分类（保留已有分类）\n      extractCategories(newWorks)\n      console.log('加载作品后分类列表:', categories.value)\n    }\n  } catch (error) {\n    console.error('加载作品失败', error)\n  } finally {\n    loading.value = false\n    uni.stopPullDownRefresh()\n  }\n}\n\n// 从所有作品中提取分类（统一数据源）\nconst loadAllCategories = async () => {\n  try {\n    // 获取所有作品以提取分类\n    const res = await workApi.getWorks({ page: 0, size: 1000 })\n    if (res.code === 200 && res.data) {\n      const worksList = res.data.content || []\n      const catSet = new Set(categories.value) // 保留已有的分类\n      worksList.forEach(work => {\n        if (work.category) {\n          catSet.add(work.category)\n        }\n      })\n      categories.value = Array.from(catSet).sort()\n      console.log('加载所有分类:', categories.value)\n    }\n  } catch (error) {\n    console.error('加载分类列表失败', error)\n  }\n}\n\nconst extractCategories = (worksList) => {\n  const catSet = new Set(categories.value) // 保留已有的分类\n  worksList.forEach(work => {\n    if (work.category) {\n      catSet.add(work.category)\n    }\n  })\n  categories.value = Array.from(catSet).sort()\n}\n\nconst selectCategory = (category) => {\n  selectedCategory.value = category\n  showFavorites.value = false\n  loadWorks(true)\n}\n\nconst toggleFavorites = () => {\n  showFavorites.value = !showFavorites.value\n  selectedCategory.value = null\n  loadWorks(true)\n}\n\nconst showAddCategoryModal = () => {\n  uni.showModal({\n    title: '添加分类',\n    editable: true,\n    placeholderText: '请输入分类名称',\n    success: async (res) => {\n      if (res.confirm && res.content && res.content.trim()) {\n        const newCategory = res.content.trim()\n        console.log('添加分类:', newCategory)\n        \n        // 添加到分类列表（临时添加，实际分类需要为作品设置）\n        if (!categories.value.includes(newCategory)) {\n          categories.value.push(newCategory)\n          categories.value.sort()\n          console.log('分类列表已更新:', categories.value)\n        }\n        \n        // 重新加载所有分类，确保数据一致性\n        await loadAllCategories()\n        \n        // 选择新添加的分类\n        selectCategory(newCategory)\n      }\n    }\n  })\n}\n\nconst toggleFavorite = async (work) => {\n  try {\n    const res = await workApi.toggleFavorite(work.id)\n    if (res.code === 200 && res.data) {\n      work.isFavorite = res.data.isFavorite\n      uni.showToast({\n        title: work.isFavorite ? '已收藏' : '已取消收藏',\n        icon: 'success',\n        duration: 1000\n      })\n    }\n  } catch (error) {\n    uni.showToast({\n      title: '操作失败',\n      icon: 'none'\n    })\n  }\n}\n\nconst goToDetail = (workId) => {\n  uni.navigateTo({\n    url: `/pages/works/detail?id=${workId}`\n  })\n}\n\nconst goToGenerate = () => {\n  uni.switchTab({\n    url: '/pages/index/index'\n  })\n}\n\nconst formatTime = (timeStr) => {\n  if (!timeStr) return ''\n  const date = new Date(timeStr)\n  const now = new Date()\n  const diff = now - date\n  \n  if (diff < 60000) return '刚刚'\n  if (diff < 3600000) return Math.floor(diff / 60000) + '分钟前'\n  if (diff < 86400000) return Math.floor(diff / 3600000) + '小时前'\n  return Math.floor(diff / 86400000) + '天前'\n}\n\nonMounted(() => {\n  loadWorks(true)\n  loadAllCategories() // 加载所有分类\n})\n\nonShow(() => {\n  // 从其他页面返回时，检查是否有作品被删除\n  const app = getApp()\n  if (app && app.globalData && app.globalData.workDeleted) {\n    // 如果有作品被删除，刷新列表\n    const deletedWorkId = app.globalData.deletedWorkId\n    console.log('检测到作品被删除，刷新列表', deletedWorkId)\n    \n    // 从列表中移除被删除的作品\n    if (deletedWorkId) {\n      works.value = works.value.filter(work => work.id !== deletedWorkId)\n    }\n    \n    // 重新加载作品列表\n    loadWorks(true)\n    \n    // 清除标记\n    app.globalData.workDeleted = false\n    app.globalData.deletedWorkId = null\n  } else {\n    // 正常返回时，只重新加载分类列表\n    loadAllCategories()\n  }\n})\n\nonPullDownRefresh(() => {\n  loadWorks(true)\n  loadAllCategories() // 下拉刷新时也重新加载分类\n})\n\nonReachBottom(() => {\n  if (hasMore.value) {\n    loadWorks()\n  }\n})\n</script>\n\n<style lang=\"scss\" scoped>\n.works-container {\n  padding: 20rpx;\n  min-height: 100vh;\n  background-color: #F8F8F8;\n}\n\n.category-section {\n  background: #ffffff;\n  border-radius: 20rpx;\n  padding: 20rpx;\n  margin-bottom: 20rpx;\n  \n  .category-tabs {\n    display: flex;\n    flex-wrap: wrap;\n    gap: 15rpx;\n    \n    .category-tab {\n      padding: 10rpx 30rpx;\n      background: #F5F5F5;\n      border-radius: 30rpx;\n      font-size: 26rpx;\n      color: #666666;\n      transition: all 0.3s;\n      \n      &.active {\n        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);\n        color: #ffffff;\n      }\n      \n      &.add-category {\n        background: #E8F4FD;\n        color: #007AFF;\n        border: 1rpx dashed #007AFF;\n      }\n      \n      text {\n        display: block;\n      }\n    }\n  }\n}\n\n.works-grid {\n  display: grid;\n  grid-template-columns: repeat(2, 1fr);\n  gap: 20rpx;\n  \n  .work-card {\n    background: #ffffff;\n    border-radius: 20rpx;\n    overflow: hidden;\n    box-shadow: 0 4rpx 20rpx rgba(0, 0, 0, 0.1);\n    \n    .work-image {\n      width: 100%;\n      height: 300rpx;\n    }\n    \n    .work-info {\n      padding: 20rpx;\n      \n      .work-title {\n        display: block;\n        font-size: 28rpx;\n        font-weight: bold;\n        color: #333333;\n        margin-bottom: 10rpx;\n        overflow: hidden;\n        text-overflow: ellipsis;\n        white-space: nowrap;\n      }\n      \n      .work-time {\n        display: block;\n        font-size: 24rpx;\n        color: #999999;\n      }\n    }\n  }\n}\n\n.empty-state {\n  display: flex;\n  flex-direction: column;\n  align-items: center;\n  justify-content: center;\n  padding: 200rpx 40rpx;\n  \n  .empty-icon {\n    width: 200rpx;\n    height: 200rpx;\n    margin-bottom: 40rpx;\n    opacity: 0.5;\n  }\n  \n  .empty-text {\n    font-size: 32rpx;\n    color: #999999;\n    margin-bottom: 40rpx;\n  }\n  \n  .empty-btn {\n    padding: 20rpx 60rpx;\n    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);\n    color: #ffffff;\n    border-radius: 44rpx;\n    font-size: 28rpx;\n    border: none;\n  }\n}\n</style>\n\n\n","import MiniProgramPage from 'D:/code/my-shop-cursor/frontend/pages/works/list.vue'\nwx.createPage(MiniProgramPage)"],"names":["ref","workApi","uni","onMounted","onShow","onPullDownRefresh","onReachBottom"],"mappings":"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"}