{"version":3,"file":"list.js","sources":["pages/works/list.vue","../../../software/HBuilderX/plugins/uniapp-cli-vite/uniPage:/cGFnZXMvd29ya3MvbGlzdC52dWU"],"sourcesContent":["<template>\r\n  <view class=\"works-container\">\r\n    <view class=\"category-section\">\r\n      <view class=\"category-tabs\">\r\n        <view \r\n          class=\"category-tab\" \r\n          :class=\"{ active: selectedCategory === null }\"\r\n          @click=\"selectCategory(null)\"\r\n        >\r\n          <text>全部</text>\r\n        </view>\r\n        <view \r\n          class=\"category-tab\" \r\n          v-for=\"cat in categories\" \r\n          :key=\"cat\"\r\n          :class=\"{ active: selectedCategory === cat }\"\r\n          @click=\"selectCategory(cat)\"\r\n        >\r\n          <text>{{ cat }}</text>\r\n        </view>\r\n        <view class=\"category-tab add-category\" @click=\"showAddCategoryModal\">\r\n          <text>+ 添加分类</text>\r\n        </view>\r\n        <view \r\n          class=\"category-tab favorite-tab\" \r\n          :class=\"{ active: showFavorites }\"\r\n          @click=\"toggleFavorites\"\r\n        >\r\n          <text>⭐ 收藏</text>\r\n        </view>\r\n      </view>\r\n    </view>\r\n    \r\n    <view class=\"works-grid\" v-if=\"works.length > 0\">\r\n      <view \r\n        class=\"work-card\" \r\n        v-for=\"work in works\" \r\n        :key=\"work.id\"\r\n        @click=\"goToDetail(work.id)\"\r\n      >\r\n        <image class=\"work-image\" :src=\"work.imageUrl\" mode=\"aspectFill\"></image>\r\n        <view class=\"work-info\">\r\n          <view class=\"work-title-row\">\r\n            <text class=\"work-title\">{{ work.title }}</text>\r\n            <text class=\"favorite-icon\" :class=\"{ active: work.isFavorite }\" @click.stop=\"toggleFavorite(work)\">⭐</text>\r\n          </view>\r\n          <text class=\"work-time\">{{ formatTime(work.createTime) }}</text>\r\n        </view>\r\n      </view>\r\n    </view>\r\n    \r\n    <view class=\"empty-state\" v-else>\r\n      <image class=\"empty-icon\" src=\"/static/icons/empty.png\" mode=\"aspectFit\"></image>\r\n      <text class=\"empty-text\">还没有作品，快去生成吧~</text>\r\n      <button class=\"empty-btn\" @click=\"goToGenerate\">去生成</button>\r\n    </view>\r\n  </view>\r\n</template>\r\n\r\n<script setup>\r\nimport { ref, onMounted } from 'vue'\r\nimport { workApi } from '@/api/work'\r\nimport { onPullDownRefresh, onReachBottom, onShow } from '@dcloudio/uni-app'\r\n\r\nconst works = ref([])\r\nconst page = ref(0)\r\nconst size = ref(20)\r\nconst loading = ref(false)\r\nconst hasMore = ref(true)\r\nconst selectedCategory = ref(null)\r\nconst categories = ref([])\r\nconst showFavorites = ref(false)\r\n\r\nconst loadWorks = async (reset = false) => {\r\n  if (loading.value) return\r\n  \r\n  loading.value = true\r\n  \r\n  try {\r\n    if (reset) {\r\n      page.value = 0\r\n      works.value = []\r\n    }\r\n    \r\n    const params = {\r\n      page: page.value,\r\n      size: size.value\r\n    }\r\n    \r\n    if (showFavorites.value) {\r\n      params.favorite = true\r\n    } else if (selectedCategory.value) {\r\n      params.category = selectedCategory.value\r\n    }\r\n    \r\n    const res = await workApi.getWorks(params)\r\n    \r\n    if (res.code === 200 && res.data) {\r\n      const newWorks = res.data.content || []\r\n      works.value = reset ? newWorks : [...works.value, ...newWorks]\r\n      hasMore.value = newWorks.length === size.value\r\n      page.value++\r\n      \r\n      // 提取所有分类（保留已有分类）\r\n      extractCategories(newWorks)\r\n      console.log('加载作品后分类列表:', categories.value)\r\n    }\r\n  } catch (error) {\r\n    console.error('加载作品失败', error)\r\n  } finally {\r\n    loading.value = false\r\n    uni.stopPullDownRefresh()\r\n  }\r\n}\r\n\r\n// 从所有作品中提取分类（统一数据源）\r\nconst loadAllCategories = async () => {\r\n  try {\r\n    // 获取所有作品以提取分类\r\n    const res = await workApi.getWorks({ page: 0, size: 1000 })\r\n    if (res.code === 200 && res.data) {\r\n      const worksList = res.data.content || []\r\n      const catSet = new Set(categories.value) // 保留已有的分类\r\n      worksList.forEach(work => {\r\n        if (work.category) {\r\n          catSet.add(work.category)\r\n        }\r\n      })\r\n      categories.value = Array.from(catSet).sort()\r\n      console.log('加载所有分类:', categories.value)\r\n    }\r\n  } catch (error) {\r\n    console.error('加载分类列表失败', error)\r\n  }\r\n}\r\n\r\nconst extractCategories = (worksList) => {\r\n  const catSet = new Set(categories.value) // 保留已有的分类\r\n  worksList.forEach(work => {\r\n    if (work.category) {\r\n      catSet.add(work.category)\r\n    }\r\n  })\r\n  categories.value = Array.from(catSet).sort()\r\n}\r\n\r\nconst selectCategory = (category) => {\r\n  selectedCategory.value = category\r\n  showFavorites.value = false\r\n  loadWorks(true)\r\n}\r\n\r\nconst toggleFavorites = () => {\r\n  showFavorites.value = !showFavorites.value\r\n  selectedCategory.value = null\r\n  loadWorks(true)\r\n}\r\n\r\nconst showAddCategoryModal = () => {\r\n  uni.showModal({\r\n    title: '添加分类',\r\n    editable: true,\r\n    placeholderText: '请输入分类名称',\r\n    success: async (res) => {\r\n      if (res.confirm && res.content && res.content.trim()) {\r\n        const newCategory = res.content.trim()\r\n        console.log('添加分类:', newCategory)\r\n        \r\n        // 添加到分类列表（临时添加，实际分类需要为作品设置）\r\n        if (!categories.value.includes(newCategory)) {\r\n          categories.value.push(newCategory)\r\n          categories.value.sort()\r\n          console.log('分类列表已更新:', categories.value)\r\n        }\r\n        \r\n        // 重新加载所有分类，确保数据一致性\r\n        await loadAllCategories()\r\n        \r\n        // 选择新添加的分类\r\n        selectCategory(newCategory)\r\n      }\r\n    }\r\n  })\r\n}\r\n\r\nconst toggleFavorite = async (work) => {\r\n  try {\r\n    const res = await workApi.toggleFavorite(work.id)\r\n    if (res.code === 200 && res.data) {\r\n      work.isFavorite = res.data.isFavorite\r\n      uni.showToast({\r\n        title: work.isFavorite ? '已收藏' : '已取消收藏',\r\n        icon: 'success',\r\n        duration: 1000\r\n      })\r\n    }\r\n  } catch (error) {\r\n    uni.showToast({\r\n      title: '操作失败',\r\n      icon: 'none'\r\n    })\r\n  }\r\n}\r\n\r\nconst goToDetail = (workId) => {\r\n  uni.navigateTo({\r\n    url: `/pages/works/detail?id=${workId}`\r\n  })\r\n}\r\n\r\nconst goToGenerate = () => {\r\n  uni.switchTab({\r\n    url: '/pages/index/index'\r\n  })\r\n}\r\n\r\nconst formatTime = (timeStr) => {\r\n  if (!timeStr) return ''\r\n  const date = new Date(timeStr)\r\n  const now = new Date()\r\n  const diff = now - date\r\n  \r\n  if (diff < 60000) return '刚刚'\r\n  if (diff < 3600000) return Math.floor(diff / 60000) + '分钟前'\r\n  if (diff < 86400000) return Math.floor(diff / 3600000) + '小时前'\r\n  return Math.floor(diff / 86400000) + '天前'\r\n}\r\n\r\nonMounted(() => {\r\n  loadWorks(true)\r\n  loadAllCategories() // 加载所有分类\r\n})\r\n\r\nonShow(() => {\r\n  // 从其他页面返回时，重新加载分类列表（确保数据一致）\r\n  loadAllCategories()\r\n})\r\n\r\nonPullDownRefresh(() => {\r\n  loadWorks(true)\r\n  loadAllCategories() // 下拉刷新时也重新加载分类\r\n})\r\n\r\nonReachBottom(() => {\r\n  if (hasMore.value) {\r\n    loadWorks()\r\n  }\r\n})\r\n</script>\r\n\r\n<style lang=\"scss\" scoped>\r\n.works-container {\r\n  padding: 20rpx;\r\n  min-height: 100vh;\r\n  background-color: #F8F8F8;\r\n}\r\n\r\n.category-section {\r\n  background: #ffffff;\r\n  border-radius: 20rpx;\r\n  padding: 20rpx;\r\n  margin-bottom: 20rpx;\r\n  \r\n  .category-tabs {\r\n    display: flex;\r\n    flex-wrap: wrap;\r\n    gap: 15rpx;\r\n    \r\n    .category-tab {\r\n      padding: 10rpx 30rpx;\r\n      background: #F5F5F5;\r\n      border-radius: 30rpx;\r\n      font-size: 26rpx;\r\n      color: #666666;\r\n      transition: all 0.3s;\r\n      \r\n      &.active {\r\n        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);\r\n        color: #ffffff;\r\n      }\r\n      \r\n      &.add-category {\r\n        background: #E8F4FD;\r\n        color: #007AFF;\r\n        border: 1rpx dashed #007AFF;\r\n      }\r\n      \r\n      text {\r\n        display: block;\r\n      }\r\n    }\r\n  }\r\n}\r\n\r\n.works-grid {\r\n  display: grid;\r\n  grid-template-columns: repeat(2, 1fr);\r\n  gap: 20rpx;\r\n  \r\n  .work-card {\r\n    background: #ffffff;\r\n    border-radius: 20rpx;\r\n    overflow: hidden;\r\n    box-shadow: 0 4rpx 20rpx rgba(0, 0, 0, 0.1);\r\n    \r\n    .work-image {\r\n      width: 100%;\r\n      height: 300rpx;\r\n    }\r\n    \r\n    .work-info {\r\n      padding: 20rpx;\r\n      \r\n      .work-title {\r\n        display: block;\r\n        font-size: 28rpx;\r\n        font-weight: bold;\r\n        color: #333333;\r\n        margin-bottom: 10rpx;\r\n        overflow: hidden;\r\n        text-overflow: ellipsis;\r\n        white-space: nowrap;\r\n      }\r\n      \r\n      .work-time {\r\n        display: block;\r\n        font-size: 24rpx;\r\n        color: #999999;\r\n      }\r\n    }\r\n  }\r\n}\r\n\r\n.empty-state {\r\n  display: flex;\r\n  flex-direction: column;\r\n  align-items: center;\r\n  justify-content: center;\r\n  padding: 200rpx 40rpx;\r\n  \r\n  .empty-icon {\r\n    width: 200rpx;\r\n    height: 200rpx;\r\n    margin-bottom: 40rpx;\r\n    opacity: 0.5;\r\n  }\r\n  \r\n  .empty-text {\r\n    font-size: 32rpx;\r\n    color: #999999;\r\n    margin-bottom: 40rpx;\r\n  }\r\n  \r\n  .empty-btn {\r\n    padding: 20rpx 60rpx;\r\n    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);\r\n    color: #ffffff;\r\n    border-radius: 44rpx;\r\n    font-size: 28rpx;\r\n    border: none;\r\n  }\r\n}\r\n</style>\r\n\r\n\r\n","import MiniProgramPage from 'D:/code/my-shop-cursor/frontend/pages/works/list.vue'\nwx.createPage(MiniProgramPage)"],"names":["ref","workApi","uni","onMounted","onShow","onPullDownRefresh","onReachBottom"],"mappings":"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"}