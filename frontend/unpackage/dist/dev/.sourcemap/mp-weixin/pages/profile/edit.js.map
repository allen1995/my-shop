{"version":3,"file":"edit.js","sources":["pages/profile/edit.vue","../../../software/HBuilderX/plugins/uniapp-cli-vite/uniPage:/cGFnZXMvcHJvZmlsZS9lZGl0LnZ1ZQ"],"sourcesContent":["<template>\r\n  <view class=\"edit-profile-container\">\r\n    <view class=\"form-section\">\r\n      <view class=\"form-item\">\r\n        <text class=\"form-label\">头像</text>\r\n        <view class=\"avatar-section\">\r\n          <image \r\n            class=\"avatar-preview\" \r\n            :src=\"formData.avatarUrl || '/static/default-avatar.png'\" \r\n            mode=\"aspectFill\"\r\n            @click=\"chooseAvatar\"\r\n          ></image>\r\n          <text class=\"avatar-hint\">点击更换头像</text>\r\n        </view>\r\n      </view>\r\n      \r\n      <view class=\"form-item\">\r\n        <text class=\"form-label\">昵称</text>\r\n        <input \r\n          class=\"form-input\" \r\n          v-model=\"formData.nickName\" \r\n          placeholder=\"请输入昵称\"\r\n          maxlength=\"50\"\r\n        />\r\n      </view>\r\n      \r\n      <view class=\"form-item\">\r\n        <text class=\"form-label\">手机号</text>\r\n        <input \r\n          class=\"form-input\" \r\n          v-model=\"formData.phone\" \r\n          placeholder=\"请输入手机号\"\r\n          type=\"number\"\r\n          maxlength=\"11\"\r\n        />\r\n      </view>\r\n    </view>\r\n    \r\n    <view class=\"action-section\">\r\n      <button class=\"save-btn\" @click=\"handleSave\" :loading=\"saving\">\r\n        {{ saving ? '保存中...' : '保存' }}\r\n      </button>\r\n    </view>\r\n  </view>\r\n</template>\r\n\r\n<script setup>\r\nimport { ref, onMounted } from 'vue'\r\nimport { userApi } from '@/api/user'\r\nimport { useUserStore } from '@/store/user'\r\nimport { imageGenerationApi } from '@/api/imageGeneration'\r\nimport { onLoad } from '@dcloudio/uni-app'\r\n\r\nconst userStore = useUserStore()\r\nconst formData = ref({\r\n  nickName: '',\r\n  avatarUrl: '',\r\n  phone: ''\r\n})\r\nconst saving = ref(false)\r\n\r\nonLoad(async () => {\r\n  await loadUserInfo()\r\n})\r\n\r\nconst loadUserInfo = async () => {\r\n  try {\r\n    const res = await userApi.getProfile()\r\n    if (res.code === 200 && res.data) {\r\n      formData.value = {\r\n        nickName: res.data.nickName || '',\r\n        avatarUrl: res.data.avatarUrl || '',\r\n        phone: res.data.phone || ''\r\n      }\r\n    }\r\n  } catch (error) {\r\n    console.error('加载用户信息失败', error)\r\n    uni.showToast({\r\n      title: '加载用户信息失败',\r\n      icon: 'none'\r\n    })\r\n  }\r\n}\r\n\r\nconst chooseAvatar = () => {\r\n  uni.chooseImage({\r\n    count: 1,\r\n    sizeType: ['compressed'],\r\n    sourceType: ['album', 'camera'],\r\n    success: async (res) => {\r\n      const tempFilePath = res.tempFilePaths[0]\r\n      \r\n      uni.showLoading({\r\n        title: '上传中...'\r\n      })\r\n      \r\n      try {\r\n        // 上传头像到OSS\r\n        const uploadRes = await imageGenerationApi.uploadImage(tempFilePath)\r\n        if (uploadRes.code === 200 && uploadRes.data && uploadRes.data.imageUrl) {\r\n          formData.value.avatarUrl = uploadRes.data.imageUrl\r\n          uni.hideLoading()\r\n          uni.showToast({\r\n            title: '头像已更新',\r\n            icon: 'success'\r\n          })\r\n        } else {\r\n          throw new Error(uploadRes.message || '上传失败')\r\n        }\r\n      } catch (error) {\r\n        console.error('上传头像失败', error)\r\n        uni.hideLoading()\r\n        uni.showToast({\r\n          title: error.message || '上传失败，请重试',\r\n          icon: 'none'\r\n        })\r\n      }\r\n    },\r\n    fail: (err) => {\r\n      console.error('选择图片失败', err)\r\n      uni.showToast({\r\n        title: '选择图片失败',\r\n        icon: 'none'\r\n      })\r\n    }\r\n  })\r\n}\r\n\r\nconst handleSave = async () => {\r\n  // 参数验证\r\n  if (!formData.value.nickName || formData.value.nickName.trim().length === 0) {\r\n    uni.showToast({\r\n      title: '请输入昵称',\r\n      icon: 'none'\r\n    })\r\n    return\r\n  }\r\n  \r\n  if (formData.value.phone && !/^1[3-9]\\d{9}$/.test(formData.value.phone)) {\r\n    uni.showToast({\r\n      title: '请输入正确的手机号',\r\n      icon: 'none'\r\n    })\r\n    return\r\n  }\r\n  \r\n  // 如果头像URL是临时路径，不保存（使用之前的头像或空）\r\n  let avatarUrl = formData.value.avatarUrl\r\n  if (avatarUrl && (avatarUrl.includes('__tmp__') || avatarUrl.includes('127.0.0.1'))) {\r\n    console.warn('检测到临时路径，不保存头像:', avatarUrl)\r\n    avatarUrl = null // 不更新头像，保持原有头像\r\n  }\r\n  \r\n  saving.value = true\r\n  \r\n  try {\r\n    const res = await userApi.updateProfile({\r\n      nickName: formData.value.nickName.trim(),\r\n      avatarUrl: avatarUrl,\r\n      phone: formData.value.phone || null\r\n    })\r\n    \r\n    if (res.code === 200) {\r\n      uni.showToast({\r\n        title: '保存成功',\r\n        icon: 'success'\r\n      })\r\n      \r\n      // 更新store中的用户信息\r\n      if (res.data) {\r\n        userStore.user = res.data\r\n      }\r\n      \r\n      // 延迟返回上一页\r\n      setTimeout(() => {\r\n        uni.navigateBack()\r\n      }, 1500)\r\n    } else {\r\n      uni.showToast({\r\n        title: res.message || '保存失败',\r\n        icon: 'none'\r\n      })\r\n    }\r\n  } catch (error) {\r\n    console.error('保存用户信息失败', error)\r\n    uni.showToast({\r\n      title: '保存失败，请重试',\r\n      icon: 'none'\r\n    })\r\n  } finally {\r\n    saving.value = false\r\n  }\r\n}\r\n</script>\r\n\r\n<style lang=\"scss\" scoped>\r\n.edit-profile-container {\r\n  min-height: 100vh;\r\n  background-color: #F8F8F8;\r\n  padding-bottom: 200rpx;\r\n}\r\n\r\n.form-section {\r\n  background: #ffffff;\r\n  margin: 20rpx;\r\n  border-radius: 20rpx;\r\n  padding: 40rpx;\r\n  \r\n  .form-item {\r\n    margin-bottom: 40rpx;\r\n    \r\n    &:last-child {\r\n      margin-bottom: 0;\r\n    }\r\n    \r\n    .form-label {\r\n      display: block;\r\n      font-size: 28rpx;\r\n      color: #333333;\r\n      margin-bottom: 20rpx;\r\n      font-weight: 500;\r\n    }\r\n    \r\n    .form-input {\r\n      width: 100%;\r\n      height: 80rpx;\r\n      padding: 0 20rpx;\r\n      background: #F5F5F5;\r\n      border-radius: 10rpx;\r\n      font-size: 28rpx;\r\n      color: #333333;\r\n    }\r\n    \r\n    .avatar-section {\r\n      display: flex;\r\n      flex-direction: column;\r\n      align-items: center;\r\n      \r\n      .avatar-preview {\r\n        width: 200rpx;\r\n        height: 200rpx;\r\n        border-radius: 100rpx;\r\n        border: 4rpx solid #E5E5E5;\r\n        margin-bottom: 20rpx;\r\n      }\r\n      \r\n      .avatar-hint {\r\n        font-size: 24rpx;\r\n        color: #999999;\r\n      }\r\n    }\r\n  }\r\n}\r\n\r\n.action-section {\r\n  position: fixed;\r\n  bottom: 0;\r\n  left: 0;\r\n  right: 0;\r\n  padding: 30rpx 40rpx;\r\n  background: #ffffff;\r\n  box-shadow: 0 -4rpx 20rpx rgba(0, 0, 0, 0.1);\r\n  \r\n  .save-btn {\r\n    width: 100%;\r\n    height: 88rpx;\r\n    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);\r\n    color: #ffffff;\r\n    border-radius: 44rpx;\r\n    font-size: 32rpx;\r\n    font-weight: bold;\r\n    border: none;\r\n    \r\n    &[loading] {\r\n      opacity: 0.7;\r\n    }\r\n  }\r\n}\r\n</style>\r\n\r\n","import MiniProgramPage from 'D:/code/my-shop-cursor/frontend/pages/profile/edit.vue'\nwx.createPage(MiniProgramPage)"],"names":["useUserStore","ref","onLoad","userApi","uni","imageGenerationApi"],"mappings":"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"}