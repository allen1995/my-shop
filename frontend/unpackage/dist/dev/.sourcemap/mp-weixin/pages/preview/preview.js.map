{"version":3,"file":"preview.js","sources":["pages/preview/preview.vue","../../../software/HBuilderX/plugins/uniapp-cli-vite/uniPage:/cGFnZXMvcHJldmlldy9wcmV2aWV3LnZ1ZQ"],"sourcesContent":["<template>\n  <view class=\"preview-container\">\n    <view class=\"preview-section\">\n      <!-- 暂时使用 image 标签显示，确保页面能正常渲染 -->\n      <image \n        v-if=\"imageUrl\"\n        :src=\"imageUrl\" \n        class=\"preview-image\"\n        mode=\"aspectFit\"\n      ></image>\n      <view v-else class=\"preview-placeholder\">\n        <text class=\"placeholder-text\">暂无预览图片</text>\n      </view>\n    </view>\n    \n    <view class=\"product-section\">\n      <view class=\"product-selector\">\n        <text class=\"selector-label\">选择包包款式</text>\n        <picker :range=\"products\" range-key=\"name\" @change=\"onProductChange\">\n          <view class=\"picker-view\">{{ selectedProduct?.name || '请选择' }}</view>\n        </picker>\n      </view>\n      \n      <view class=\"spec-selector\" v-if=\"selectedProduct\">\n        <view class=\"spec-item\">\n          <text class=\"spec-label\">颜色</text>\n          <view class=\"spec-options\">\n            <view \n              class=\"spec-option\" \n              v-for=\"color in selectedProduct.colors\" \n              :key=\"color\"\n              :class=\"{ active: selectedColor === color }\"\n              @click=\"selectedColor = color\"\n            >{{ color }}</view>\n          </view>\n        </view>\n        \n        <view class=\"spec-item\">\n          <text class=\"spec-label\">尺寸</text>\n          <view class=\"spec-options\">\n            <view \n              class=\"spec-option\" \n              v-for=\"size in selectedProduct.sizes\" \n              :key=\"size\"\n              :class=\"{ active: selectedSize === size }\"\n              @click=\"selectedSize = size\"\n            >{{ size }}</view>\n          </view>\n        </view>\n      </view>\n    </view>\n    \n    <view class=\"action-section\">\n      <button class=\"add-cart-btn\" @click=\"handleAddToCart\" :disabled=\"!canAddToCart\">\n        加入购物车\n      </button>\n    </view>\n  </view>\n</template>\n\n<script setup>\nimport { ref, computed, onMounted, nextTick } from 'vue'\nimport { productApi } from '@/api/product'\nimport { cartApi } from '@/api/cart'\nimport { onLoad } from '@dcloudio/uni-app'\n\nconst workId = ref(null)\nconst imageUrl = ref('')\nconst products = ref([])\nconst selectedProduct = ref(null)\nconst selectedColor = ref('')\nconst selectedSize = ref('')\n\nconst canAddToCart = computed(() => {\n  return selectedProduct.value && selectedColor.value && selectedSize.value\n})\n\nonLoad(async (options) => {\n  workId.value = options.workId || null\n  imageUrl.value = decodeURIComponent(options.imageUrl || '')\n  console.log('预览页面加载 - workId:', workId.value, 'imageUrl:', imageUrl.value)\n  \n  if (!workId.value) {\n    uni.showToast({\n      title: '缺少作品ID，无法添加到购物车',\n      icon: 'none',\n      duration: 2000\n    })\n  }\n  \n  await loadProducts()\n})\n\nconst loadProducts = async () => {\n  try {\n    const res = await productApi.getProducts()\n    console.log('商品列表响应:', res)\n    if (res.code === 200 && res.data) {\n      products.value = res.data || []\n      console.log('商品列表:', products.value)\n      \n      // 处理商品数据，确保 colors 和 sizes 是数组\n      products.value = products.value.map(product => {\n        // 如果 colors 是字符串（JSON），解析为数组\n        if (typeof product.colors === 'string') {\n          try {\n            product.colors = JSON.parse(product.colors)\n          } catch (e) {\n            product.colors = []\n          }\n        }\n        // 如果 sizes 是字符串（JSON），解析为数组\n        if (typeof product.sizes === 'string') {\n          try {\n            product.sizes = JSON.parse(product.sizes)\n          } catch (e) {\n            product.sizes = []\n          }\n        }\n        return product\n      })\n      \n      if (products.value.length > 0) {\n        selectedProduct.value = products.value[0]\n        if (selectedProduct.value.colors && selectedProduct.value.colors.length > 0) {\n          selectedColor.value = selectedProduct.value.colors[0]\n        }\n        if (selectedProduct.value.sizes && selectedProduct.value.sizes.length > 0) {\n          selectedSize.value = selectedProduct.value.sizes[0]\n        }\n      }\n    } else {\n      console.warn('商品列表加载失败:', res.message)\n      // 如果加载失败，使用默认商品数据，确保页面能显示\n      products.value = []\n    }\n  } catch (error) {\n    console.error('加载商品失败', error)\n    // 加载失败时，使用空数组，确保页面能显示\n    products.value = []\n  }\n}\n\nconst onProductChange = (e) => {\n  selectedProduct.value = products.value[e.detail.value]\n  if (selectedProduct.value.colors && selectedProduct.value.colors.length > 0) {\n    selectedColor.value = selectedProduct.value.colors[0]\n  }\n  if (selectedProduct.value.sizes && selectedProduct.value.sizes.length > 0) {\n    selectedSize.value = selectedProduct.value.sizes[0]\n  }\n}\n\nconst handleAddToCart = async () => {\n  if (!canAddToCart.value) {\n    uni.showToast({\n      title: '请选择商品规格',\n      icon: 'none'\n    })\n    return\n  }\n  \n  if (!workId.value) {\n    uni.showModal({\n      title: '提示',\n      content: '当前图片未保存为作品，无法添加到购物车。是否先保存为作品？',\n      success: async (res) => {\n        if (res.confirm) {\n          // 跳转到作品集页面，让用户先保存\n          uni.showToast({\n            title: '请先保存作品',\n            icon: 'none'\n          })\n          setTimeout(() => {\n            uni.switchTab({\n              url: '/pages/works/list'\n            })\n          }, 1500)\n        }\n      }\n    })\n    return\n  }\n  \n  if (!selectedProduct.value || !selectedColor.value || !selectedSize.value) {\n    uni.showToast({\n      title: '信息不完整',\n      icon: 'none'\n    })\n    return\n  }\n  \n  try {\n    console.log('添加购物车 - workId:', workId.value, 'productId:', selectedProduct.value.id, 'color:', selectedColor.value, 'size:', selectedSize.value)\n    \n    const res = await cartApi.addToCart({\n      workId: workId.value,\n      productId: selectedProduct.value.id,\n      color: selectedColor.value,\n      size: selectedSize.value,\n      quantity: 1,\n      previewImageUrl: imageUrl.value\n    })\n    \n    console.log('添加购物车响应:', res)\n    \n    if (res.code === 200) {\n      uni.showToast({\n        title: '已加入购物车',\n        icon: 'success'\n      })\n      \n      // 延迟跳转，让用户看到成功提示\n      setTimeout(() => {\n        uni.switchTab({\n          url: '/pages/cart/cart'\n        })\n      }, 1500)\n    } else {\n      uni.showToast({\n        title: res.message || '加入购物车失败',\n        icon: 'none'\n      })\n    }\n  } catch (error) {\n    console.error('加入购物车异常:', error)\n    uni.showToast({\n      title: '加入购物车失败',\n      icon: 'none'\n    })\n  }\n}\n</script>\n\n<style lang=\"scss\" scoped>\n.preview-container {\n  min-height: 100vh;\n  background-color: #F8F8F8;\n}\n\n.preview-section {\n  background: #ffffff;\n  padding: 40rpx;\n  margin-bottom: 20rpx;\n  display: flex;\n  justify-content: center;\n  align-items: center;\n  min-height: 400rpx;\n  \n  .preview-image {\n    width: 100%;\n    max-width: 750rpx;\n    height: 750rpx;\n    border: 2rpx solid #E5E5E5;\n    border-radius: 20rpx;\n  }\n  \n  .preview-placeholder {\n    width: 100%;\n    height: 400rpx;\n    display: flex;\n    align-items: center;\n    justify-content: center;\n    background: #F5F5F5;\n    border-radius: 20rpx;\n    \n    .placeholder-text {\n      font-size: 28rpx;\n      color: #999999;\n    }\n  }\n}\n\n.product-section {\n  background: #ffffff;\n  padding: 40rpx;\n  margin-bottom: 20rpx;\n  \n  .product-selector {\n    margin-bottom: 40rpx;\n    \n    .selector-label {\n      display: block;\n      font-size: 32rpx;\n      font-weight: bold;\n      color: #333333;\n      margin-bottom: 20rpx;\n    }\n    \n    .picker-view {\n      padding: 20rpx;\n      background: #F5F5F5;\n      border-radius: 10rpx;\n      font-size: 28rpx;\n      color: #333333;\n    }\n  }\n  \n  .spec-selector {\n    .spec-item {\n      margin-bottom: 30rpx;\n      \n      &:last-child {\n        margin-bottom: 0;\n      }\n      \n      .spec-label {\n        display: block;\n        font-size: 28rpx;\n        font-weight: bold;\n        color: #333333;\n        margin-bottom: 20rpx;\n      }\n      \n      .spec-options {\n        display: flex;\n        gap: 20rpx;\n        flex-wrap: wrap;\n        \n        .spec-option {\n          padding: 15rpx 30rpx;\n          background: #F5F5F5;\n          border-radius: 8rpx;\n          font-size: 26rpx;\n          color: #666666;\n          \n          &.active {\n            background: #007AFF;\n            color: #ffffff;\n          }\n        }\n      }\n    }\n  }\n}\n\n.action-section {\n  position: fixed;\n  bottom: 0;\n  left: 0;\n  right: 0;\n  padding: 30rpx 40rpx;\n  background: #ffffff;\n  box-shadow: 0 -4rpx 20rpx rgba(0, 0, 0, 0.1);\n  \n  .add-cart-btn {\n    width: 100%;\n    height: 88rpx;\n    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);\n    color: #ffffff;\n    border-radius: 44rpx;\n    font-size: 32rpx;\n    font-weight: bold;\n    border: none;\n    \n    &[disabled] {\n      background: #CCCCCC;\n    }\n  }\n}\n</style>\n\n\n","import MiniProgramPage from 'D:/code/my-shop-cursor/frontend/pages/preview/preview.vue'\nwx.createPage(MiniProgramPage)"],"names":["ref","computed","onLoad","uni","productApi","cartApi"],"mappings":";;;;;;;AAkEA,UAAM,SAASA,cAAG,IAAC,IAAI;AACvB,UAAM,WAAWA,cAAG,IAAC,EAAE;AACvB,UAAM,WAAWA,cAAG,IAAC,EAAE;AACvB,UAAM,kBAAkBA,cAAG,IAAC,IAAI;AAChC,UAAM,gBAAgBA,cAAG,IAAC,EAAE;AAC5B,UAAM,eAAeA,cAAG,IAAC,EAAE;AAE3B,UAAM,eAAeC,cAAQ,SAAC,MAAM;AAClC,aAAO,gBAAgB,SAAS,cAAc,SAAS,aAAa;AAAA,IACtE,CAAC;AAEDC,kBAAM,OAAC,OAAO,YAAY;AACxB,aAAO,QAAQ,QAAQ,UAAU;AACjC,eAAS,QAAQ,mBAAmB,QAAQ,YAAY,EAAE;AAC1DC,0BAAA,MAAA,OAAA,mCAAY,oBAAoB,OAAO,OAAO,aAAa,SAAS,KAAK;AAEzE,UAAI,CAAC,OAAO,OAAO;AACjBA,sBAAAA,MAAI,UAAU;AAAA,UACZ,OAAO;AAAA,UACP,MAAM;AAAA,UACN,UAAU;AAAA,QAChB,CAAK;AAAA,MACF;AAED,YAAM,aAAc;AAAA,IACtB,CAAC;AAED,UAAM,eAAe,YAAY;AAC/B,UAAI;AACF,cAAM,MAAM,MAAMC,YAAU,WAAC,YAAa;AAC1CD,sBAAAA,sDAAY,WAAW,GAAG;AAC1B,YAAI,IAAI,SAAS,OAAO,IAAI,MAAM;AAChC,mBAAS,QAAQ,IAAI,QAAQ,CAAE;AAC/BA,wBAAA,MAAA,MAAA,OAAA,oCAAY,SAAS,SAAS,KAAK;AAGnC,mBAAS,QAAQ,SAAS,MAAM,IAAI,aAAW;AAE7C,gBAAI,OAAO,QAAQ,WAAW,UAAU;AACtC,kBAAI;AACF,wBAAQ,SAAS,KAAK,MAAM,QAAQ,MAAM;AAAA,cAC3C,SAAQ,GAAG;AACV,wBAAQ,SAAS,CAAE;AAAA,cACpB;AAAA,YACF;AAED,gBAAI,OAAO,QAAQ,UAAU,UAAU;AACrC,kBAAI;AACF,wBAAQ,QAAQ,KAAK,MAAM,QAAQ,KAAK;AAAA,cACzC,SAAQ,GAAG;AACV,wBAAQ,QAAQ,CAAE;AAAA,cACnB;AAAA,YACF;AACD,mBAAO;AAAA,UACf,CAAO;AAED,cAAI,SAAS,MAAM,SAAS,GAAG;AAC7B,4BAAgB,QAAQ,SAAS,MAAM,CAAC;AACxC,gBAAI,gBAAgB,MAAM,UAAU,gBAAgB,MAAM,OAAO,SAAS,GAAG;AAC3E,4BAAc,QAAQ,gBAAgB,MAAM,OAAO,CAAC;AAAA,YACrD;AACD,gBAAI,gBAAgB,MAAM,SAAS,gBAAgB,MAAM,MAAM,SAAS,GAAG;AACzE,2BAAa,QAAQ,gBAAgB,MAAM,MAAM,CAAC;AAAA,YACnD;AAAA,UACF;AAAA,QACP,OAAW;AACLA,wBAAA,MAAA,MAAA,QAAA,oCAAa,aAAa,IAAI,OAAO;AAErC,mBAAS,QAAQ,CAAE;AAAA,QACpB;AAAA,MACF,SAAQ,OAAO;AACdA,sBAAAA,yDAAc,UAAU,KAAK;AAE7B,iBAAS,QAAQ,CAAE;AAAA,MACpB;AAAA,IACH;AAEA,UAAM,kBAAkB,CAAC,MAAM;AAC7B,sBAAgB,QAAQ,SAAS,MAAM,EAAE,OAAO,KAAK;AACrD,UAAI,gBAAgB,MAAM,UAAU,gBAAgB,MAAM,OAAO,SAAS,GAAG;AAC3E,sBAAc,QAAQ,gBAAgB,MAAM,OAAO,CAAC;AAAA,MACrD;AACD,UAAI,gBAAgB,MAAM,SAAS,gBAAgB,MAAM,MAAM,SAAS,GAAG;AACzE,qBAAa,QAAQ,gBAAgB,MAAM,MAAM,CAAC;AAAA,MACnD;AAAA,IACH;AAEA,UAAM,kBAAkB,YAAY;AAClC,UAAI,CAAC,aAAa,OAAO;AACvBA,sBAAAA,MAAI,UAAU;AAAA,UACZ,OAAO;AAAA,UACP,MAAM;AAAA,QACZ,CAAK;AACD;AAAA,MACD;AAED,UAAI,CAAC,OAAO,OAAO;AACjBA,sBAAAA,MAAI,UAAU;AAAA,UACZ,OAAO;AAAA,UACP,SAAS;AAAA,UACT,SAAS,OAAO,QAAQ;AACtB,gBAAI,IAAI,SAAS;AAEfA,4BAAAA,MAAI,UAAU;AAAA,gBACZ,OAAO;AAAA,gBACP,MAAM;AAAA,cAClB,CAAW;AACD,yBAAW,MAAM;AACfA,8BAAAA,MAAI,UAAU;AAAA,kBACZ,KAAK;AAAA,gBACnB,CAAa;AAAA,cACF,GAAE,IAAI;AAAA,YACR;AAAA,UACF;AAAA,QACP,CAAK;AACD;AAAA,MACD;AAED,UAAI,CAAC,gBAAgB,SAAS,CAAC,cAAc,SAAS,CAAC,aAAa,OAAO;AACzEA,sBAAAA,MAAI,UAAU;AAAA,UACZ,OAAO;AAAA,UACP,MAAM;AAAA,QACZ,CAAK;AACD;AAAA,MACD;AAED,UAAI;AACFA,sBAAA,MAAA,MAAA,OAAA,oCAAY,mBAAmB,OAAO,OAAO,cAAc,gBAAgB,MAAM,IAAI,UAAU,cAAc,OAAO,SAAS,aAAa,KAAK;AAE/I,cAAM,MAAM,MAAME,SAAO,QAAC,UAAU;AAAA,UAClC,QAAQ,OAAO;AAAA,UACf,WAAW,gBAAgB,MAAM;AAAA,UACjC,OAAO,cAAc;AAAA,UACrB,MAAM,aAAa;AAAA,UACnB,UAAU;AAAA,UACV,iBAAiB,SAAS;AAAA,QAChC,CAAK;AAEDF,sBAAAA,uDAAY,YAAY,GAAG;AAE3B,YAAI,IAAI,SAAS,KAAK;AACpBA,wBAAAA,MAAI,UAAU;AAAA,YACZ,OAAO;AAAA,YACP,MAAM;AAAA,UACd,CAAO;AAGD,qBAAW,MAAM;AACfA,0BAAAA,MAAI,UAAU;AAAA,cACZ,KAAK;AAAA,YACf,CAAS;AAAA,UACF,GAAE,IAAI;AAAA,QACb,OAAW;AACLA,wBAAAA,MAAI,UAAU;AAAA,YACZ,OAAO,IAAI,WAAW;AAAA,YACtB,MAAM;AAAA,UACd,CAAO;AAAA,QACF;AAAA,MACF,SAAQ,OAAO;AACdA,sBAAAA,MAAA,MAAA,SAAA,oCAAc,YAAY,KAAK;AAC/BA,sBAAAA,MAAI,UAAU;AAAA,UACZ,OAAO;AAAA,UACP,MAAM;AAAA,QACZ,CAAK;AAAA,MACF;AAAA,IACH;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;ACtOA,GAAG,WAAW,eAAe;"}