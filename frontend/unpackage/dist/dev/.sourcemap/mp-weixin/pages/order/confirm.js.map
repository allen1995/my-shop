{"version":3,"file":"confirm.js","sources":["pages/order/confirm.vue","../../../software/HBuilderX/plugins/uniapp-cli-vite/uniPage:/cGFnZXMvb3JkZXIvY29uZmlybS52dWU"],"sourcesContent":["<template>\r\n  <view class=\"confirm-container\">\r\n    <view class=\"order-items-section\">\r\n      <text class=\"section-title\">订单商品</text>\r\n      <view class=\"order-item\" v-for=\"item in orderItems\" :key=\"item.id\">\r\n        <image class=\"item-image\" :src=\"item.previewImageUrl\" mode=\"aspectFill\"></image>\r\n        <view class=\"item-info\">\r\n          <text class=\"item-title\">定制包包</text>\r\n          <text class=\"item-spec\">{{ item.color }} | {{ item.size }} | x{{ item.quantity }}</text>\r\n          <text class=\"item-price\">¥{{ item.price }}</text>\r\n        </view>\r\n      </view>\r\n    </view>\r\n    \r\n    <view class=\"address-section\">\r\n      <text class=\"section-title\">收货地址</text>\r\n      <view class=\"address-card\" @click=\"selectAddress\">\r\n        <text class=\"address-text\" v-if=\"selectedAddress\">\r\n          {{ selectedAddress.receiverName }} {{ selectedAddress.receiverPhone }}\r\n          {{ selectedAddress.province }}{{ selectedAddress.city }}{{ selectedAddress.district }}{{ selectedAddress.detailAddress }}\r\n        </text>\r\n        <text class=\"address-placeholder\" v-else>请选择收货地址</text>\r\n        <text class=\"address-arrow\">></text>\r\n      </view>\r\n    </view>\r\n    \r\n    <view class=\"price-section\">\r\n      <view class=\"price-row\">\r\n        <text class=\"price-label\">商品总价</text>\r\n        <text class=\"price-value\">¥{{ totalAmount }}</text>\r\n      </view>\r\n      <view class=\"price-row\">\r\n        <text class=\"price-label\">运费</text>\r\n        <text class=\"price-value\">¥{{ shippingFee }}</text>\r\n      </view>\r\n      <view class=\"price-row total-row\">\r\n        <text class=\"price-label\">实付金额</text>\r\n        <text class=\"price-value\">¥{{ finalAmount }}</text>\r\n      </view>\r\n    </view>\r\n    \r\n    <view class=\"action-section\">\r\n      <button class=\"submit-btn\" @click=\"handleSubmit\" :disabled=\"!canSubmit\" :loading=\"submitting\">\r\n        提交订单\r\n      </button>\r\n    </view>\r\n  </view>\r\n</template>\r\n\r\n<script setup>\r\nimport { ref, computed } from 'vue'\r\nimport { cartApi } from '@/api/cart'\r\nimport { orderApi } from '@/api/order'\r\nimport { addressApi } from '@/api/address'\r\nimport { onLoad, onShow } from '@dcloudio/uni-app'\r\n\r\nconst orderItems = ref([])\r\nconst selectedAddress = ref(null)\r\nconst shippingFee = ref(10)\r\nconst submitting = ref(false)\r\n\r\nconst totalAmount = computed(() => {\r\n  return orderItems.value.reduce((sum, item) => {\r\n    return sum + (item.price || 0) * item.quantity\r\n  }, 0).toFixed(2)\r\n})\r\n\r\nconst finalAmount = computed(() => {\r\n  return (parseFloat(totalAmount.value) + shippingFee.value).toFixed(2)\r\n})\r\n\r\nconst canSubmit = computed(() => {\r\n  return orderItems.value.length > 0 && selectedAddress.value\r\n})\r\n\r\nonLoad(async (options) => {\r\n  // 获取选中的商品ID列表\r\n  const itemIds = options.itemIds ? options.itemIds.split(',').map(id => parseInt(id)) : []\r\n  await loadCartItems(itemIds)\r\n  await loadDefaultAddress()\r\n})\r\n\r\nonShow(() => {\r\n  // 从地址列表页面返回时，检查全局数据中是否有选中的地址\r\n  const app = getApp()\r\n  if (app.globalData && app.globalData.selectedAddress) {\r\n    selectedAddress.value = app.globalData.selectedAddress\r\n    // 清除全局数据\r\n    app.globalData.selectedAddress = null\r\n  }\r\n})\r\n\r\nconst loadCartItems = async (selectedIds = []) => {\r\n  try {\r\n    const res = await cartApi.getCartItems()\r\n    if (res.code === 200 && res.data) {\r\n      let items = res.data || []\r\n      \r\n      // 如果有选中的ID，只加载选中的商品\r\n      if (selectedIds.length > 0) {\r\n        items = items.filter(item => selectedIds.includes(item.id))\r\n      }\r\n      \r\n      // 转换为订单项格式，使用后端返回的实际价格\r\n      orderItems.value = items.map(item => ({\r\n        id: item.id,\r\n        workId: item.workId,\r\n        productId: item.productId,\r\n        color: item.color,\r\n        size: item.size,\r\n        quantity: item.quantity,\r\n        price: item.price || 0, // 使用后端返回的实际价格\r\n        previewImageUrl: item.previewImageUrl\r\n      }))\r\n      \r\n      console.log('订单商品加载成功，共', orderItems.value.length, '项')\r\n    }\r\n  } catch (error) {\r\n    console.error('加载购物车失败', error)\r\n    uni.showToast({\r\n      title: '加载商品失败',\r\n      icon: 'none'\r\n    })\r\n  }\r\n}\r\n\r\n// 加载默认地址\r\nconst loadDefaultAddress = async () => {\r\n  try {\r\n    const res = await addressApi.getAddresses()\r\n    if (res.code === 200 && res.data) {\r\n      // 查找默认地址\r\n      const defaultAddress = res.data.find(addr => addr.isDefault)\r\n      if (defaultAddress) {\r\n        selectedAddress.value = defaultAddress\r\n      } else if (res.data.length > 0) {\r\n        // 如果没有默认地址，使用第一个地址\r\n        selectedAddress.value = res.data[0]\r\n      }\r\n    }\r\n  } catch (error) {\r\n    console.error('加载默认地址失败', error)\r\n  }\r\n}\r\n\r\n// 根据ID加载地址\r\nconst loadAddressById = async (addressId) => {\r\n  try {\r\n    const res = await addressApi.getAddress(addressId)\r\n    if (res.code === 200 && res.data) {\r\n      selectedAddress.value = res.data\r\n    }\r\n  } catch (error) {\r\n    console.error('加载地址失败', error)\r\n  }\r\n}\r\n\r\nconst selectAddress = () => {\r\n  uni.navigateTo({\r\n    url: '/pages/address/list?select=true'\r\n  })\r\n}\r\n\r\nconst handleSubmit = async () => {\r\n  if (!canSubmit.value) {\r\n    if (!selectedAddress.value) {\r\n      uni.showToast({\r\n        title: '请选择收货地址',\r\n        icon: 'none'\r\n      })\r\n    }\r\n    return\r\n  }\r\n  \r\n  submitting.value = true\r\n  \r\n  try {\r\n    const cartItemIds = orderItems.value.map(item => item.id)\r\n    \r\n    console.log('创建订单 - cartItemIds:', cartItemIds, 'addressId:', selectedAddress.value?.id)\r\n    \r\n    if (!selectedAddress.value || !selectedAddress.value.id) {\r\n      uni.showToast({\r\n        title: '请选择收货地址',\r\n        icon: 'none'\r\n      })\r\n      submitting.value = false\r\n      return\r\n    }\r\n    \r\n    const res = await orderApi.createOrder({\r\n      cartItemIds,\r\n      addressId: selectedAddress.value.id\r\n    })\r\n    \r\n    console.log('创建订单响应:', res)\r\n    \r\n    if (res.code === 200 && res.data) {\r\n      const order = res.data\r\n      \r\n      uni.showToast({\r\n        title: '订单创建成功',\r\n        icon: 'success'\r\n      })\r\n      \r\n      // 跳转到支付页\r\n      setTimeout(() => {\r\n        uni.redirectTo({\r\n          url: `/pages/order/payment?orderId=${order.id}`\r\n        })\r\n      }, 1500)\r\n    } else {\r\n      uni.showToast({\r\n        title: res.message || '创建订单失败',\r\n        icon: 'none',\r\n        duration: 2000\r\n      })\r\n    }\r\n  } catch (error) {\r\n    console.error('创建订单异常:', error)\r\n    uni.showToast({\r\n      title: error.message || '创建订单失败',\r\n      icon: 'none',\r\n      duration: 2000\r\n    })\r\n  } finally {\r\n    submitting.value = false\r\n  }\r\n}\r\n</script>\r\n\r\n<style lang=\"scss\" scoped>\r\n.confirm-container {\r\n  min-height: 100vh;\r\n  background-color: #F8F8F8;\r\n  padding-bottom: 120rpx;\r\n}\r\n\r\n.order-items-section,\r\n.address-section,\r\n.price-section {\r\n  background: #ffffff;\r\n  margin-bottom: 20rpx;\r\n  padding: 40rpx;\r\n  \r\n  .section-title {\r\n    display: block;\r\n    font-size: 32rpx;\r\n    font-weight: bold;\r\n    color: #333333;\r\n    margin-bottom: 30rpx;\r\n  }\r\n}\r\n\r\n.order-item {\r\n  display: flex;\r\n  align-items: center;\r\n  margin-bottom: 30rpx;\r\n  \r\n  &:last-child {\r\n    margin-bottom: 0;\r\n  }\r\n  \r\n  .item-image {\r\n    width: 120rpx;\r\n    height: 120rpx;\r\n    border-radius: 10rpx;\r\n    margin-right: 20rpx;\r\n  }\r\n  \r\n  .item-info {\r\n    flex: 1;\r\n    \r\n    .item-title {\r\n      display: block;\r\n      font-size: 28rpx;\r\n      font-weight: bold;\r\n      color: #333333;\r\n      margin-bottom: 10rpx;\r\n    }\r\n    \r\n    .item-spec {\r\n      display: block;\r\n      font-size: 24rpx;\r\n      color: #999999;\r\n      margin-bottom: 10rpx;\r\n    }\r\n    \r\n    .item-price {\r\n      display: block;\r\n      font-size: 32rpx;\r\n      font-weight: bold;\r\n      color: #FF3B30;\r\n    }\r\n  }\r\n}\r\n\r\n.address-card {\r\n  display: flex;\r\n  align-items: center;\r\n  padding: 30rpx;\r\n  background: #F5F5F5;\r\n  border-radius: 10rpx;\r\n  \r\n  .address-text,\r\n  .address-placeholder {\r\n    flex: 1;\r\n    font-size: 28rpx;\r\n    color: #333333;\r\n  }\r\n  \r\n  .address-placeholder {\r\n    color: #999999;\r\n  }\r\n  \r\n  .address-arrow {\r\n    font-size: 32rpx;\r\n    color: #999999;\r\n  }\r\n}\r\n\r\n.price-row {\r\n  display: flex;\r\n  justify-content: space-between;\r\n  align-items: center;\r\n  margin-bottom: 20rpx;\r\n  \r\n  &:last-child {\r\n    margin-bottom: 0;\r\n  }\r\n  \r\n  .price-label {\r\n    font-size: 28rpx;\r\n    color: #666666;\r\n  }\r\n  \r\n  .price-value {\r\n    font-size: 28rpx;\r\n    color: #333333;\r\n  }\r\n  \r\n  &.total-row {\r\n    padding-top: 20rpx;\r\n    border-top: 2rpx solid #E5E5E5;\r\n    \r\n    .price-label {\r\n      font-size: 32rpx;\r\n      font-weight: bold;\r\n      color: #333333;\r\n    }\r\n    \r\n    .price-value {\r\n      font-size: 40rpx;\r\n      font-weight: bold;\r\n      color: #FF3B30;\r\n    }\r\n  }\r\n}\r\n\r\n.action-section {\r\n  position: fixed;\r\n  bottom: 0;\r\n  left: 0;\r\n  right: 0;\r\n  padding: 30rpx 40rpx;\r\n  background: #ffffff;\r\n  box-shadow: 0 -4rpx 20rpx rgba(0, 0, 0, 0.1);\r\n  \r\n  .submit-btn {\r\n    width: 100%;\r\n    height: 88rpx;\r\n    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);\r\n    color: #ffffff;\r\n    border-radius: 44rpx;\r\n    font-size: 32rpx;\r\n    font-weight: bold;\r\n    border: none;\r\n    \r\n    &[disabled] {\r\n      background: #CCCCCC;\r\n    }\r\n  }\r\n}\r\n</style>\r\n\r\n\r\n","import MiniProgramPage from 'D:/code/my-shop-cursor/frontend/pages/order/confirm.vue'\nwx.createPage(MiniProgramPage)"],"names":["ref","computed","onLoad","onShow","cartApi","uni","addressApi","orderApi"],"mappings":"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"}