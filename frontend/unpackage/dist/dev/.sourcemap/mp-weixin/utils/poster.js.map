{"version":3,"file":"poster.js","sources":["utils/poster.js"],"sourcesContent":["/**\r\n * 海报生成工具\r\n */\r\n\r\n/**\r\n * 生成分享海报\r\n * @param {Object} options 配置选项\r\n * @param {String} options.imageUrl 作品图片URL\r\n * @param {String} options.title 作品标题\r\n * @param {String} options.shareUrl 分享链接\r\n * @param {Number} options.width 画布宽度，默认750\r\n * @param {Number} options.height 画布高度，默认1334\r\n * @returns {Promise<String>} 返回生成的图片临时路径\r\n */\r\nexport async function generatePoster(options) {\r\n  const {\r\n    imageUrl,\r\n    title = '我的AI作品',\r\n    shareUrl = '',\r\n    width = 750,\r\n    height = 1334\r\n  } = options\r\n\r\n  return new Promise((resolve, reject) => {\r\n    // 创建canvas上下文\r\n    const ctx = uni.createCanvasContext('share-poster-canvas')\r\n    \r\n    // 设置画布尺寸\r\n    const canvasWidth = width\r\n    const canvasHeight = height\r\n    \r\n    // 背景色\r\n    ctx.setFillStyle('#ffffff')\r\n    ctx.fillRect(0, 0, canvasWidth, canvasHeight)\r\n    \r\n    // 加载作品图片\r\n    uni.getImageInfo({\r\n      src: imageUrl,\r\n      success: async (imageRes) => {\r\n        try {\r\n          // 计算图片显示尺寸（保持比例）\r\n          const imageMaxWidth = canvasWidth - 80 // 左右各40rpx边距\r\n          const imageMaxHeight = canvasHeight - 400 // 预留底部空间\r\n          const imageAspectRatio = imageRes.width / imageRes.height\r\n          let imageWidth = imageMaxWidth\r\n          let imageHeight = imageMaxWidth / imageAspectRatio\r\n          \r\n          if (imageHeight > imageMaxHeight) {\r\n            imageHeight = imageMaxHeight\r\n            imageWidth = imageMaxHeight * imageAspectRatio\r\n          }\r\n          \r\n          const imageX = (canvasWidth - imageWidth) / 2\r\n          const imageY = 60 // 顶部边距\r\n          \r\n          // 绘制作品图片\r\n          ctx.drawImage(imageUrl, imageX, imageY, imageWidth, imageHeight)\r\n          \r\n          // 绘制标题\r\n          ctx.setFillStyle('#333333')\r\n          ctx.setFontSize(36)\r\n          ctx.setTextAlign('center')\r\n          const titleY = imageY + imageHeight + 60\r\n          // 处理标题过长的情况\r\n          const maxTitleWidth = canvasWidth - 80\r\n          const titleLines = wrapText(ctx, title, maxTitleWidth, 36)\r\n          titleLines.forEach((line, index) => {\r\n            ctx.fillText(line, canvasWidth / 2, titleY + index * 50)\r\n          })\r\n          \r\n          // 绘制提示文字\r\n          ctx.setFillStyle('#666666')\r\n          ctx.setFontSize(24)\r\n          const hintY = titleY + titleLines.length * 50 + 30\r\n          ctx.fillText('长按识别二维码查看', canvasWidth / 2, hintY)\r\n          \r\n          // 生成二维码（如果提供了分享链接）\r\n          if (shareUrl) {\r\n            try {\r\n              // 尝试生成二维码\r\n              const qrCodeUrl = await generateQRCode(shareUrl, 200)\r\n              if (qrCodeUrl) {\r\n                // 等待二维码图片加载\r\n                uni.getImageInfo({\r\n                  src: qrCodeUrl,\r\n                  success: (qrRes) => {\r\n                    const qrSize = 200\r\n                    const qrX = (canvasWidth - qrSize) / 2\r\n                    const qrY = hintY + 50\r\n                    ctx.drawImage(qrCodeUrl, qrX, qrY, qrSize, qrSize)\r\n                    drawPoster(ctx, canvasWidth, canvasHeight)\r\n                  },\r\n                  fail: () => {\r\n                    // 二维码加载失败，绘制占位符\r\n                    drawQRPlaceholder(ctx, canvasWidth, hintY + 50)\r\n                    drawPoster(ctx, canvasWidth, canvasHeight)\r\n                  }\r\n                })\r\n              } else {\r\n                // 二维码生成失败，绘制占位符\r\n                drawQRPlaceholder(ctx, canvasWidth, hintY + 50)\r\n                drawPoster(ctx, canvasWidth, canvasHeight)\r\n              }\r\n            } catch (error) {\r\n              // 二维码生成失败，绘制占位符\r\n              drawQRPlaceholder(ctx, canvasWidth, hintY + 50)\r\n              drawPoster(ctx, canvasWidth, canvasHeight)\r\n            }\r\n          } else {\r\n            drawPoster(ctx, canvasWidth, canvasHeight)\r\n          }\r\n          \r\n          function drawQRPlaceholder(ctx, canvasWidth, qrY) {\r\n            const qrSize = 200\r\n            const qrX = (canvasWidth - qrSize) / 2\r\n            // 绘制二维码占位框\r\n            ctx.setFillStyle('#000000')\r\n            ctx.fillRect(qrX, qrY, qrSize, qrSize)\r\n            // 绘制占位文字\r\n            ctx.setFillStyle('#ffffff')\r\n            ctx.setFontSize(20)\r\n            ctx.setTextAlign('center')\r\n            ctx.fillText('二维码', canvasWidth / 2, qrY + qrSize / 2)\r\n          }\r\n          \r\n          function drawPoster(ctx, canvasWidth, canvasHeight) {\r\n            // 绘制底部信息\r\n            ctx.setFillStyle('#999999')\r\n            ctx.setFontSize(20)\r\n            const bottomY = canvasHeight - 40\r\n            ctx.fillText('AI印花电商小程序', canvasWidth / 2, bottomY)\r\n            \r\n            // 执行绘制\r\n            ctx.draw(false, () => {\r\n              // 延迟一下确保绘制完成\r\n              setTimeout(() => {\r\n                // 导出图片\r\n                uni.canvasToTempFilePath({\r\n                  canvasId: 'share-poster-canvas',\r\n                  width: canvasWidth,\r\n                  height: canvasHeight,\r\n                  destWidth: canvasWidth,\r\n                  destHeight: canvasHeight,\r\n                  success: (res) => {\r\n                    resolve(res.tempFilePath)\r\n                  },\r\n                  fail: (err) => {\r\n                    reject(err)\r\n                  }\r\n                })\r\n              }, 500)\r\n            })\r\n          }\r\n        } catch (error) {\r\n          reject(error)\r\n        }\r\n      },\r\n      fail: (err) => {\r\n        reject(err)\r\n      }\r\n    })\r\n  })\r\n}\r\n\r\n/**\r\n * 文本换行处理（简化版，按字符数换行）\r\n */\r\nfunction wrapText(ctx, text, maxWidth, fontSize) {\r\n  // uni-app的Canvas API可能不支持measureText，使用简化方案\r\n  // 根据字体大小估算每行可容纳的字符数\r\n  const charsPerLine = Math.floor(maxWidth / (fontSize * 0.6)) // 估算：字符宽度约为字体大小的0.6倍\r\n  const lines = []\r\n  \r\n  // 如果文本长度小于等于每行字符数，直接返回\r\n  if (text.length <= charsPerLine) {\r\n    return [text]\r\n  }\r\n  \r\n  // 按字符数分割\r\n  for (let i = 0; i < text.length; i += charsPerLine) {\r\n    lines.push(text.substring(i, i + charsPerLine))\r\n  }\r\n  \r\n  return lines.length > 0 ? lines : [text]\r\n}\r\n\r\n/**\r\n * 保存海报到相册\r\n * @param {String} imagePath 图片路径\r\n * @returns {Promise}\r\n */\r\nexport async function savePosterToAlbum(imagePath) {\r\n  return new Promise((resolve, reject) => {\r\n    uni.saveImageToPhotosAlbum({\r\n      filePath: imagePath,\r\n      success: () => {\r\n        uni.showToast({\r\n          title: '保存成功',\r\n          icon: 'success'\r\n        })\r\n        resolve()\r\n      },\r\n      fail: (err) => {\r\n        if (err.errMsg.includes('auth deny')) {\r\n          uni.showModal({\r\n            title: '提示',\r\n            content: '需要授权访问相册',\r\n            success: (modalRes) => {\r\n              if (modalRes.confirm) {\r\n                uni.openSetting()\r\n              }\r\n            }\r\n          })\r\n        } else {\r\n          uni.showToast({\r\n            title: '保存失败',\r\n            icon: 'none'\r\n          })\r\n        }\r\n        reject(err)\r\n      }\r\n    })\r\n  })\r\n}\r\n\r\n/**\r\n * 生成二维码（使用在线API，实际项目中应使用后端API或插件）\r\n * @param {String} text 二维码内容\r\n * @param {Number} size 二维码尺寸\r\n * @returns {Promise<String>} 返回二维码图片URL\r\n */\r\nexport async function generateQRCode(text, size = 200) {\r\n  // 实际项目中应该：\r\n  // 1. 使用后端API生成二维码（推荐）\r\n  // 2. 或使用uni-app插件市场的二维码生成插件\r\n  // 3. 或使用canvas绘制二维码（需要二维码算法库）\r\n  \r\n  // 这里使用在线API作为临时方案\r\n  return new Promise((resolve) => {\r\n    // 使用在线二维码生成服务（临时方案）\r\n    const qrUrl = `https://api.qrserver.com/v1/create-qr-code/?size=${size}x${size}&data=${encodeURIComponent(text)}`\r\n    \r\n    // 验证URL是否可访问\r\n    uni.getImageInfo({\r\n      src: qrUrl,\r\n      success: () => {\r\n        resolve(qrUrl)\r\n      },\r\n      fail: () => {\r\n        // 如果在线API失败，返回空字符串，使用占位符\r\n        resolve('')\r\n      }\r\n    })\r\n  })\r\n}\r\n\r\n"],"names":["uni","ctx","canvasWidth","canvasHeight"],"mappings":"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"}