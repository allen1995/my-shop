# Story 12.4: 多模型支持实现

## Status

Draft

## Story

**As a** developer,
**I want** to support multiple AI models,
**so that** we can switch models based on requirements.

## Acceptance Criteria

1. 支持DashScope（阿里云百炼）
2. 支持DALL·E 3（如果Spring AI支持）
3. 支持Stable Diffusion（如果Spring AI支持）
4. 实现模型选择策略（配置化）
5. 支持模型降级（主模型失败时使用备用模型）

## Tasks / Subtasks

- [ ] Task 1: 配置多模型支持 (AC: 1, 2, 3)
  - [ ] 在application.yml中配置多个模型
  - [ ] 配置DashScope模型
  - [ ] 配置DALL·E模型（如果支持）
  - [ ] 配置Stable Diffusion模型（如果支持）

- [ ] Task 2: 实现模型选择策略 (AC: 4)
  - [ ] 创建ModelSelector服务
  - [ ] 实现基于配置的模型选择
  - [ ] 支持按用户等级选择模型
  - [ ] 支持按生成类型选择模型

- [ ] Task 3: 实现模型降级机制 (AC: 5)
  - [ ] 实现主模型失败检测
  - [ ] 实现自动切换到备用模型
  - [ ] 记录模型切换日志
  - [ ] 实现模型健康检查

- [ ] Task 4: 创建模型抽象接口
  - [ ] 创建统一的ImageModel接口
  - [ ] 实现DashScopeImageModel
  - [ ] 实现OpenAIImageModel（如果支持）
  - [ ] 实现StabilityImageModel（如果支持）

- [ ] Task 5: 实现模型路由
  - [ ] 根据配置选择模型
  - [ ] 根据用户等级选择模型
  - [ ] 根据生成类型选择模型
  - [ ] 实现模型切换逻辑

- [ ] Task 6: 添加监控和日志
  - [ ] 记录模型使用情况
  - [ ] 记录模型切换事件
  - [ ] 记录模型性能指标
  - [ ] 实现模型使用统计

## Dev Notes

### Previous Story Insights

依赖Story 12.1（Spring Alibaba AI依赖和配置）、Story 12.2（重构文生图服务）和Story 12.3（重构图生图服务）完成，确保基础框架已搭建。

### Data Models

**模型配置：**
```yaml
app:
  ai:
    models:
      dashscope:
        enabled: true
        priority: 1
        api-key: ${DASHSCOPE_API_KEY}
      openai:
        enabled: true
        priority: 2
        api-key: ${OPENAI_API_KEY}
      stability:
        enabled: true
        priority: 3
        api-key: ${STABILITY_API_KEY}
    selection-strategy:
      default: dashscope
      premium-users: openai
      cost-sensitive: stability
```

**模型选择策略：**
```java
public enum ModelSelectionStrategy {
    DEFAULT,           // 使用默认模型
    USER_LEVEL,        // 根据用户等级
    COST_SENSITIVE,    // 成本敏感
    QUALITY_FIRST      // 质量优先
}
```

### API Specifications

本故事不涉及新的API接口，仅内部实现。

### File Locations

**后端文件位置：**
```
backend/src/main/java/com/myshop/
├── config/
│   └── SpringAIConfig.java           # Spring AI配置（更新）
├── service/
│   ├── AIGenerationService.java       # AI生成服务（更新）
│   └── ModelSelector.java             # 模型选择器（新建）
└── model/
    ├── ImageModel.java                # 模型接口（新建）
    ├── DashScopeImageModel.java       # DashScope实现（新建）
    ├── OpenAIImageModel.java          # OpenAI实现（新建，如果支持）
    └── StabilityImageModel.java       # Stability实现（新建，如果支持）
```

### Technical Constraints

- **Spring Alibaba AI**: 使用ImageModel接口
- **模型选择**: 配置化，支持多种策略
- **降级机制**: 自动切换，保证可用性
- **监控**: 记录模型使用情况

### 模型选择实现示例

```java
@Service
public class ModelSelector {
    
    @Autowired
    private Map<String, ImageModel> imageModels;
    
    @Value("${app.ai.selection-strategy.default}")
    private String defaultModel;
    
    public ImageModel selectModel(ImageGenerationRequest request) {
        // 策略1：根据用户等级
        if (request.getUserLevel() == UserLevel.PREMIUM) {
            return imageModels.get("openai");
        }
        
        // 策略2：根据成本敏感度
        if (request.isCostSensitive()) {
            return imageModels.get("stability");
        }
        
        // 策略3：默认模型
        return imageModels.getOrDefault(defaultModel, imageModels.values().iterator().next());
    }
}
```

### 模型降级实现示例

```java
public String generateImageWithFallback(ImageGenerationRequest request) {
    ImageModel primaryModel = modelSelector.selectModel(request);
    ImageModel fallbackModel = getFallbackModel(primaryModel);
    
    try {
        return primaryModel.call(request);
    } catch (Exception e) {
        log.warn("主模型失败，切换到备用模型", e);
        try {
            return fallbackModel.call(request);
        } catch (Exception e2) {
            log.error("备用模型也失败", e2);
            throw new RuntimeException("所有模型都失败", e2);
        }
    }
}
```

### Testing Requirements

- 使用JUnit 5进行单元测试
- 使用Mockito Mock不同模型
- 测试文件位置：`backend/src/test/java/com/myshop/service/ModelSelectorTest.java`
- 测试模型选择
- 测试模型降级

## Testing

### Test File Location

测试文件应创建在：`backend/src/test/java/com/myshop/service/ModelSelectorTest.java`

### Test Standards

- 使用JUnit 5和Spring Boot Test
- 使用Mockito Mock ImageModel
- 测试模型选择逻辑
- 测试模型降级

### Test Scenarios

1. **模型选择测试**
   - 测试默认模型选择
   - 测试根据用户等级选择
   - 测试根据成本敏感度选择

2. **模型降级测试**
   - Mock主模型失败
   - 验证自动切换到备用模型
   - 验证备用模型也失败时的处理

3. **多模型配置测试**
   - 验证多个模型Bean创建
   - 验证模型配置正确
   - 验证模型切换正常

### Success Criteria

- 支持多个AI模型
- 模型选择策略正确
- 模型降级机制正常
- 监控和日志完整
- 单元测试通过

## Change Log

| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2024-12-16 | 1.0 | 初始故事创建 | PM |

## Dev Agent Record

### Agent Model Used

_To be filled by Dev Agent_

### Debug Log References

_To be filled by Dev Agent_

### Completion Notes List

_To be filled by Dev Agent_

### File List

_To be filled by Dev Agent_

## QA Results

_To be filled by QA Agent_

