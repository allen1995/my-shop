# Story 3.2: 保存作品API接口

## Status

Draft

## Story

**As a** user,
**I want** to save a generated image to my collection,
**so that** I can access it later for preview and purchase.

## Acceptance Criteria

1. 后端提供 `/api/works` POST接口
2. 接口接收title、description、imageUrl、tags参数
3. 创建作品记录到数据库
4. 返回创建的作品信息
5. 接口包含参数验证和错误处理
6. 支持用户身份验证

## Tasks / Subtasks

- [ ] Task 1: 创建请求和响应DTO (AC: 2, 4)
  - [ ] 创建SaveWorkRequest DTO
  - [ ] 创建WorkResponse DTO
  - [ ] 添加参数验证注解
- [ ] Task 2: 创建WorkController (AC: 1, 2, 5, 6)
  - [ ] 创建WorkController
  - [ ] 实现POST /api/works接口
  - [ ] 接收并验证请求参数
  - [ ] 从UserContext获取当前用户ID
  - [ ] 调用Service层处理
  - [ ] 返回创建的作品信息
  - [ ] 添加错误处理
- [ ] Task 3: 创建WorkService (AC: 3, 4)
  - [ ] 创建WorkService服务类
  - [ ] 实现saveWork方法
  - [ ] 创建Work实体对象
  - [ ] 保存到数据库
  - [ ] 返回保存的作品信息
- [ ] Task 4: 实现参数验证 (AC: 5)
  - [ ] 验证title不能为空
  - [ ] 验证imageUrl不能为空
  - [ ] 验证imageUrl格式（URL格式）
  - [ ] 返回友好的验证错误信息
- [ ] Task 5: 创建单元测试 (AC: 1, 2, 3, 5, 6)
  - [ ] 创建WorkControllerTest
  - [ ] 测试保存作品接口
  - [ ] 测试参数验证
  - [ ] 测试用户身份验证
  - [ ] 测试错误处理

## Dev Notes

### Previous Story Insights

依赖Story 3.1（作品实体和数据库设计）和Story 1.6（JWT认证中间件）完成，确保Work实体类和UserContext已创建。

### Data Models

使用Story 3.1创建的Work实体类。

**请求DTO：**
- SaveWorkRequest: { title: string, description?: string, imageUrl: string, tags?: string[] }

**响应DTO：**
- WorkResponse: { id, userId, title, description, imageUrl, tags, createTime, updateTime }

[Source: docs/fullstack-architecture.md#Work（作品）]

### API Specifications

**POST /api/works**
- 描述：保存作品
- 认证：需要JWT Token
- 请求体：`{ title: string, description?: string, imageUrl: string, tags?: string[] }`
- 响应：`{ work: Work }`

**工作流程：**
1. 验证用户身份（通过JWT）
2. 验证请求参数
3. 创建Work实体对象
4. 保存到数据库
5. 返回创建的作品信息

[Source: docs/fullstack-architecture.md#API Specification]

### File Locations

**后端文件位置：**
```
backend/src/main/java/com/myshop/
├── controller/
│   └── WorkController.java          # 作品控制器
├── service/
│   └── WorkService.java             # 作品服务
└── dto/
    ├── SaveWorkRequest.java         # 保存作品请求DTO
    └── WorkResponse.java             # 作品响应DTO
```

[Source: docs/fullstack-architecture.md#Repository Structure]

### Technical Constraints

- **用户身份**: 从UserContext获取当前用户ID，自动设置userId
- **参数验证**: 使用Bean Validation注解
- **错误处理**: 统一的异常处理和错误响应格式

[Source: docs/fullstack-architecture.md#Tech Stack]

### Testing Requirements

- 使用JUnit 5和MockMvc进行Controller测试
- 使用Mockito Mock UserContext和Service层
- 测试文件位置：`backend/src/test/java/com/myshop/controller/WorkControllerTest.java`
- 测试正常保存流程
- 测试参数验证
- 测试用户身份验证

[Source: docs/fullstack-architecture.md#Tech Stack]

## Testing

### Test File Location

测试文件应创建在：`backend/src/test/java/com/myshop/controller/WorkControllerTest.java`

### Test Standards

- 使用JUnit 5和Spring Boot Test
- 使用MockMvc测试REST接口
- 使用Mockito Mock依赖

### Test Scenarios

1. **正常保存作品测试**
   - 发送有效的作品信息
   - 验证保存成功
   - 验证返回的作品信息正确

2. **参数验证测试**
   - 测试title为空
   - 测试imageUrl为空
   - 测试imageUrl格式错误
   - 验证返回验证错误信息

3. **用户身份验证测试**
   - 测试未认证请求
   - 验证返回401状态码

### Success Criteria

- 保存作品接口能够正常创建作品
- 参数验证正确
- 用户身份验证正确
- 错误处理完善

## Change Log

| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2024-12-15 | 1.0 | 初始故事创建 | Scrum Master |

## Dev Agent Record

### Agent Model Used

_To be filled by Dev Agent_

### Debug Log References

_To be filled by Dev Agent_

### Completion Notes List

_To be filled by Dev Agent_

### File List

_To be filled by Dev Agent_

## QA Results

_To be filled by QA Agent_

