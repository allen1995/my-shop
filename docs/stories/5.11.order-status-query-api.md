# Story 5.11: 订单状态查询API

## Status

Draft

## Story

**As a** user,
**I want** to check my order status,
**so that** I can track my purchase.

## Acceptance Criteria

1. 后端提供 `/api/orders/{orderId}` GET接口
2. 返回订单的完整信息和当前状态
3. 验证订单属于当前用户
4. 接口响应时间小于100ms

## Tasks / Subtasks

- [ ] Task 1: 创建响应DTO (AC: 2)
  - [ ] 创建OrderDetailResponse DTO
  - [ ] 包含订单完整信息：订单号、状态、总价、订单项、地址等
- [ ] Task 2: 扩展OrderController (AC: 1, 3, 4)
  - [ ] 实现GET /api/orders/{orderId}接口
  - [ ] 从UserContext获取当前用户ID
  - [ ] 验证订单存在且属于当前用户
  - [ ] 调用Service层查询订单详情
  - [ ] 返回订单完整信息
  - [ ] 添加错误处理
- [ ] Task 3: 扩展OrderService (AC: 2, 4)
  - [ ] 实现getOrderDetail方法
  - [ ] 查询订单信息
  - [ ] 关联查询订单项、地址等信息
  - [ ] 返回完整的订单信息
- [ ] Task 4: 性能优化 (AC: 4)
  - [ ] 使用JOIN查询减少数据库访问次数
  - [ ] 添加适当的索引
  - [ ] 验证响应时间
- [ ] Task 5: 创建单元测试 (AC: 1, 2, 3, 4)
  - [ ] 创建OrderControllerTest测试
  - [ ] 测试查询订单详情
  - [ ] 测试权限验证
  - [ ] 验证返回数据完整性

## Dev Notes

### Previous Story Insights

依赖Story 5.6（订单实体）和Story 1.6（JWT认证中间件）完成，确保Order实体类和UserContext已创建。

### Data Models

使用Story 5.6创建的Order和OrderItem实体类。

**响应DTO：**
- OrderDetailResponse: { id, orderNo, status, totalAmount, items, address, paymentStatus, createTime, updateTime }

[Source: docs/fullstack-architecture.md#Order（订单）]

### API Specifications

**GET /api/orders/{orderId}**
- 描述：查询订单详情
- 认证：需要JWT Token
- 路径参数：orderId - 订单ID
- 响应：`{ order: OrderDetailResponse }`

**业务逻辑：**
- 验证订单存在且属于当前用户
- 查询订单完整信息
- 关联查询订单项、地址等信息
- 返回订单详情

[Source: docs/fullstack-architecture.md#API Specification]

### File Locations

**后端文件位置：**
```
backend/src/main/java/com/myshop/
├── controller/
│   └── OrderController.java          # 订单控制器（扩展）
├── service/
│   └── OrderService.java            # 订单服务（扩展）
└── dto/
    └── OrderDetailResponse.java      # 订单详情响应DTO
```

[Source: docs/fullstack-architecture.md#Repository Structure]

### Technical Constraints

- **用户身份**: 从UserContext获取当前用户ID
- **权限验证**: 只能查询自己的订单
- **性能要求**: 响应时间小于100ms，需要使用JOIN查询优化

[Source: docs/fullstack-architecture.md#Tech Stack]

### Testing Requirements

- 使用JUnit 5和MockMvc进行Controller测试
- 测试文件位置：`backend/src/test/java/com/myshop/controller/OrderControllerTest.java`
- 测试查询订单详情
- 测试权限验证
- 验证返回数据完整性

[Source: docs/fullstack-architecture.md#Tech Stack]

## Testing

### Test File Location

测试文件应创建在：`backend/src/test/java/com/myshop/controller/OrderControllerTest.java`

### Test Standards

- 使用JUnit 5和Spring Boot Test
- 使用MockMvc测试REST接口
- 使用Mockito Mock依赖

### Test Scenarios

1. **正常查询订单详情测试**
   - 创建订单
   - 查询订单详情
   - 验证返回完整的订单信息
   - 验证包含订单项、地址等信息

2. **权限验证测试**
   - 尝试查询其他用户的订单
   - 验证返回403或404错误

3. **订单不存在测试**
   - 尝试查询不存在的订单
   - 验证返回404错误

### Success Criteria

- 订单详情查询接口能够正常工作
- 返回数据完整
- 权限验证正确
- 接口响应时间小于100ms

## Change Log

| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2024-12-15 | 1.0 | 初始故事创建 | Scrum Master |

## Dev Agent Record

### Agent Model Used

_To be filled by Dev Agent_

### Debug Log References

_To be filled by Dev Agent_

### Completion Notes List

_To be filled by Dev Agent_

### File List

_To be filled by Dev Agent_

## QA Results

_To be filled by QA Agent_

