# Story 5.4: 更新购物车项API

## Status

Draft

## Story

**As a** user,
**I want** to update cart item quantity or specifications,
**so that** I can modify my order before checkout.

## Acceptance Criteria

1. 后端提供 `/api/cart/items/{itemId}` PUT接口
2. 支持更新数量、颜色、尺寸等
3. 验证购物车项属于当前用户
4. 返回更新后的购物车项信息

## Tasks / Subtasks

- [ ] Task 1: 创建请求DTO (AC: 2)
  - [ ] 创建UpdateCartItemRequest DTO
  - [ ] 包含quantity、color、size等可选字段
  - [ ] 添加参数验证注解
- [ ] Task 2: 扩展CartController (AC: 1, 3, 4)
  - [ ] 实现PUT /api/cart/items/{itemId}接口
  - [ ] 接收并验证请求参数
  - [ ] 从UserContext获取当前用户ID
  - [ ] 验证购物车项属于当前用户
  - [ ] 调用Service层更新
  - [ ] 返回更新后的购物车项信息
  - [ ] 添加错误处理
- [ ] Task 3: 扩展CartService (AC: 2, 3)
  - [ ] 实现updateCartItem方法
  - [ ] 验证购物车项存在且属于当前用户
  - [ ] 更新购物车项的字段（quantity、color、size等）
  - [ ] 如果更新后数量为0，删除该购物车项
  - [ ] 返回更新后的购物车项信息
- [ ] Task 4: 实现参数验证 (AC: 2)
  - [ ] 验证quantity大于0（如果提供）
  - [ ] 验证color和size格式（如果提供）
  - [ ] 返回友好的验证错误信息
- [ ] Task 5: 创建单元测试 (AC: 1, 2, 3, 4)
  - [ ] 创建CartControllerTest测试
  - [ ] 测试更新购物车项
  - [ ] 测试权限验证（不能更新其他用户的购物车项）
  - [ ] 测试参数验证

## Dev Notes

### Previous Story Insights

依赖Story 5.1（购物车实体和数据库设计）和Story 1.6（JWT认证中间件）完成，确保CartItem实体类和UserContext已创建。

### Data Models

使用Story 5.1创建的CartItem实体类。

**请求DTO：**
- UpdateCartItemRequest: { quantity?: number, color?: string, size?: string }

**响应DTO：**
- CartItemResponse: { id, userId, workId, productId, color, size, quantity, previewImageUrl, createTime, updateTime }

[Source: docs/fullstack-architecture.md#CartItem（购物车项）]

### API Specifications

**PUT /api/cart/items/{itemId}**
- 描述：更新购物车项
- 认证：需要JWT Token
- 路径参数：itemId - 购物车项ID
- 请求体：`{ quantity?: number, color?: string, size?: string }`
- 响应：`{ cartItem: CartItem }`

**业务逻辑：**
- 验证购物车项存在且属于当前用户
- 更新提供的字段
- 如果quantity更新为0，删除该购物车项
- 如果更新后与另一个购物车项重复（相同用户、作品、商品、颜色、尺寸），合并数量

[Source: docs/fullstack-architecture.md#API Specification]

### File Locations

**后端文件位置：**
```
backend/src/main/java/com/myshop/
├── controller/
│   └── CartController.java           # 购物车控制器（扩展）
├── service/
│   └── CartService.java              # 购物车服务（扩展）
└── dto/
    └── UpdateCartItemRequest.java     # 更新购物车项请求DTO
```

[Source: docs/fullstack-architecture.md#Repository Structure]

### Technical Constraints

- **用户身份**: 从UserContext获取当前用户ID
- **权限验证**: 只能更新自己的购物车项
- **参数验证**: 使用Bean Validation注解
- **合并逻辑**: 更新后如果与现有项重复，需要合并数量

[Source: docs/fullstack-architecture.md#Tech Stack]

### Testing Requirements

- 使用JUnit 5和MockMvc进行Controller测试
- 测试文件位置：`backend/src/test/java/com/myshop/controller/CartControllerTest.java`
- 测试更新购物车项
- 测试权限验证
- 测试参数验证

[Source: docs/fullstack-architecture.md#Tech Stack]

## Testing

### Test File Location

测试文件应创建在：`backend/src/test/java/com/myshop/controller/CartControllerTest.java`

### Test Standards

- 使用JUnit 5和Spring Boot Test
- 使用MockMvc测试REST接口
- 使用Mockito Mock依赖

### Test Scenarios

1. **正常更新购物车项测试**
   - 更新购物车项的数量
   - 验证更新成功
   - 验证返回信息正确

2. **权限验证测试**
   - 尝试更新其他用户的购物车项
   - 验证返回403或404错误

3. **参数验证测试**
   - 测试quantity小于等于0
   - 验证返回验证错误信息

4. **数量为0删除测试**
   - 更新quantity为0
   - 验证购物车项被删除

### Success Criteria

- 更新购物车项接口能够正常工作
- 权限验证正确
- 参数验证正确
- 数量为0时正确删除

## Change Log

| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2024-12-15 | 1.0 | 初始故事创建 | Scrum Master |

## Dev Agent Record

### Agent Model Used

_To be filled by Dev Agent_

### Debug Log References

_To be filled by Dev Agent_

### Completion Notes List

_To be filled by Dev Agent_

### File List

_To be filled by Dev Agent_

## QA Results

_To be filled by QA Agent_

