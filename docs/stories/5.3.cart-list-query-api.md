# Story 5.3: 购物车列表查询API

## Status

Draft

## Story

**As a** user,
**I want** to view my shopping cart,
**so that** I can review items before checkout.

## Acceptance Criteria

1. 后端提供 `/api/cart/items` GET接口
2. 返回当前用户的所有购物车项
3. 包含作品信息、商品信息、规格、数量等
4. 计算总价
5. 接口响应时间小于100ms

## Tasks / Subtasks

- [ ] Task 1: 创建响应DTO (AC: 3, 4)
  - [ ] 创建CartItemDTO，包含作品信息、商品信息
  - [ ] 添加总价计算字段
  - [ ] 包含商品名称、价格等信息
- [ ] Task 2: 扩展CartController (AC: 1, 2)
  - [ ] 实现GET /api/cart/items接口
  - [ ] 从UserContext获取当前用户ID
  - [ ] 调用Service层查询购物车项
  - [ ] 关联查询作品和商品信息
  - [ ] 返回购物车列表
- [ ] Task 3: 扩展CartService (AC: 2, 3, 4)
  - [ ] 实现getCartItems方法
  - [ ] 查询当前用户的所有购物车项
  - [ ] 关联查询Work和Product信息
  - [ ] 计算每个购物车项的小计和总价
  - [ ] 返回完整的购物车项信息
- [ ] Task 4: 性能优化 (AC: 5)
  - [ ] 使用JOIN查询减少数据库访问次数
  - [ ] 添加适当的索引
  - [ ] 验证响应时间
- [ ] Task 5: 创建单元测试 (AC: 1, 2, 3, 4)
  - [ ] 创建CartControllerTest测试
  - [ ] 测试查询购物车列表
  - [ ] 验证返回数据完整性
  - [ ] 验证总价计算正确

## Dev Notes

### Previous Story Insights

依赖Story 5.1（购物车实体和数据库设计）和Story 1.6（JWT认证中间件）完成，确保CartItem实体类和UserContext已创建。

### Data Models

使用Story 5.1创建的CartItem实体类。

**响应DTO：**
- CartItemDTO: { id, userId, workId, workTitle, workImageUrl, productId, productName, productPrice, color, size, quantity, previewImageUrl, subtotal, createTime, updateTime }
- CartListResponse: { items: CartItemDTO[], totalAmount: number }

[Source: docs/fullstack-architecture.md#CartItem（购物车项）]

### API Specifications

**GET /api/cart/items**
- 描述：查询购物车列表
- 认证：需要JWT Token
- 响应：`{ items: CartItemDTO[], totalAmount: number }`

**业务逻辑：**
- 查询当前用户的所有购物车项
- 关联查询作品和商品信息
- 计算每个购物车项的小计（商品价格 × 数量）
- 计算总价（所有购物车项小计之和）

[Source: docs/fullstack-architecture.md#API Specification]

### File Locations

**后端文件位置：**
```
backend/src/main/java/com/myshop/
├── controller/
│   └── CartController.java           # 购物车控制器（扩展）
├── service/
│   └── CartService.java              # 购物车服务（扩展）
└── dto/
    └── CartItemDTO.java              # 购物车项DTO
```

[Source: docs/fullstack-architecture.md#Repository Structure]

### Technical Constraints

- **用户身份**: 从UserContext获取当前用户ID
- **关联查询**: 使用JPA关联查询Work和Product
- **性能要求**: 响应时间小于100ms，需要使用JOIN查询优化

[Source: docs/fullstack-architecture.md#Tech Stack]

### Testing Requirements

- 使用JUnit 5和MockMvc进行Controller测试
- 测试文件位置：`backend/src/test/java/com/myshop/controller/CartControllerTest.java`
- 测试查询购物车列表
- 验证返回数据完整性
- 验证总价计算正确

[Source: docs/fullstack-architecture.md#Tech Stack]

## Testing

### Test File Location

测试文件应创建在：`backend/src/test/java/com/myshop/controller/CartControllerTest.java`

### Test Standards

- 使用JUnit 5和Spring Boot Test
- 使用MockMvc测试REST接口
- 使用Mockito Mock依赖

### Test Scenarios

1. **查询购物车列表测试**
   - 创建多个购物车项
   - 查询购物车列表
   - 验证返回所有购物车项
   - 验证包含作品和商品信息

2. **总价计算测试**
   - 创建多个不同价格的购物车项
   - 查询购物车列表
   - 验证每个购物车项的小计正确
   - 验证总价计算正确

3. **空购物车测试**
   - 查询空购物车
   - 验证返回空数组
   - 验证总价为0

### Success Criteria

- 购物车列表查询接口能够正常返回数据
- 返回数据包含完整的作品和商品信息
- 总价计算正确
- 接口响应时间小于100ms

## Change Log

| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2024-12-15 | 1.0 | 初始故事创建 | Scrum Master |

## Dev Agent Record

### Agent Model Used

_To be filled by Dev Agent_

### Debug Log References

_To be filled by Dev Agent_

### Completion Notes List

_To be filled by Dev Agent_

### File List

_To be filled by Dev Agent_

## QA Results

_To be filled by QA Agent_

