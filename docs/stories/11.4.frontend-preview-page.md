# Story 11.4: 前端预览页面实现

## Status

Ready

## Story

**As a** user,
**I want** to view the preview image on the frontend,
**so that** I can decide whether to purchase the customized bag.

## Acceptance Criteria

1. 预览页面支持选择包包款式、颜色、尺寸
2. 点击"生成预览"按钮调用后端预览生成接口
3. 显示预览生成进度（加载动画和提示文字）
4. 预览生成成功后显示预览图片
5. 支持重新生成预览
6. 预览图片用于加入购物车
7. 预览生成失败时显示错误提示并支持重试

## Tasks / Subtasks

- [x] Task 1: 更新预览页面UI (AC: 1)
  - [x] 添加商品选择区域（款式、颜色、尺寸）
  - [x] 添加"生成预览"按钮
  - [x] 设计预览图片展示区域
  - [x] 优化页面布局

- [x] Task 2: 实现预览生成调用 (AC: 2)
  - [x] 创建预览API接口封装
  - [x] 实现generatePreview方法
  - [x] 参数验证
  - [x] 调用后端 /api/preview/generate 接口

- [x] Task 3: 实现进度显示 (AC: 3)
  - [x] 显示加载动画
  - [x] 显示提示文字："正在生成预览，请稍候..."
  - [x] 轮询查询任务状态
  - [x] 更新进度提示

- [x] Task 4: 显示预览结果 (AC: 4)
  - [x] 任务完成后显示预览图片
  - [x] 支持图片缩放查看
  - [x] 优化图片显示效果

- [x] Task 5: 实现重新生成功能 (AC: 5)
  - [x] 添加"重新生成"按钮
  - [x] 清除当前预览
  - [x] 重新调用生成接口

- [x] Task 6: 集成购物车流程 (AC: 6)
  - [x] 生成预览后启用"加入购物车"按钮
  - [x] 将预览图片URL传递给购物车API
  - [x] 购物车中显示预览图片

- [x] Task 7: 实现错误处理 (AC: 7)
  - [x] 显示错误提示信息
  - [x] 添加"重试"按钮
  - [x] 处理网络错误
  - [x] 处理超时错误

## Dev Notes

### UI设计

**预览页面布局：**
```vue
<view class="preview-container">
  <!-- 预览图片展示区域 -->
  <view class="preview-section">
    <!-- 未生成时显示占位 -->
    <view v-if="!previewUrl && !isGenerating" class="preview-placeholder">
      <image src="/static/bag-placeholder.png" class="placeholder-image" />
      <text class="placeholder-hint">选择商品后生成预览</text>
    </view>
    
    <!-- 生成中显示加载 -->
    <view v-if="isGenerating" class="preview-loading">
      <uni-load-more status="loading" :content-text="loadingText" />
    </view>
    
    <!-- 预览图片 -->
    <image 
      v-if="previewUrl && !isGenerating" 
      :src="previewUrl" 
      class="preview-image"
      mode="aspectFit"
    />
    
    <!-- 重新生成按钮 -->
    <button 
      v-if="previewUrl && !isGenerating"
      class="regenerate-btn"
      @click="handleRegenerate"
    >重新生成</button>
  </view>
  
  <!-- 商品选择区域 -->
  <view class="product-section">
    <view class="product-selector">
      <text class="selector-label">选择包包款式</text>
      <picker :range="products" range-key="name" @change="onProductChange">
        <view class="picker-view">{{ selectedProduct?.name || '请选择' }}</view>
      </picker>
    </view>
    
    <view class="spec-selector" v-if="selectedProduct">
      <view class="spec-item">
        <text class="spec-label">颜色</text>
        <view class="spec-options">
          <view 
            class="spec-option" 
            v-for="color in selectedProduct.colors" 
            :key="color"
            :class="{ active: selectedColor === color }"
            @click="selectedColor = color"
          >{{ color }}</view>
        </view>
      </view>
      
      <view class="spec-item">
        <text class="spec-label">尺寸</text>
        <view class="spec-options">
          <view 
            class="spec-option" 
            v-for="size in selectedProduct.sizes" 
            :key="size"
            :class="{ active: selectedSize === size }"
            @click="selectedSize = size"
          >{{ size }}</view>
        </view>
      </view>
    </view>
    
    <!-- 生成预览按钮 -->
    <button 
      class="generate-btn"
      :disabled="!canGenerate || isGenerating"
      @click="handleGeneratePreview"
    >{{ isGenerating ? '生成中...' : '生成预览' }}</button>
  </view>
  
  <!-- 操作区域 -->
  <view class="action-section">
    <button 
      class="add-cart-btn" 
      :disabled="!canAddToCart"
      @click="handleAddToCart"
    >加入购物车</button>
  </view>
</view>
```

### Data Models

**页面数据：**
```typescript
interface PreviewPageData {
  workId: number;
  imageUrl: string;
  products: Product[];
  selectedProduct: Product | null;
  selectedColor: string;
  selectedSize: string;
  previewUrl: string;         // 预览图片URL
  isGenerating: boolean;      // 是否正在生成
  taskId: number | null;      // 任务ID
  errorMessage: string;       // 错误信息
}
```

### API封装

**preview.js:**
```javascript
// 生成预览
export const generatePreview = (data) => {
  return request({
    url: '/preview/generate',
    method: 'POST',
    data
  })
}

// 查询任务状态
export const getTaskStatus = (taskId) => {
  return request({
    url: `/preview/tasks/${taskId}`,
    method: 'GET'
  })
}
```

### File Locations

**前端文件位置：**
```
frontend/
├── pages/
│   └── preview/
│       └── preview.vue                          # 预览页面（更新）
└── api/
    └── preview.js                               # 预览API封装（新建）
```

### Technical Constraints

- **轮询间隔**: 每2秒查询一次任务状态
- **超时设置**: 30秒超时
- **加载状态**: 显示友好的加载提示
- **错误处理**: 网络错误、超时错误、生成失败等
- **缓存策略**: 预览图片缓存，避免重复生成

### 实现示例

**preview.vue关键代码：**
```vue
<script setup>
import { ref, computed } from 'vue'
import { onLoad } from '@dcloudio/uni-app'
import { generatePreview, getTaskStatus } from '@/api/preview'
import { cartApi } from '@/api/cart'

const workId = ref(null)
const imageUrl = ref('')
const products = ref([])
const selectedProduct = ref(null)
const selectedColor = ref('')
const selectedSize = ref('')

// 预览相关
const previewUrl = ref('')
const isGenerating = ref(false)
const taskId = ref(null)
const errorMessage = ref('')

// 计算属性
const canGenerate = computed(() => {
  return selectedProduct.value && selectedColor.value && selectedSize.value
})

const canAddToCart = computed(() => {
  return canGenerate.value && previewUrl.value && !isGenerating.value
})

// 生成预览
const handleGeneratePreview = async () => {
  if (!canGenerate.value || isGenerating.value) return
  
  try {
    isGenerating.value = true
    errorMessage.value = ''
    
    // 调用预览生成接口
    const res = await generatePreview({
      workId: workId.value,
      productId: selectedProduct.value.id,
      color: selectedColor.value,
      size: selectedSize.value
    })
    
    if (res.code === 200) {
      taskId.value = res.data.taskId
      // 开始轮询任务状态
      pollTaskStatus()
    } else {
      throw new Error(res.message)
    }
    
  } catch (error) {
    console.error('生成预览失败', error)
    errorMessage.value = error.message || '生成预览失败'
    isGenerating.value = false
    
    uni.showToast({
      title: errorMessage.value,
      icon: 'none',
      duration: 2000
    })
  }
}

// 轮询任务状态
const pollTaskStatus = async () => {
  if (!taskId.value) return
  
  try {
    const res = await getTaskStatus(taskId.value)
    
    if (res.code === 200) {
      const task = res.data
      
      if (task.status === 'COMPLETED') {
        // 生成完成
        previewUrl.value = task.resultUrl
        isGenerating.value = false
        
        uni.showToast({
          title: '预览生成成功',
          icon: 'success',
          duration: 2000
        })
        
      } else if (task.status === 'FAILED') {
        // 生成失败
        errorMessage.value = task.errorMessage || '生成失败'
        isGenerating.value = false
        
        uni.showModal({
          title: '提示',
          content: errorMessage.value + '，是否重试？',
          success: (modalRes) => {
            if (modalRes.confirm) {
              handleGeneratePreview()
            }
          }
        })
        
      } else {
        // 继续轮询
        setTimeout(pollTaskStatus, 2000)
      }
    }
    
  } catch (error) {
    console.error('查询任务状态失败', error)
    isGenerating.value = false
  }
}

// 重新生成
const handleRegenerate = () => {
  previewUrl.value = ''
  taskId.value = null
  handleGeneratePreview()
}

// 加入购物车
const handleAddToCart = async () => {
  if (!canAddToCart.value) return
  
  try {
    const res = await cartApi.addToCart({
      workId: workId.value,
      productId: selectedProduct.value.id,
      color: selectedColor.value,
      size: selectedSize.value,
      quantity: 1,
      previewImageUrl: previewUrl.value  // 使用预览图片
    })
    
    if (res.code === 200) {
      uni.showToast({
        title: '已加入购物车',
        icon: 'success'
      })
      
      setTimeout(() => {
        uni.switchTab({
          url: '/pages/cart/cart'
        })
      }, 1500)
    }
    
  } catch (error) {
    console.error('加入购物车失败', error)
    uni.showToast({
      title: '加入购物车失败',
      icon: 'none'
    })
  }
}

onLoad(async (options) => {
  workId.value = options.workId || null
  imageUrl.value = decodeURIComponent(options.imageUrl || '')
  
  if (!workId.value) {
    uni.showToast({
      title: '缺少作品ID',
      icon: 'none'
    })
    return
  }
  
  // 加载商品列表
  await loadProducts()
})
</script>
```

### Testing Requirements

前端测试：
- 手动验证UI交互
- 验证预览生成流程
- 验证错误处理
- 验证购物车集成

## Testing

### Test Scenarios

1. **预览生成流程测试**
   - 选择商品、颜色、尺寸
   - 点击"生成预览"按钮
   - 验证显示加载动画
   - 验证轮询任务状态
   - 验证预览图片正确显示

2. **重新生成测试**
   - 生成预览后点击"重新生成"
   - 验证清除旧预览
   - 验证重新生成流程

3. **错误处理测试**
   - 模拟网络错误
   - 验证错误提示
   - 验证支持重试

4. **购物车集成测试**
   - 生成预览后加入购物车
   - 验证预览URL正确传递
   - 验证购物车中显示预览图片

5. **边界情况测试**
   - 未选择商品时生成预览
   - 生成中切换商品
   - 生成超时处理

### Success Criteria

- 预览页面UI美观友好
- 预览生成流程顺畅
- 加载状态提示清晰
- 预览图片正确显示
- 错误处理完善
- 购物车集成正常
- 用户体验良好

## Change Log

| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2024-12-17 | 2.0 | 重构：改为后端API调用方式 | PM |
| 2024-12-16 | 1.0 | 初始故事创建（Canvas方案） | PM |

## Dev Agent Record

### Agent Model Used

Claude Sonnet 4.5

### Debug Log References

- 实现了完整的预览生成流程
- 轮询间隔设置为 2 秒
- 支持缓存检查（已完成任务直接返回结果）
- 添加了友好的加载动画和进度提示
- 实现了错误处理和重试机制
- 页面卸载时自动清除轮询定时器

### Completion Notes List

1. ✅ 创建 preview API 封装（generatePreview, getTaskStatus）
2. ✅ 完全重写 preview.vue 页面，实现所有功能：
   - 商品选择（款式、颜色、尺寸）
   - "生成预览"按钮（带禁用状态）
   - 加载动画（旋转spinner + 提示文字）
   - 轮询任务状态（每2秒查询一次）
   - 进度显示（0%, 50%, 100%）
   - 预览结果展示
   - "重新生成"按钮（悬浮在预览图上）
   - 错误处理（显示错误信息 + 重试按钮）
   - 加入购物车功能（传递预览图片URL）
3. ✅ UI 优化：
   - 美观的占位符
   - 流畅的加载动画
   - 清晰的错误提示
   - 固定底部的"加入购物车"按钮
4. ✅ 用户体验优化：
   - 生成成功后显示 Toast 提示
   - 生成失败后弹窗询问是否重试
   - 加入购物车后自动跳转
   - 支持缓存（相同参数直接返回结果）

### File List

**新建文件：**
- `frontend/api/preview.js`

**修改文件：**
- `frontend/pages/preview/preview.vue` - 完全重写，实现完整预览生成流程

## QA Results

_To be filled by QA Agent_

