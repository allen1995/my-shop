# Story 5.9: 创建支付订单API

## Status

Draft

## Story

**As a** user,
**I want** to create a payment order,
**so that** I can pay for my purchase.

## Acceptance Criteria

1. 后端提供 `/api/orders/{orderId}/payment` POST接口
2. 调用微信支付统一下单API
3. 返回支付参数给前端
4. 包含appId、timeStamp、nonceStr、package、signType、paySign等参数
5. 接口包含错误处理

## Tasks / Subtasks

- [ ] Task 1: 创建响应DTO (AC: 3, 4)
  - [ ] 创建PaymentOrderResponse DTO
  - [ ] 包含appId、timeStamp、nonceStr、package、signType、paySign等字段
- [ ] Task 2: 扩展OrderController (AC: 1, 2, 3, 5)
  - [ ] 实现POST /api/orders/{orderId}/payment接口
  - [ ] 从UserContext获取当前用户ID
  - [ ] 验证订单存在且属于当前用户
  - [ ] 验证订单状态为PENDING_PAYMENT
  - [ ] 调用WeChatPayService统一下单
  - [ ] 返回支付参数给前端
  - [ ] 添加错误处理
- [ ] Task 3: 扩展WeChatPayService (AC: 2, 4)
  - [ ] 实现createPaymentOrder方法
  - [ ] 构建统一下单请求参数
  - [ ] 调用微信支付统一下单API
  - [ ] 生成支付参数签名
  - [ ] 返回支付参数
- [ ] Task 4: 实现参数验证 (AC: 5)
  - [ ] 验证订单存在
  - [ ] 验证订单属于当前用户
  - [ ] 验证订单状态为PENDING_PAYMENT
  - [ ] 返回友好的错误信息
- [ ] Task 5: 创建单元测试 (AC: 1, 2, 3, 4, 5)
  - [ ] 创建OrderControllerTest测试
  - [ ] 测试创建支付订单
  - [ ] 测试权限验证
  - [ ] 测试订单状态验证
  - [ ] 测试错误处理

## Dev Notes

### Previous Story Insights

依赖Story 5.6（订单实体）、Story 5.7（创建订单API）和Story 5.8（微信支付集成）完成，确保Order实体类、订单创建功能和微信支付服务已实现。

### Data Models

使用Story 5.6创建的Order实体类。

**响应DTO：**
- PaymentOrderResponse: { appId, timeStamp, nonceStr, package, signType, paySign }

[Source: docs/fullstack-architecture.md#Order（订单）]

### API Specifications

**POST /api/orders/{orderId}/payment**
- 描述：创建支付订单
- 认证：需要JWT Token
- 路径参数：orderId - 订单ID
- 响应：`{ paymentParams: PaymentOrderResponse }`

**业务逻辑：**
- 验证订单存在且属于当前用户
- 验证订单状态为PENDING_PAYMENT
- 调用微信支付统一下单API
- 生成支付参数签名
- 返回支付参数给前端

[Source: docs/fullstack-architecture.md#API Specification]

### File Locations

**后端文件位置：**
```
backend/src/main/java/com/myshop/
├── controller/
│   └── OrderController.java          # 订单控制器（扩展）
├── service/
│   └── WeChatPayService.java        # 微信支付服务（扩展）
└── dto/
    └── PaymentOrderResponse.java     # 支付订单响应DTO
```

[Source: docs/fullstack-architecture.md#Repository Structure]

### Technical Constraints

- **用户身份**: 从UserContext获取当前用户ID
- **权限验证**: 只能为自己的订单创建支付订单
- **状态验证**: 只能为待支付状态的订单创建支付订单
- **签名生成**: 必须正确生成支付参数签名

[Source: docs/fullstack-architecture.md#Tech Stack]

### Testing Requirements

- 使用JUnit 5和MockMvc进行Controller测试
- 测试文件位置：`backend/src/test/java/com/myshop/controller/OrderControllerTest.java`
- 测试创建支付订单
- 测试权限验证
- 测试订单状态验证
- 测试支付参数生成

[Source: docs/fullstack-architecture.md#Tech Stack]

## Testing

### Test File Location

测试文件应创建在：`backend/src/test/java/com/myshop/controller/OrderControllerTest.java`

### Test Standards

- 使用JUnit 5和Spring Boot Test
- 使用MockMvc测试REST接口
- 使用Mockito Mock微信支付服务

### Test Scenarios

1. **正常创建支付订单测试**
   - 创建待支付状态的订单
   - 调用创建支付订单接口
   - 验证支付参数生成正确
   - 验证签名生成正确

2. **权限验证测试**
   - 尝试为其他用户的订单创建支付订单
   - 验证返回403或404错误

3. **订单状态验证测试**
   - 尝试为已支付状态的订单创建支付订单
   - 验证返回错误信息

4. **支付参数验证测试**
   - 验证返回的支付参数包含所有必需字段
   - 验证签名格式正确

### Success Criteria

- 创建支付订单接口能够正常工作
- 支付参数生成正确
- 签名生成正确
- 权限验证正确
- 订单状态验证正确

## Change Log

| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2024-12-15 | 1.0 | 初始故事创建 | Scrum Master |

## Dev Agent Record

### Agent Model Used

_To be filled by Dev Agent_

### Debug Log References

_To be filled by Dev Agent_

### Completion Notes List

_To be filled by Dev Agent_

### File List

_To be filled by Dev Agent_

## QA Results

_To be filled by QA Agent_

