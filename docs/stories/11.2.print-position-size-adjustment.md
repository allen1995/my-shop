# Story 11.2: 印花位置和大小调整交互

## Status

Draft

## Story

**As a** user,
**I want** to adjust the position and size of my work on the bag,
**so that** I can customize the placement to my preference.

## Acceptance Criteria

1. 支持单指拖拽调整位置
2. 支持双指缩放调整大小（缩放范围：0.5x - 2.0x）
3. 支持旋转调整（可选，手势识别）
4. 位置和大小调整实时反馈
5. 提供重置按钮，恢复默认位置和大小
6. 显示位置和大小数值（可选，调试模式）

## Tasks / Subtasks

- [ ] Task 1: 实现单指拖拽 (AC: 1, 4)
  - [ ] 监听canvas的touchstart事件
  - [ ] 判断是否为单指触摸（touches.length === 1）
  - [ ] 记录触摸起始位置
  - [ ] 监听touchmove事件，计算移动距离
  - [ ] 更新作品图片位置
  - [ ] 限制拖拽范围（不超出包包区域或canvas边界）
  - [ ] 实时更新Canvas绘制

- [ ] Task 2: 实现双指缩放 (AC: 2, 4)
  - [ ] 监听touchstart，识别双指触摸（touches.length === 2）
  - [ ] 计算双指初始距离
  - [ ] 计算双指中心点（作为缩放中心）
  - [ ] 监听touchmove，计算当前距离
  - [ ] 根据距离变化计算缩放比例
  - [ ] 更新作品图片缩放比例
  - [ ] 限制缩放范围（0.5x - 2.0x）
  - [ ] 实时更新Canvas绘制

- [ ] Task 3: 实现旋转调整（可选）(AC: 3)
  - [ ] 监听双指触摸
  - [ ] 计算双指连线的角度
  - [ ] 根据角度变化计算旋转角度
  - [ ] 更新作品图片旋转角度
  - [ ] 限制旋转范围（0-360度）
  - [ ] 实时更新Canvas绘制

- [ ] Task 4: 实现重置功能 (AC: 5)
  - [ ] 添加重置按钮到UI
  - [ ] 实现重置方法，恢复默认位置和大小
  - [ ] 默认位置：包包中心或印花区域中心
  - [ ] 默认大小：根据作品图片和包包尺寸计算
  - [ ] 重置后更新Canvas绘制

- [ ] Task 5: 实现调试信息显示（可选）(AC: 6)
  - [ ] 添加调试模式开关
  - [ ] 显示当前位置（x, y）
  - [ ] 显示当前缩放比例
  - [ ] 显示当前旋转角度（如果支持）
  - [ ] 仅在开发环境显示

- [ ] Task 6: 优化交互体验
  - [ ] 添加触摸反馈（视觉提示）
  - [ ] 优化拖拽和缩放的流畅度
  - [ ] 添加边界限制的视觉提示
  - [ ] 处理触摸冲突（拖拽vs缩放）

## Dev Notes

### Previous Story Insights

依赖Story 11.1（Canvas 2D实时预览实现）完成，确保Canvas已集成并能正常绘制。

### Data Models

**作品位置和大小状态：**
```typescript
interface WorkTransform {
  position: {
    x: number;                 // X坐标
    y: number;                 // Y坐标
  };
  scale: number;              // 缩放比例（0.5 - 2.0）
  rotation: number;            // 旋转角度（0-360，可选）
}

interface DefaultTransform {
  position: { x: number, y: number };
  scale: number;
  rotation: number;
}
```

**触摸事件数据：**
```typescript
interface TouchData {
  startX: number;
  startY: number;
  currentX: number;
  currentY: number;
  distance: number;           // 双指距离
  angle: number;              // 双指连线角度
}
```

### API Specifications

本故事不涉及后端API，仅在前端实现交互功能。

### File Locations

**前端文件位置：**
```
frontend/
├── pages/
│   └── preview/
│       └── preview.vue               # 印花预览页面（更新）
└── utils/
    └── touch-helper.js               # 触摸事件工具函数（新建）
```

### Technical Constraints

- **触摸事件**: 使用@touchstart、@touchmove、@touchend
- **手势识别**: 通过touches.length判断单指/双指
- **坐标计算**: 使用canvas坐标系统
- **性能**: 使用防抖/节流优化触摸事件处理
- **兼容性**: 确保在微信小程序环境中正常工作

### 触摸事件处理流程

1. **touchstart事件**
   ```javascript
   handleTouchStart(e) {
     const touches = e.touches
     if (touches.length === 1) {
       // 单指：准备拖拽
       this.dragStart = { x: touches[0].x, y: touches[0].y }
     } else if (touches.length === 2) {
       // 双指：准备缩放/旋转
       this.pinchStart = this.calculateDistance(touches[0], touches[1])
       this.pinchCenter = this.calculateCenter(touches[0], touches[1])
     }
   }
   ```

2. **touchmove事件**
   ```javascript
   handleTouchMove(e) {
     const touches = e.touches
     if (touches.length === 1 && this.dragStart) {
       // 单指拖拽
       const deltaX = touches[0].x - this.dragStart.x
       const deltaY = touches[0].y - this.dragStart.y
       this.updatePosition(deltaX, deltaY)
     } else if (touches.length === 2 && this.pinchStart) {
       // 双指缩放
       const currentDistance = this.calculateDistance(touches[0], touches[1])
       const scale = currentDistance / this.pinchStart
       this.updateScale(scale)
     }
   }
   ```

3. **touchend事件**
   ```javascript
   handleTouchEnd(e) {
     // 清理触摸状态
     this.dragStart = null
     this.pinchStart = null
   }
   ```

### 边界限制实现

```javascript
// 限制位置在canvas范围内
const constrainPosition = (x, y, canvasWidth, canvasHeight, workWidth, workHeight) => {
  const minX = workWidth / 2
  const maxX = canvasWidth - workWidth / 2
  const minY = workHeight / 2
  const maxY = canvasHeight - workHeight / 2
  
  return {
    x: Math.max(minX, Math.min(maxX, x)),
    y: Math.max(minY, Math.min(maxY, y))
  }
}

// 限制缩放范围
const constrainScale = (scale, minScale = 0.5, maxScale = 2.0) => {
  return Math.max(minScale, Math.min(maxScale, scale))
}
```

### Testing Requirements

前端测试暂不实施，主要进行手动验证：
- 验证拖拽功能
- 验证缩放功能
- 验证旋转功能（如果实现）
- 验证重置功能

## Testing

### Test File Location

前端测试暂不实施，后续添加。

### Test Standards

当前阶段主要进行手动验证：
- 在微信开发者工具中测试触摸交互
- 在真机上测试触摸交互
- 验证各种手势识别

### Test Scenarios

1. **单指拖拽测试**
   - 单指触摸并拖拽
   - 验证位置实时更新
   - 验证边界限制
   - 验证拖拽流畅度

2. **双指缩放测试**
   - 双指触摸并缩放
   - 验证缩放比例正确
   - 验证缩放范围限制（0.5x - 2.0x）
   - 验证缩放中心点正确

3. **旋转测试**（如果实现）
   - 双指旋转
   - 验证旋转角度正确
   - 验证旋转范围限制

4. **重置功能测试**
   - 调整位置和大小后点击重置
   - 验证恢复到默认值
   - 验证Canvas正确更新

5. **边界情况测试**
   - 拖拽到边界
   - 缩放达到最大/最小值
   - 快速连续操作

### Success Criteria

- 单指拖拽功能正常
- 双指缩放功能正常
- 旋转功能正常（如果实现）
- 重置功能正常
- 交互流畅，无明显延迟
- 边界限制正确

## Change Log

| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2024-12-16 | 1.0 | 初始故事创建 | PM |

## Dev Agent Record

### Agent Model Used

_To be filled by Dev Agent_

### Debug Log References

_To be filled by Dev Agent_

### Completion Notes List

_To be filled by Dev Agent_

### File List

_To be filled by Dev Agent_

## QA Results

_To be filled by QA Agent_

