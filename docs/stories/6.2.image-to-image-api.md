# Story 6.2: 图生图API接口实现

## Status

Draft

## Story

**As a** user,
**I want** to generate an image based on an uploaded image,
**so that** I can create variations or style transfers.

## Acceptance Criteria

1. 后端提供 `/api/image-generation/image-to-image` 接口
2. 接口接收imageUrl、prompt、similarity参数
3. 创建生成任务记录
4. 异步调用阿里百炼图生图API
5. 生成完成后将图片上传到OSS
6. 更新任务状态和结果URL
7. 返回任务ID给前端
8. 接口包含参数验证和错误处理

## Tasks / Subtasks

- [ ] Task 1: 创建请求DTO (AC: 2, 8)
  - [ ] 创建ImageToImageRequest DTO
  - [ ] 包含imageUrl、prompt、similarity字段
  - [ ] 添加参数验证注解
- [ ] Task 2: 扩展ImageGenerationController (AC: 1, 2, 7, 8)
  - [ ] 实现POST /api/image-generation/image-to-image接口
  - [ ] 接收并验证请求参数
  - [ ] 从UserContext获取当前用户ID
  - [ ] 调用Service层处理
  - [ ] 返回任务ID
  - [ ] 添加错误处理
- [ ] Task 3: 扩展AIGenerationService (AC: 3, 4, 5, 6)
  - [ ] 实现generateImageToImage方法
  - [ ] 创建ImageGenerationTask记录（类型为IMAGE_TO_IMAGE）
  - [ ] 异步调用阿里百炼图生图API（qwen-image-edit模型）
  - [ ] 使用MultiModalConversation API
  - [ ] 构建包含图片和文本的多模态消息
  - [ ] 根据similarity参数调整negative_prompt
  - [ ] 等待生成完成
  - [ ] 下载生成的图片
  - [ ] 上传生成的图片到OSS
  - [ ] 更新任务状态和结果URL
  - [ ] 返回任务ID
- [ ] Task 4: 实现参数验证 (AC: 8)
  - [ ] 验证imageUrl不为空且格式正确
  - [ ] 验证prompt不为空
  - [ ] 验证similarity在0-100范围内
  - [ ] 返回友好的验证错误信息
- [ ] Task 5: 实现异步处理 (AC: 4, 6)
  - [ ] 使用异步方法或线程池处理生成任务
  - [ ] 更新任务状态（PENDING -> PROCESSING -> COMPLETED/FAILED）
  - [ ] 记录错误信息
- [ ] Task 6: 创建单元测试 (AC: 1, 2, 3, 4, 7, 8)
  - [ ] 创建ImageGenerationControllerTest测试
  - [ ] 测试图生图接口
  - [ ] 测试参数验证
  - [ ] 测试异步处理

## Dev Notes

### Previous Story Insights

依赖Story 6.1（图片上传到OSS）、Story 2.2（图像生成任务实体）、Story 2.1（DashScope API集成）完成，确保OSS服务、ImageGenerationTask实体类和阿里百炼API集成已实现。

### Data Models

使用Story 2.2创建的ImageGenerationTask实体类。

**请求DTO：**
- ImageToImageRequest: { imageUrl: string, prompt: string, similarity: number }

**响应DTO：**
- ImageGenerationResponse: { taskId: number }

[Source: docs/fullstack-architecture.md#ImageGenerationTask（图像生成任务）]

### API Specifications

**POST /api/image-generation/image-to-image**
- 描述：图生图生成接口
- 认证：需要JWT Token
- 请求体：`{ imageUrl: string, prompt: string, similarity: number }`
- 响应：`{ taskId: number }`

**业务逻辑：**
- 创建ImageGenerationTask记录（类型为IMAGE_TO_IMAGE，状态为PENDING）
- 异步调用阿里百炼图生图API（qwen-image-edit模型）
- 使用MultiModalConversation API，构建包含参考图片和提示词的多模态消息
- 根据similarity参数调整negative_prompt：
  - similarity < 30: 允许更多变化
  - similarity > 70: 保持更多原图特征
- 等待生成完成
- 下载生成的图片
- 上传生成的图片到OSS
- 更新任务状态为COMPLETED，保存结果URL
- 如果失败，更新任务状态为FAILED，保存错误信息

[Source: docs/fullstack-architecture.md#API Specification]

### File Locations

**后端文件位置：**
```
backend/src/main/java/com/myshop/
├── controller/
│   └── ImageGenerationController.java # 图像生成控制器（扩展）
├── service/
│   ├── AIGenerationService.java      # AI生成服务（扩展）
│   └── OssService.java               # OSS服务（已存在）
└── dto/
    └── ImageToImageRequest.java       # 图生图请求DTO
```

[Source: docs/fullstack-architecture.md#Repository Structure]

### Technical Constraints

- **AI模型**: 使用qwen-image-edit模型（通过MultiModalConversation API）
- **异步处理**: 使用@Async或线程池处理生成任务
- **相似度控制**: 通过negative_prompt参数控制生成图片与原图的相似度
- **图片处理**: 下载生成的图片并上传到OSS
- **参数验证**: 使用Bean Validation注解

[Source: docs/fullstack-architecture.md#Tech Stack]

### Testing Requirements

- 使用JUnit 5和MockMvc进行Controller测试
- 测试文件位置：`backend/src/test/java/com/myshop/controller/ImageGenerationControllerTest.java`
- 测试图生图接口
- 测试参数验证
- 测试异步处理
- 注意：需要Mock阿里百炼API调用

[Source: docs/fullstack-architecture.md#Tech Stack]

## Testing

### Test File Location

测试文件应创建在：`backend/src/test/java/com/myshop/controller/ImageGenerationControllerTest.java`

### Test Standards

- 使用JUnit 5和Spring Boot Test
- 使用MockMvc测试REST接口
- 使用Mockito Mock阿里百炼API调用

### Test Scenarios

1. **正常图生图测试**
   - 发送有效的图生图请求
   - 验证任务创建成功
   - 验证返回任务ID
   - 验证异步处理正确

2. **参数验证测试**
   - 测试imageUrl为空
   - 测试prompt为空
   - 测试similarity超出范围
   - 验证返回验证错误信息

3. **相似度控制测试**
   - 测试低相似度（similarity < 30）
   - 测试高相似度（similarity > 70）
   - 验证negative_prompt正确设置

4. **错误处理测试**
   - 模拟API调用失败
   - 验证任务状态更新为FAILED
   - 验证错误信息保存

### Success Criteria

- 图生图接口能够正常工作
- 任务创建和状态更新正确
- 异步处理正确
- 参数验证正确
- 错误处理完善

## Change Log

| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2024-12-15 | 1.0 | 初始故事创建 | Scrum Master |

## Dev Agent Record

### Agent Model Used

_To be filled by Dev Agent_

### Debug Log References

_To be filled by Dev Agent_

### Completion Notes List

_To be filled by Dev Agent_

### File List

_To be filled by Dev Agent_

## QA Results

_To be filled by QA Agent_

