# Story 5.1: 购物车实体和数据库设计

## Status

Draft

## Story

**As a** developer,
**I want** to create the CartItem entity and database schema,
**so that** cart items can be stored and managed.

## Acceptance Criteria

1. CartItem实体类已创建，包含字段：id、userId、workId、productId、color、size、quantity、previewImageUrl、createTime、updateTime
2. CartItemRepository接口已创建
3. 数据库表自动创建功能已配置
4. 能够通过Repository进行购物车项的增删改查操作
5. 支持按用户ID查询购物车
6. 实体类包含必要的验证注解

## Tasks / Subtasks

- [ ] Task 1: 创建CartItem实体类 (AC: 1, 6)
  - [ ] 创建CartItem.java实体类
  - [ ] 添加JPA注解
  - [ ] 添加字段：id、userId、workId、productId、color、size、quantity、previewImageUrl、createTime、updateTime
  - [ ] 添加验证注解
  - [ ] 添加@PrePersist和@PreUpdate自动设置时间
  - [ ] 添加与User、Work、Product的关联关系
- [ ] Task 2: 创建CartItemRepository接口 (AC: 2, 4, 5)
  - [ ] 创建CartItemRepository接口，继承JpaRepository
  - [ ] 添加findByUserId方法
  - [ ] 添加findByUserIdAndWorkIdAndProductIdAndColorAndSize方法（检查重复项）
- [ ] Task 3: 配置数据库自动创建 (AC: 3)
  - [ ] 确保application.yml中JPA配置正确
  - [ ] 验证数据库表能够自动创建
- [ ] Task 4: 创建单元测试 (AC: 4, 5)
  - [ ] 创建CartItemRepositoryTest
  - [ ] 测试保存购物车项
  - [ ] 测试查询购物车项
  - [ ] 测试按用户ID查询

## Dev Notes

### Previous Story Insights

依赖Story 1.3（用户实体）、Story 3.1（作品实体）、Story 4.1（商品实体）完成，确保相关实体类已创建。

### Data Models

**CartItem实体类字段定义：**
- id: Long - 购物车项ID，主键，自增
- userId: Long - 用户ID，外键，关联User
- workId: Long - 作品ID，外键，关联Work
- productId: Long - 商品ID，外键，关联Product
- color: String - 选择的颜色
- size: String - 选择的尺寸
- quantity: Integer - 数量，默认1
- previewImageUrl: String - 预览图片URL（合成后的图片）
- createTime: LocalDateTime - 创建时间，自动设置
- updateTime: LocalDateTime - 更新时间，自动更新

**数据库表结构：**
```sql
CREATE TABLE cart_items (
    id BIGINT PRIMARY KEY AUTO_INCREMENT,
    user_id BIGINT NOT NULL,
    work_id BIGINT NOT NULL,
    product_id BIGINT NOT NULL,
    color VARCHAR(50),
    size VARCHAR(50),
    quantity INT DEFAULT 1,
    preview_image_url VARCHAR(500),
    create_time TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    update_time TIMESTAMP DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP,
    FOREIGN KEY (user_id) REFERENCES users(id),
    FOREIGN KEY (work_id) REFERENCES works(id),
    FOREIGN KEY (product_id) REFERENCES products(id)
);
```

[Source: docs/fullstack-architecture.md#CartItem（购物车项）]

### API Specifications

本故事不涉及API接口，仅创建数据模型和Repository层。

### File Locations

**后端文件位置：**
```
backend/src/main/java/com/myshop/
├── entity/
│   └── CartItem.java                 # 购物车项实体类
└── repository/
    └── CartItemRepository.java       # 购物车项数据访问接口
```

[Source: docs/fullstack-architecture.md#Repository Structure]

### Technical Constraints

- **ORM框架**: Spring Data JPA
- **外键关联**: userId关联User，workId关联Work，productId关联Product
- **唯一性**: 相同用户、作品、商品、颜色、尺寸的组合应该合并数量

[Source: docs/fullstack-architecture.md#Tech Stack]

### Testing Requirements

- 使用JUnit 5进行单元测试
- 测试文件位置：`backend/src/test/java/com/myshop/repository/CartItemRepositoryTest.java`
- 测试Repository的CRUD操作
- 测试按用户ID查询

[Source: docs/fullstack-architecture.md#Tech Stack]

## Testing

### Test File Location

测试文件应创建在：`backend/src/test/java/com/myshop/repository/CartItemRepositoryTest.java`

### Test Standards

- 使用JUnit 5和Spring Boot Test
- 使用@DataJpaTest进行Repository层测试
- 使用@Autowired注入Repository

### Test Scenarios

1. **创建购物车项测试**
   - 创建CartItem对象
   - 保存到数据库
   - 验证保存成功

2. **查询购物车项测试**
   - 保存购物车项后查询
   - 验证查询结果正确

3. **按用户查询测试**
   - 创建多个用户的购物车项
   - 按userId查询
   - 验证只返回该用户的购物车项

### Success Criteria

- CartItem实体类创建成功
- CartItemRepository接口创建成功
- 数据库表自动创建成功
- 所有Repository方法测试通过

## Change Log

| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2024-12-15 | 1.0 | 初始故事创建 | Scrum Master |

## Dev Agent Record

### Agent Model Used

_To be filled by Dev Agent_

### Debug Log References

_To be filled by Dev Agent_

### Completion Notes List

_To be filled by Dev Agent_

### File List

_To be filled by Dev Agent_

## QA Results

_To be filled by QA Agent_

