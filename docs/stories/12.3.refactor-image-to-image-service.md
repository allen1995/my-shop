# Story 12.3: 重构图生图服务

## Status

Draft

## Story

**As a** developer,
**I want** to refactor the image-to-image service to use Spring Alibaba AI,
**so that** it follows the same pattern as text-to-image.

## Acceptance Criteria

1. 使用Spring Alibaba AI框架（如果支持）
2. 或保持DashScope SDK实现，但封装为统一接口
3. 图生图功能正常工作
4. 保持与原有API接口兼容
5. 错误处理完善

## Tasks / Subtasks

- [ ] Task 1: 评估Spring Alibaba AI对图生图的支持 (AC: 1)
  - [ ] 查阅Spring Alibaba AI文档
  - [ ] 确认是否支持图生图功能
  - [ ] 确认支持的模型（qwen-image-edit等）
  - [ ] 评估功能完整性

- [ ] Task 2: 实现图生图服务（方案A：使用Spring AI）(AC: 1, 3)
  - [ ] 如果Spring AI支持，使用ImageModel实现
  - [ ] 处理参考图片输入
  - [ ] 处理相似度参数
  - [ ] 提取生成的图片URL

- [ ] Task 3: 实现图生图服务（方案B：封装DashScope SDK）(AC: 2, 3)
  - [ ] 如果Spring AI不支持，封装DashScope SDK
  - [ ] 创建统一的ImageToImageModel接口
  - [ ] 实现DashScopeImageToImageModel
  - [ ] 保持与ImageModel类似的接口

- [ ] Task 4: 保持API兼容性 (AC: 4)
  - [ ] 保持原有API接口不变
  - [ ] 保持请求参数格式不变
  - [ ] 保持响应格式不变
  - [ ] 保持错误处理逻辑一致

- [ ] Task 5: 完善错误处理 (AC: 5)
  - [ ] 处理模型调用异常
  - [ ] 处理图片上传异常
  - [ ] 处理响应解析异常
  - [ ] 返回友好的错误信息

- [ ] Task 6: 更新单元测试
  - [ ] 更新AIGenerationServiceTest
  - [ ] Mock ImageToImageModel或DashScope SDK
  - [ ] 测试图生图方法
  - [ ] 测试错误处理

## Dev Notes

### Previous Story Insights

依赖Story 12.2（重构文生图服务）完成，了解Spring Alibaba AI的使用方式。同时依赖Story 2.1（DashScope API集成），确保原有图生图功能正常。

### Data Models

**图生图请求：**
```java
interface ImageToImageRequest {
    String referenceImageUrl;  // 参考图片URL
    String prompt;            // 提示词
    double similarity;         // 相似度（0-100）
}
```

**图生图响应：**
```java
interface ImageToImageResponse {
    String generatedImageUrl;  // 生成的图片URL
}
```

### API Specifications

**保持原有API接口：**
- POST /api/image-generation/image-to-image
- 请求格式不变
- 响应格式不变

### File Locations

**后端文件位置：**
```
backend/src/main/java/com/myshop/
├── service/
│   └── AIGenerationService.java     # AI生成服务（重构）
└── model/
    └── ImageToImageModel.java        # 图生图模型接口（新建，如果方案B）
```

### Technical Constraints

- **Spring Alibaba AI**: 如果支持图生图，使用统一接口
- **DashScope SDK**: 如果不支持，封装为统一接口
- **兼容性**: 保持原有API接口和响应格式
- **错误处理**: 完善的异常处理

### 实现方案选择

**方案A：Spring Alibaba AI支持图生图**
```java
@Autowired
private ImageToImageModel imageToImageModel;

private String generateImageToImage(ImageGenerationTask task) {
    ImageToImagePrompt prompt = new ImageToImagePrompt(
        task.getImageUrl(),
        task.getPrompt(),
        task.getSimilarity()
    );
    ImageToImageResponse response = imageToImageModel.call(prompt);
    return response.getGeneratedImageUrl();
}
```

**方案B：封装DashScope SDK**
```java
public interface ImageToImageModel {
    ImageToImageResponse call(ImageToImagePrompt prompt);
}

@Service
public class DashScopeImageToImageModel implements ImageToImageModel {
    // 封装原有的DashScope SDK实现
    @Override
    public ImageToImageResponse call(ImageToImagePrompt prompt) {
        // 使用MultiModalConversation API
        // 保持原有实现逻辑
    }
}
```

### Testing Requirements

- 使用JUnit 5进行单元测试
- 使用Mockito Mock ImageToImageModel或DashScope SDK
- 测试文件位置：`backend/src/test/java/com/myshop/service/AIGenerationServiceTest.java`
- 测试正常调用
- 测试错误处理

## Testing

### Test File Location

测试文件应更新：`backend/src/test/java/com/myshop/service/AIGenerationServiceTest.java`

### Test Standards

- 使用JUnit 5和Spring Boot Test
- 使用Mockito Mock ImageToImageModel或DashScope SDK
- 使用@MockBean注入Mock对象

### Test Scenarios

1. **正常调用测试**
   - Mock模型返回成功响应
   - 调用图生图方法
   - 验证返回图片URL
   - 验证响应格式正确

2. **参数处理测试**
   - 验证参考图片URL处理
   - 验证提示词处理
   - 验证相似度参数处理

3. **错误处理测试**
   - Mock模型抛出异常
   - 验证异常处理正确
   - 验证错误信息友好

4. **兼容性测试**
   - 验证API接口不变
   - 验证请求参数格式不变
   - 验证响应格式不变

### Success Criteria

- 图生图功能正常工作
- 使用统一接口（Spring AI或封装接口）
- API接口保持兼容
- 错误处理完善
- 单元测试通过

## Change Log

| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2024-12-16 | 1.0 | 初始故事创建 | PM |

## Dev Agent Record

### Agent Model Used

_To be filled by Dev Agent_

### Debug Log References

_To be filled by Dev Agent_

### Completion Notes List

_To be filled by Dev Agent_

### File List

_To be filled by Dev Agent_

## QA Results

_To be filled by QA Agent_



