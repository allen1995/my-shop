# Story 11.1: Canvas 2D 实时预览实现

## Status

Draft

## Story

**As a** user,
**I want** to see my work overlaid on the bag in real-time using Canvas,
**so that** I can visualize how the final product will look.

## Acceptance Criteria

1. 在预览页面中集成Canvas 2D组件
2. 实现包包底图和作品图片的实时合成显示
3. 支持拖拽调整作品位置
4. 支持双指缩放调整作品大小
5. 实时更新预览效果，延迟小于100ms
6. 支持不同颜色/尺寸包包底图的切换
7. 预览效果流畅，无明显卡顿

## Tasks / Subtasks

- [ ] Task 1: 创建Canvas 2D组件 (AC: 1)
  - [ ] 在preview.vue中添加canvas组件
  - [ ] 配置canvas-id和canvas-type="2d"
  - [ ] 设置canvas尺寸（适配不同屏幕）
  - [ ] 实现onCanvasReady回调

- [ ] Task 2: 实现图片加载和绘制 (AC: 2)
  - [ ] 加载包包底图（根据选择的商品、颜色、尺寸）
  - [ ] 加载作品图片
  - [ ] 使用Canvas API绘制包包底图
  - [ ] 使用Canvas API绘制作品图片（叠加）
  - [ ] 实现图片加载完成回调

- [ ] Task 3: 实现实时预览更新 (AC: 5, 7)
  - [ ] 使用watch监听商品、颜色、尺寸变化
  - [ ] 商品/颜色/尺寸变化时重新加载底图并重绘
  - [ ] 使用requestAnimationFrame优化绘制
  - [ ] 确保重绘延迟小于100ms

- [ ] Task 4: 实现拖拽调整位置 (AC: 3)
  - [ ] 监听canvas的touchstart事件
  - [ ] 监听touchmove事件，计算移动距离
  - [ ] 更新作品图片位置
  - [ ] 实时重绘Canvas
  - [ ] 限制拖拽范围（不超出包包区域）

- [ ] Task 5: 实现双指缩放 (AC: 4)
  - [ ] 监听touchstart，识别双指触摸
  - [ ] 计算双指初始距离
  - [ ] 监听touchmove，计算当前距离
  - [ ] 根据距离变化计算缩放比例
  - [ ] 更新作品图片缩放比例
  - [ ] 限制缩放范围（0.5x - 2.0x）

- [ ] Task 6: 实现底图切换 (AC: 6)
  - [ ] 监听商品、颜色、尺寸选择变化
  - [ ] 根据选择加载对应的底图
  - [ ] 底图切换时保持作品位置和大小
  - [ ] 实现底图切换动画（可选）

- [ ] Task 7: 性能优化 (AC: 7)
  - [ ] 图片预加载和缓存
  - [ ] Canvas绘制优化（只重绘变化部分）
  - [ ] 使用防抖处理位置更新
  - [ ] 内存管理：及时释放不用的图片

## Dev Notes

### Previous Story Insights

依赖Story 4.4（前端印花预览页面）完成，确保预览页面已创建。需要在预览页面中集成Canvas 2D功能。

### Data Models

**Canvas绘制参数：**
```typescript
interface CanvasDrawParams {
  bagImageUrl: string;        // 包包底图URL
  workImageUrl: string;       // 作品图片URL
  workPosition: {              // 作品位置
    x: number;                 // X坐标（相对于canvas）
    y: number;                 // Y坐标（相对于canvas）
  };
  workScale: number;          // 作品缩放比例（0.5 - 2.0）
  workRotation: number;        // 作品旋转角度（可选，0-360）
}
```

**商品底图映射：**
```typescript
interface ProductImageMap {
  productId: number;
  color: string;
  size: string;
  baseImageUrl: string;        // 底图URL
  printArea: {                 // 印花放置区域
    x: number;                 // 区域X坐标（百分比）
    y: number;                 // 区域Y坐标（百分比）
    width: number;             // 区域宽度（百分比）
    height: number;            // 区域高度（百分比）
  };
}
```

### API Specifications

**GET /api/products/{productId}**
- 响应中需要包含不同颜色/尺寸的底图URL
- 响应格式：
```json
{
  "code": 200,
  "data": {
    "id": 1,
    "name": "帆布包",
    "baseImages": [
      {
        "color": "白色",
        "size": "大",
        "baseImageUrl": "https://oss.example.com/bags/bag-white-large.png",
        "printArea": {
          "x": 0.2,
          "y": 0.3,
          "width": 0.6,
          "height": 0.4
        }
      }
    ]
  }
}
```

### File Locations

**前端文件位置：**
```
frontend/
├── pages/
│   └── preview/
│       └── preview.vue               # 印花预览页面（更新）
└── utils/
    └── canvas-helper.js               # Canvas工具函数（新建）
```

### Technical Constraints

- **Canvas API**: 使用uni.createCanvasContext创建Canvas 2D上下文
- **图片加载**: 使用uni.getImageInfo获取图片信息
- **触摸事件**: 使用@touchstart、@touchmove、@touchend
- **性能**: 使用requestAnimationFrame优化绘制
- **兼容性**: 确保在微信小程序环境中正常工作

### Canvas绘制流程

1. **初始化Canvas**
   ```javascript
   const ctx = uni.createCanvasContext('preview-canvas', this)
   ```

2. **加载图片**
   ```javascript
   uni.getImageInfo({
     src: bagImageUrl,
     success: (res) => {
       // 绘制包包底图
       ctx.drawImage(res.path, 0, 0, canvasWidth, canvasHeight)
     }
   })
   ```

3. **绘制作品图片**
   ```javascript
   ctx.save()
   ctx.translate(workPosition.x, workPosition.y)
   ctx.scale(workScale, workScale)
   ctx.rotate(workRotation * Math.PI / 180)
   ctx.drawImage(workImageUrl, -workWidth/2, -workHeight/2, workWidth, workHeight)
   ctx.restore()
   ```

4. **执行绘制**
   ```javascript
   ctx.draw()
   ```

### 性能优化策略

1. **图片缓存**
   - 使用Map缓存已加载的图片
   - 避免重复加载相同图片

2. **绘制优化**
   - 使用requestAnimationFrame控制绘制频率
   - 只重绘变化的部分（如果可能）

3. **防抖处理**
   - 位置调整时使用防抖，避免频繁重绘
   - 缩放调整时使用节流

4. **内存管理**
   - 及时释放不用的图片资源
   - 切换商品时清理旧的图片

### Testing Requirements

前端测试暂不实施，主要进行手动验证：
- 验证Canvas初始化
- 验证图片加载和绘制
- 验证拖拽和缩放功能
- 验证性能

## Testing

### Test File Location

前端测试暂不实施，后续添加。

### Test Standards

当前阶段主要进行手动验证：
- 在微信开发者工具中测试Canvas功能
- 验证实时预览效果
- 验证交互功能
- 验证性能（FPS、延迟）

### Test Scenarios

1. **Canvas初始化测试**
   - 进入预览页面
   - 验证Canvas正常创建
   - 验证Canvas尺寸正确

2. **图片加载测试**
   - 验证包包底图正常加载
   - 验证作品图片正常加载
   - 验证图片绘制正确

3. **实时预览测试**
   - 切换商品、颜色、尺寸
   - 验证预览效果实时更新
   - 验证更新延迟小于100ms

4. **拖拽功能测试**
   - 单指拖拽作品图片
   - 验证位置实时更新
   - 验证拖拽范围限制

5. **缩放功能测试**
   - 双指缩放作品图片
   - 验证缩放比例正确
   - 验证缩放范围限制（0.5x - 2.0x）

6. **性能测试**
   - 验证预览流畅度（FPS > 30）
   - 验证内存使用正常
   - 验证无明显卡顿

### Success Criteria

- Canvas 2D组件正常集成
- 实时预览效果正确
- 拖拽和缩放功能正常
- 预览流畅，无明显卡顿
- 性能满足要求（延迟 < 100ms，FPS > 30）

## Change Log

| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2024-12-16 | 1.0 | 初始故事创建 | PM |

## Dev Agent Record

### Agent Model Used

_To be filled by Dev Agent_

### Debug Log References

_To be filled by Dev Agent_

### Completion Notes List

_To be filled by Dev Agent_

### File List

_To be filled by Dev Agent_

## QA Results

_To be filled by QA Agent_

