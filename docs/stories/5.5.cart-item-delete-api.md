# Story 5.5: 删除购物车项API

## Status

Draft

## Story

**As a** user,
**I want** to remove items from my cart,
**so that** I can clean up unwanted items.

## Acceptance Criteria

1. 后端提供 `/api/cart/items/{itemId}` DELETE接口
2. 验证购物车项属于当前用户
3. 删除购物车项记录
4. 返回删除成功信息

## Tasks / Subtasks

- [ ] Task 1: 扩展CartController (AC: 1, 2, 3, 4)
  - [ ] 实现DELETE /api/cart/items/{itemId}接口
  - [ ] 从UserContext获取当前用户ID
  - [ ] 验证购物车项存在且属于当前用户
  - [ ] 调用Service层删除
  - [ ] 返回删除成功信息
  - [ ] 添加错误处理
- [ ] Task 2: 扩展CartService (AC: 2, 3)
  - [ ] 实现deleteCartItem方法
  - [ ] 验证购物车项存在且属于当前用户
  - [ ] 删除购物车项记录
  - [ ] 返回删除成功信息
- [ ] Task 3: 实现权限验证 (AC: 2)
  - [ ] 验证购物车项存在
  - [ ] 验证购物车项属于当前用户
  - [ ] 返回友好的错误信息（404或403）
- [ ] Task 4: 创建单元测试 (AC: 1, 2, 3, 4)
  - [ ] 创建CartControllerTest测试
  - [ ] 测试删除购物车项
  - [ ] 测试权限验证（不能删除其他用户的购物车项）
  - [ ] 测试删除不存在的购物车项

## Dev Notes

### Previous Story Insights

依赖Story 5.1（购物车实体和数据库设计）和Story 1.6（JWT认证中间件）完成，确保CartItem实体类和UserContext已创建。

### Data Models

使用Story 5.1创建的CartItem实体类。

**响应DTO：**
- DeleteResponse: { success: boolean, message: string }

[Source: docs/fullstack-architecture.md#CartItem（购物车项）]

### API Specifications

**DELETE /api/cart/items/{itemId}**
- 描述：删除购物车项
- 认证：需要JWT Token
- 路径参数：itemId - 购物车项ID
- 响应：`{ success: true, message: "删除成功" }`

**业务逻辑：**
- 验证购物车项存在且属于当前用户
- 删除购物车项记录
- 返回删除成功信息

[Source: docs/fullstack-architecture.md#API Specification]

### File Locations

**后端文件位置：**
```
backend/src/main/java/com/myshop/
├── controller/
│   └── CartController.java           # 购物车控制器（扩展）
└── service/
    └── CartService.java              # 购物车服务（扩展）
```

[Source: docs/fullstack-architecture.md#Repository Structure]

### Technical Constraints

- **用户身份**: 从UserContext获取当前用户ID
- **权限验证**: 只能删除自己的购物车项
- **错误处理**: 购物车项不存在或不属于当前用户时返回适当的错误

[Source: docs/fullstack-architecture.md#Tech Stack]

### Testing Requirements

- 使用JUnit 5和MockMvc进行Controller测试
- 测试文件位置：`backend/src/test/java/com/myshop/controller/CartControllerTest.java`
- 测试删除购物车项
- 测试权限验证
- 测试删除不存在的购物车项

[Source: docs/fullstack-architecture.md#Tech Stack]

## Testing

### Test File Location

测试文件应创建在：`backend/src/test/java/com/myshop/controller/CartControllerTest.java`

### Test Standards

- 使用JUnit 5和Spring Boot Test
- 使用MockMvc测试REST接口
- 使用Mockito Mock依赖

### Test Scenarios

1. **正常删除购物车项测试**
   - 创建购物车项
   - 删除购物车项
   - 验证删除成功
   - 验证购物车项已从数据库删除

2. **权限验证测试**
   - 尝试删除其他用户的购物车项
   - 验证返回403或404错误
   - 验证购物车项未被删除

3. **删除不存在的购物车项测试**
   - 尝试删除不存在的购物车项ID
   - 验证返回404错误

### Success Criteria

- 删除购物车项接口能够正常工作
- 权限验证正确
- 错误处理完善
- 删除后购物车项确实从数据库删除

## Change Log

| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2024-12-15 | 1.0 | 初始故事创建 | Scrum Master |

## Dev Agent Record

### Agent Model Used

_To be filled by Dev Agent_

### Debug Log References

_To be filled by Dev Agent_

### Completion Notes List

_To be filled by Dev Agent_

### File List

_To be filled by Dev Agent_

## QA Results

_To be filled by QA Agent_

