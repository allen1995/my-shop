# Story 3.1: 作品实体和数据库设计

## Status

Draft

## Story

**As a** developer,
**I want** to create the Work entity and database schema,
**so that** user works can be stored and managed.

## Acceptance Criteria

1. Work实体类已创建，包含字段：id、userId、title、description、imageUrl、tags、createTime、updateTime
2. WorkRepository接口已创建
3. 数据库表自动创建功能已配置
4. 能够通过Repository进行作品的增删改查操作
5. 支持按用户ID查询作品列表
6. 实体类包含必要的验证注解

## Tasks / Subtasks

- [ ] Task 1: 创建Work实体类 (AC: 1, 6)
  - [ ] 创建Work.java实体类
  - [ ] 添加JPA注解（@Entity, @Table, @Id, @GeneratedValue）
  - [ ] 添加字段：id、userId、title、description、imageUrl、tags、createTime、updateTime
  - [ ] 添加验证注解（@NotBlank, @Size等）
  - [ ] 添加@PrePersist和@PreUpdate自动设置时间
  - [ ] 添加与User的关联关系（@ManyToOne）
- [ ] Task 2: 处理tags字段 (AC: 1)
  - [ ] tags字段存储为JSON字符串或使用@ElementCollection
  - [ ] 实现tags的序列化和反序列化
- [ ] Task 3: 创建WorkRepository接口 (AC: 2, 4, 5)
  - [ ] 创建WorkRepository接口，继承JpaRepository
  - [ ] 添加findByUserId方法
  - [ ] 添加findByUserIdOrderByCreateTimeDesc方法（按创建时间倒序）
- [ ] Task 4: 配置数据库自动创建 (AC: 3)
  - [ ] 确保application.yml中JPA配置正确
  - [ ] 验证数据库表能够自动创建
- [ ] Task 5: 创建单元测试 (AC: 4, 5)
  - [ ] 创建WorkRepositoryTest
  - [ ] 测试保存作品
  - [ ] 测试查询作品
  - [ ] 测试按用户ID查询
  - [ ] 测试更新作品
  - [ ] 测试删除作品

## Dev Notes

### Previous Story Insights

依赖Story 1.3（用户实体和数据库设计）完成，确保User实体类已创建，用于关联userId。

### Data Models

**Work实体类字段定义：**
- id: Long - 作品ID，主键，自增
- userId: Long - 用户ID，外键，关联User
- title: String - 作品标题，不能为空
- description: String - 作品描述（可选）
- imageUrl: String - 作品图片URL（OSS），不能为空
- tags: String[] - 作品标签（数组，存储为JSON字符串）
- createTime: LocalDateTime - 创建时间，自动设置
- updateTime: LocalDateTime - 更新时间，自动更新

**数据库表结构：**
```sql
CREATE TABLE works (
    id BIGINT PRIMARY KEY AUTO_INCREMENT,
    user_id BIGINT NOT NULL,
    title VARCHAR(200) NOT NULL,
    description TEXT,
    image_url VARCHAR(500) NOT NULL,
    tags VARCHAR(500), -- JSON array
    category VARCHAR(50),
    is_favorite BOOLEAN DEFAULT FALSE,
    create_time TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    update_time TIMESTAMP DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP,
    FOREIGN KEY (user_id) REFERENCES users(id)
);
```

[Source: docs/fullstack-architecture.md#Work（作品）]

### API Specifications

本故事不涉及API接口，仅创建数据模型和Repository层。

### File Locations

**后端文件位置：**
```
backend/src/main/java/com/myshop/
├── entity/
│   └── Work.java                     # 作品实体类
└── repository/
    └── WorkRepository.java           # 作品数据访问接口
```

[Source: docs/fullstack-architecture.md#Repository Structure]

### Technical Constraints

- **ORM框架**: Spring Data JPA
- **JSON字段**: tags字段存储为JSON字符串，使用@Type注解或自定义转换器
- **外键关联**: userId关联User表
- **时间字段**: 使用LocalDateTime，通过@PrePersist和@PreUpdate自动设置

[Source: docs/fullstack-architecture.md#Tech Stack]

### Testing Requirements

- 使用JUnit 5进行单元测试
- 测试文件位置：`backend/src/test/java/com/myshop/repository/WorkRepositoryTest.java`
- 测试Repository的CRUD操作
- 测试按用户ID查询

[Source: docs/fullstack-architecture.md#Tech Stack]

## Testing

### Test File Location

测试文件应创建在：`backend/src/test/java/com/myshop/repository/WorkRepositoryTest.java`

### Test Standards

- 使用JUnit 5和Spring Boot Test
- 使用@DataJpaTest进行Repository层测试
- 使用@Autowired注入Repository

### Test Scenarios

1. **创建作品测试**
   - 创建Work对象
   - 保存到数据库
   - 验证保存成功

2. **查询作品测试**
   - 保存作品后查询
   - 验证查询结果正确

3. **按用户查询测试**
   - 创建多个用户的作品
   - 按userId查询
   - 验证只返回该用户的作品
   - 验证按创建时间倒序排列

4. **更新作品测试**
   - 更新作品信息
   - 验证更新成功

5. **删除作品测试**
   - 删除作品
   - 验证删除成功

### Success Criteria

- Work实体类创建成功
- WorkRepository接口创建成功
- 数据库表自动创建成功
- 所有Repository方法测试通过

## Change Log

| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2024-12-15 | 1.0 | 初始故事创建 | Scrum Master |

## Dev Agent Record

### Agent Model Used

_To be filled by Dev Agent_

### Debug Log References

_To be filled by Dev Agent_

### Completion Notes List

_To be filled by Dev Agent_

### File List

_To be filled by Dev Agent_

## QA Results

_To be filled by QA Agent_

