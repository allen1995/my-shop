# Story 4.5: Canvas图片合成功能

## Status

Draft

## Story

**As a** developer,
**I want** to implement image composition using Canvas,
**so that** users can see the print effect on the bag.

## Acceptance Criteria

1. 使用uni.canvasToTempFilePath进行图片合成
2. 将作品图片叠加到包包图片上
3. 支持调整印花位置和大小
4. 生成预览图片
5. 性能优化，合成时间小于1秒

## Tasks / Subtasks

- [ ] Task 1: 实现Canvas 2D初始化 (AC: 1, 2)
  - [ ] 在预览页面中创建Canvas 2D组件
  - [ ] 获取Canvas 2D上下文
  - [ ] 实现onCanvasReady回调
- [ ] Task 2: 实现图片加载和绘制 (AC: 2)
  - [ ] 加载包包基础图片
  - [ ] 加载作品图片
  - [ ] 使用Canvas API绘制包包图片
  - [ ] 使用Canvas API绘制作品图片（叠加）
- [ ] Task 3: 实现位置和大小调整 (AC: 3)
  - [ ] 实现拖拽调整位置
  - [ ] 实现缩放调整大小（可选）
  - [ ] 实时更新Canvas绘制
- [ ] Task 4: 实现图片合成 (AC: 4)
  - [ ] 使用uni.canvasToTempFilePath生成预览图片
  - [ ] 保存合成后的图片URL
  - [ ] 用于后续添加到购物车
- [ ] Task 5: 优化性能 (AC: 5)
  - [ ] 优化图片加载（使用缓存）
  - [ ] 优化Canvas绘制（避免频繁重绘）
  - [ ] 验证合成时间小于1秒
- [ ] Task 6: 处理错误情况
  - [ ] 处理图片加载失败
  - [ ] 处理Canvas绘制失败
  - [ ] 显示友好的错误提示

## Dev Notes

### Previous Story Insights

依赖Story 4.4（前端印花预览页面）完成，确保预览页面已创建。需要在预览页面中实现Canvas图片合成功能。

### Data Models

**合成参数：**
- bagImageUrl: string - 包包图片URL
- workImageUrl: string - 作品图片URL
- position: { x: number, y: number } - 位置
- scale: number - 缩放比例（可选）

**合成结果：**
- previewImageUrl: string - 合成后的预览图片URL

### API Specifications

本故事不涉及后端API，仅在前端实现Canvas图片合成功能。

### File Locations

**前端文件位置：**
```
frontend/
└── pages/
    └── preview/
        └── preview.vue               # 印花预览页面（更新）
```

[Source: docs/fullstack-architecture.md#Repository Structure]

### Technical Constraints

- **Canvas API**: 使用Canvas 2D API（小程序环境推荐）
- **图片合成**: 使用uni.canvasToTempFilePath生成临时图片
- **性能**: 合成时间小于1秒
- **兼容性**: 确保在小程序环境中正常工作

[Source: docs/fullstack-architecture.md#Tech Stack]

### Testing Requirements

前端测试暂不实施，主要进行手动验证：
- 验证Canvas绘制
- 验证图片合成
- 验证性能

[Source: docs/fullstack-architecture.md#Tech Stack]

## Testing

### Test File Location

前端测试暂不实施，后续添加。

### Test Standards

当前阶段主要进行手动验证：
- 在微信开发者工具中测试Canvas功能
- 验证图片合成效果
- 验证性能

### Test Scenarios

1. **Canvas绘制测试**
   - 验证Canvas能够正常初始化
   - 验证图片能够正常绘制
   - 验证图片叠加效果

2. **位置调整测试**
   - 拖拽调整位置
   - 验证Canvas实时更新

3. **图片合成测试**
   - 点击合成按钮
   - 验证生成预览图片
   - 验证合成时间小于1秒

### Success Criteria

- Canvas图片合成功能正常
- 图片叠加效果正确
- 位置调整功能正常
- 合成性能满足要求

## Change Log

| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2024-12-15 | 1.0 | 初始故事创建 | Scrum Master |

## Dev Agent Record

### Agent Model Used

_To be filled by Dev Agent_

### Debug Log References

_To be filled by Dev Agent_

### Completion Notes List

_To be filled by Dev Agent_

### File List

_To be filled by Dev Agent_

## QA Results

_To be filled by QA Agent_

