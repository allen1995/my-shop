# Story 5.10: 支付回调处理

## Status

Draft

## Story

**As a** developer,
**I want** to handle WeChat payment callbacks,
**so that** order status can be updated automatically after payment.

## Acceptance Criteria

1. 支付回调接口 `/api/payment/notify` 已实现
2. 验证回调签名
3. 更新订单支付状态
4. 处理重复回调（幂等性）
5. 返回成功响应给微信

## Tasks / Subtasks

- [ ] Task 1: 创建PaymentController (AC: 1, 5)
  - [ ] 创建PaymentController
  - [ ] 实现POST /api/payment/notify接口
  - [ ] 接收XML格式的回调数据
  - [ ] 返回XML格式的成功响应
- [ ] Task 2: 实现签名验证 (AC: 2)
  - [ ] 解析回调数据
  - [ ] 验证回调签名
  - [ ] 签名验证失败时返回错误
- [ ] Task 3: 实现订单状态更新 (AC: 3)
  - [ ] 根据订单号查询订单
  - [ ] 验证订单金额
  - [ ] 更新订单支付状态为PAID
  - [ ] 更新订单状态为PAID
  - [ ] 记录支付时间
- [ ] Task 4: 实现幂等性处理 (AC: 4)
  - [ ] 检查订单是否已支付
  - [ ] 如果已支付，直接返回成功
  - [ ] 避免重复更新订单状态
- [ ] Task 5: 错误处理和日志 (AC: 2, 3, 4, 5)
  - [ ] 处理签名验证失败
  - [ ] 处理订单不存在
  - [ ] 处理金额不匹配
  - [ ] 记录错误日志
  - [ ] 返回适当的响应给微信

## Dev Notes

### Previous Story Insights

依赖Story 5.6（订单实体）、Story 5.8（微信支付集成）完成，确保Order实体类和微信支付服务已实现。

### Data Models

使用Story 5.6创建的Order实体类。

**回调数据格式：**
- 微信支付回调为XML格式
- 包含字段：return_code、result_code、out_trade_no、transaction_id、total_fee等

**响应格式：**
- 返回XML格式：`<xml><return_code><![CDATA[SUCCESS]]></return_code><return_msg><![CDATA[OK]]></return_msg></xml>`

[Source: docs/fullstack-architecture.md#Order（订单）]

### API Specifications

**POST /api/payment/notify**
- 描述：微信支付回调接口
- 认证：不需要JWT Token（微信服务器调用）
- 请求体：XML格式的支付回调数据
- 响应：XML格式的成功响应

**业务逻辑：**
- 解析XML回调数据
- 验证回调签名
- 根据订单号查询订单
- 验证订单金额
- 检查订单是否已支付（幂等性）
- 更新订单支付状态和状态
- 返回成功响应给微信

[Source: docs/fullstack-architecture.md#API Specification]

### File Locations

**后端文件位置：**
```
backend/src/main/java/com/myshop/
├── controller/
│   └── PaymentController.java       # 支付控制器（扩展）
└── service/
    └── WeChatPayService.java        # 微信支付服务（扩展）
```

[Source: docs/fullstack-architecture.md#Repository Structure]

### Technical Constraints

- **回调格式**: 微信支付回调为XML格式，需要使用XML解析库
- **签名验证**: 必须验证回调签名，确保安全性
- **幂等性**: 处理重复回调，避免重复更新订单状态
- **响应格式**: 必须返回XML格式的成功响应给微信

[Source: docs/fullstack-architecture.md#Tech Stack]

### Testing Requirements

- 使用JUnit 5和MockMvc进行Controller测试
- 测试文件位置：`backend/src/test/java/com/myshop/controller/PaymentControllerTest.java`
- 测试回调处理
- 测试签名验证
- 测试幂等性
- 测试错误处理

[Source: docs/fullstack-architecture.md#Tech Stack]

## Testing

### Test File Location

测试文件应创建在：`backend/src/test/java/com/myshop/controller/PaymentControllerTest.java`

### Test Standards

- 使用JUnit 5和Spring Boot Test
- 使用MockMvc测试REST接口
- 模拟微信支付回调XML数据

### Test Scenarios

1. **正常回调处理测试**
   - 发送有效的支付回调
   - 验证签名验证通过
   - 验证订单状态更新正确
   - 验证返回成功响应

2. **签名验证失败测试**
   - 发送签名错误的回调
   - 验证返回失败响应
   - 验证订单状态未更新

3. **幂等性测试**
   - 发送相同的回调多次
   - 验证订单状态只更新一次
   - 验证每次都返回成功响应

4. **订单不存在测试**
   - 发送不存在的订单号回调
   - 验证返回错误响应
   - 验证订单状态未更新

5. **金额不匹配测试**
   - 发送金额不匹配的回调
   - 验证返回错误响应
   - 验证订单状态未更新

### Success Criteria

- 支付回调接口能够正常工作
- 签名验证正确
- 订单状态更新正确
- 幂等性处理正确
- 错误处理完善

## Change Log

| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2024-12-15 | 1.0 | 初始故事创建 | Scrum Master |

## Dev Agent Record

### Agent Model Used

_To be filled by Dev Agent_

### Debug Log References

_To be filled by Dev Agent_

### Completion Notes List

_To be filled by Dev Agent_

### File List

_To be filled by Dev Agent_

## QA Results

_To be filled by QA Agent_

