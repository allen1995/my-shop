# Story 2.4: 生成进度查询接口

## Status

Draft

## Story

**As a** user,
**I want** to check the progress of my image generation,
**so that** I know when my image will be ready.

## Acceptance Criteria

1. 后端提供 `/api/image-generation/tasks/{taskId}` 接口
2. 接口返回任务状态、进度信息
3. 如果任务完成，返回生成的图片URL
4. 如果任务失败，返回错误信息
5. 接口响应时间小于100ms
6. 支持任务不存在的情况处理

## Tasks / Subtasks

- [ ] Task 1: 创建任务状态响应DTO (AC: 2, 3, 4)
  - [ ] 创建TaskStatusResponse DTO
  - [ ] 包含字段：taskId、status、progress、resultUrl、errorMessage
- [ ] Task 2: 实现任务查询接口 (AC: 1, 2, 3, 4, 6)
  - [ ] 在ImageGenerationController中实现GET /api/image-generation/tasks/{taskId}
  - [ ] 验证任务属于当前用户
  - [ ] 查询任务信息
  - [ ] 根据状态返回相应信息
  - [ ] 处理任务不存在的情况
- [ ] Task 3: 实现任务进度计算 (AC: 2)
  - [ ] 根据任务状态计算进度（PENDING: 0%, PROCESSING: 50%, COMPLETED: 100%, FAILED: 0%）
  - [ ] 或使用实际进度值（如果DashScope API提供）
- [ ] Task 4: 优化查询性能 (AC: 5)
  - [ ] 确保Repository查询使用索引
  - [ ] 避免N+1查询问题
  - [ ] 验证响应时间小于100ms
- [ ] Task 5: 创建单元测试 (AC: 1, 2, 6)
  - [ ] 创建ImageGenerationControllerTest（更新）
  - [ ] 测试查询已完成任务
  - [ ] 测试查询进行中任务
  - [ ] 测试查询失败任务
  - [ ] 测试任务不存在情况
  - [ ] 测试任务不属于当前用户情况

## Dev Notes

### Previous Story Insights

依赖Story 2.2（任务实体）和Story 2.3（文生图API）完成，确保ImageGenerationTask实体和Repository已创建。

### Data Models

使用Story 2.2创建的ImageGenerationTask实体类。

**响应DTO：**
- TaskStatusResponse: { taskId: number, status: string, progress: number, resultUrl?: string, errorMessage?: string }

[Source: docs/fullstack-architecture.md#ImageGenerationTask（图片生成任务）]

### API Specifications

**GET /api/image-generation/tasks/{taskId}**
- 描述：查询生成任务状态
- 认证：需要JWT Token
- 路径参数：taskId
- 响应：`{ task: ImageGenerationTask }` 或 `{ taskId, status, progress, resultUrl, errorMessage }`

**响应示例：**
- 进行中：{ taskId: 1, status: "PROCESSING", progress: 50 }
- 已完成：{ taskId: 1, status: "COMPLETED", progress: 100, resultUrl: "https://..." }
- 失败：{ taskId: 1, status: "FAILED", progress: 0, errorMessage: "..." }

[Source: docs/fullstack-architecture.md#API Specification]

### File Locations

**后端文件位置：**
```
backend/src/main/java/com/myshop/
├── controller/
│   └── ImageGenerationController.java  # 图片生成控制器（更新）
└── dto/
    └── TaskStatusResponse.java          # 任务状态响应DTO
```

[Source: docs/fullstack-architecture.md#Repository Structure]

### Technical Constraints

- **性能要求**: 响应时间小于100ms
- **安全**: 验证任务属于当前用户
- **错误处理**: 处理任务不存在、权限不足等情况

[Source: docs/fullstack-architecture.md#Tech Stack]

### Testing Requirements

- 使用JUnit 5和MockMvc进行Controller测试
- 测试文件位置：`backend/src/test/java/com/myshop/controller/ImageGenerationControllerTest.java`
- 测试各种任务状态
- 测试权限验证
- 性能测试（响应时间）

[Source: docs/fullstack-architecture.md#Tech Stack]

## Testing

### Test File Location

测试文件应创建在：`backend/src/test/java/com/myshop/controller/ImageGenerationControllerTest.java`

### Test Standards

- 使用JUnit 5和Spring Boot Test
- 使用MockMvc测试REST接口
- 验证响应时间

### Test Scenarios

1. **查询已完成任务测试**
   - 创建已完成的任务
   - 查询任务状态
   - 验证返回resultUrl

2. **查询进行中任务测试**
   - 创建进行中的任务
   - 查询任务状态
   - 验证返回progress

3. **查询失败任务测试**
   - 创建失败的任务
   - 查询任务状态
   - 验证返回errorMessage

4. **任务不存在测试**
   - 查询不存在的taskId
   - 验证返回404或错误信息

5. **权限验证测试**
   - 创建其他用户的任务
   - 当前用户查询
   - 验证返回403或错误信息

6. **性能测试**
   - 验证响应时间小于100ms

### Success Criteria

- 任务状态查询接口能够正常返回信息
- 各种状态的任务都能正确查询
- 权限验证正确
- 响应时间满足要求
- 错误处理完善

## Change Log

| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2024-12-15 | 1.0 | 初始故事创建 | Scrum Master |

## Dev Agent Record

### Agent Model Used

_To be filled by Dev Agent_

### Debug Log References

_To be filled by Dev Agent_

### Completion Notes List

_To be filled by Dev Agent_

### File List

_To be filled by Dev Agent_

## QA Results

_To be filled by QA Agent_

