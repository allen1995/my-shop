# Story 3.5: 删除作品API接口

## Status

Draft

## Story

**As a** user,
**I want** to delete a work from my collection,
**so that** I can remove unwanted artworks.

## Acceptance Criteria

1. 后端提供 `/api/works/{workId}` DELETE接口
2. 验证作品属于当前用户
3. 删除作品记录（可选：同时删除OSS中的图片）
4. 返回删除成功信息
5. 支持作品不存在的情况处理

## Tasks / Subtasks

- [ ] Task 1: 实现删除作品接口 (AC: 1, 2, 3, 4, 5)
  - [ ] 在WorkController中实现DELETE /api/works/{workId}接口
  - [ ] 接收workId路径参数
  - [ ] 从UserContext获取当前用户ID
  - [ ] 查询作品并验证属于当前用户
  - [ ] 如果作品不存在，返回404
  - [ ] 如果作品不属于当前用户，返回403或404
  - [ ] 删除作品记录
  - [ ] 可选：删除OSS中的图片（调用OssService）
  - [ ] 返回删除成功信息
- [ ] Task 2: 实现OSS图片删除（可选）(AC: 3)
  - [ ] 在OssService中实现删除图片方法
  - [ ] 从imageUrl中提取OSS对象key
  - [ ] 调用OSS SDK删除对象
  - [ ] 处理删除失败情况（记录日志，不阻塞删除）
- [ ] Task 3: 创建单元测试 (AC: 1, 2, 4, 5)
  - [ ] 创建WorkControllerTest（更新）
  - [ ] 测试删除作品
  - [ ] 测试作品不存在情况
  - [ ] 测试作品不属于当前用户情况
  - [ ] 测试OSS图片删除（如果实现）

## Dev Notes

### Previous Story Insights

依赖Story 3.1（作品实体和数据库设计）和Story 1.6（JWT认证中间件）完成，确保Work实体类和UserContext已创建。可选依赖OSS服务用于删除图片。

### Data Models

使用Story 3.1创建的Work实体类。

**响应DTO：**
- DeleteResponse: { success: boolean, message?: string }

[Source: docs/fullstack-architecture.md#Work（作品）]

### API Specifications

**DELETE /api/works/{workId}**
- 描述：删除作品
- 认证：需要JWT Token
- 路径参数：workId
- 响应：`{ success: boolean }`
- 错误：404（作品不存在或不属于当前用户）

**注意：**
- 删除作品记录是必须的
- 删除OSS图片是可选的（建议实现，避免存储浪费）

[Source: docs/fullstack-architecture.md#API Specification]

### File Locations

**后端文件位置：**
```
backend/src/main/java/com/myshop/
├── controller/
│   └── WorkController.java          # 作品控制器（更新）
├── service/
│   ├── WorkService.java             # 作品服务（更新）
│   └── OssService.java              # OSS服务（更新，如未创建）
└── dto/
    └── DeleteResponse.java           # 删除响应DTO
```

[Source: docs/fullstack-architecture.md#Repository Structure]

### Technical Constraints

- **安全**: 验证作品属于当前用户
- **OSS删除**: 可选实现，失败时记录日志但不阻塞删除
- **事务**: 使用@Transactional确保数据一致性

[Source: docs/fullstack-architecture.md#Tech Stack]

### Testing Requirements

- 使用JUnit 5和MockMvc进行Controller测试
- 使用Mockito Mock OSS服务
- 测试文件位置：`backend/src/test/java/com/myshop/controller/WorkControllerTest.java`
- 测试正常删除
- 测试权限验证
- 测试OSS删除（如果实现）

[Source: docs/fullstack-architecture.md#Tech Stack]

## Testing

### Test File Location

测试文件应创建在：`backend/src/test/java/com/myshop/controller/WorkControllerTest.java`

### Test Standards

- 使用JUnit 5和Spring Boot Test
- 使用MockMvc测试REST接口
- 使用Mockito Mock OSS服务

### Test Scenarios

1. **正常删除测试**
   - 创建作品
   - 删除作品
   - 验证删除成功
   - 验证作品已从数据库删除

2. **作品不存在测试**
   - 删除不存在的workId
   - 验证返回404

3. **权限验证测试**
   - 创建其他用户的作品
   - 当前用户删除
   - 验证返回404或403

4. **OSS图片删除测试**（如果实现）
   - Mock OSS删除成功
   - 验证调用OSS删除方法
   - 测试OSS删除失败情况（不影响作品删除）

### Success Criteria

- 删除作品接口能够正常删除作品
- 权限验证正确
- OSS图片删除功能正常（如果实现）
- 错误处理完善

## Change Log

| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2024-12-15 | 1.0 | 初始故事创建 | Scrum Master |

## Dev Agent Record

### Agent Model Used

_To be filled by Dev Agent_

### Debug Log References

_To be filled by Dev Agent_

### Completion Notes List

_To be filled by Dev Agent_

### File List

_To be filled by Dev Agent_

## QA Results

_To be filled by QA Agent_

