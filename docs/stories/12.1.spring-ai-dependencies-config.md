# Story 12.1: Spring Alibaba AI 依赖和配置

## Status

Draft

## Story

**As a** developer,
**I want** to add Spring Alibaba AI dependencies and configuration,
**so that** I can use the unified AI framework.

## Acceptance Criteria

1. Spring Alibaba AI依赖已添加到项目
2. 配置文件已更新，支持AI模型配置
3. 支持多模型配置（DashScope、DALL·E、Stable Diffusion等）
4. API Key配置支持环境变量
5. 配置验证通过

## Tasks / Subtasks

- [ ] Task 1: 添加Spring Alibaba AI依赖 (AC: 1)
  - [ ] 在pom.xml中添加spring-cloud-alibaba-ai依赖
  - [ ] 确认版本兼容性（Spring Boot 3.0+）
  - [ ] 确认与现有依赖无冲突
  - [ ] 更新依赖版本

- [ ] Task 2: 更新配置文件 (AC: 2, 4)
  - [ ] 在application.yml中添加Spring AI配置
  - [ ] 配置DashScope API Key（使用环境变量）
  - [ ] 配置DALL·E API Key（可选，使用环境变量）
  - [ ] 配置Stable Diffusion API Key（可选，使用环境变量）
  - [ ] 配置模型选择策略

- [ ] Task 3: 创建AI配置类 (AC: 2, 3)
  - [ ] 创建SpringAIConfig配置类
  - [ ] 配置ImageModel Bean
  - [ ] 支持多模型配置
  - [ ] 实现模型选择逻辑

- [ ] Task 4: 实现配置验证 (AC: 5)
  - [ ] 创建配置验证方法
  - [ ] 验证API Key是否配置
  - [ ] 验证模型配置是否正确
  - [ ] 启动时输出配置信息（日志）

- [ ] Task 5: 更新文档
  - [ ] 更新配置说明文档
  - [ ] 添加环境变量配置说明
  - [ ] 添加多模型配置示例

## Dev Notes

### Previous Story Insights

依赖Story 1.1（后端项目初始化）完成，确保Spring Boot项目已配置。需要评估Spring Alibaba AI版本兼容性。

### Data Models

**Spring AI配置：**
```yaml
spring:
  ai:
    alibaba:
      dashscope:
        api-key: ${DASHSCOPE_API_KEY}
        image:
          model: wanx-v1
          options:
            n: 1
            size: 1024x1024
    openai:
      api-key: ${OPENAI_API_KEY}
      image:
        model: dall-e-3
    stability:
      api-key: ${STABILITY_API_KEY}
      image:
        model: stable-diffusion-xl
```

**模型选择配置：**
```yaml
app:
  ai:
    primary-model: dashscope
    fallback-model: stability
    models:
      dashscope:
        enabled: true
        priority: 1
      openai:
        enabled: false
        priority: 2
      stability:
        enabled: true
        priority: 3
```

### API Specifications

本故事不涉及API接口，仅配置相关。

### File Locations

**后端文件位置：**
```
backend/src/main/java/com/myshop/
├── config/
│   └── SpringAIConfig.java           # Spring AI配置类（新建）
└── resources/
    └── application.yml                # 配置文件（更新）
```

### Technical Constraints

- **Spring Boot版本**: 3.0+
- **Spring Alibaba AI版本**: 最新稳定版
- **配置管理**: 使用application.yml和环境变量
- **兼容性**: 确保与现有配置不冲突

### 依赖配置示例

```xml
<dependency>
    <groupId>com.alibaba.cloud.ai</groupId>
    <artifactId>spring-cloud-alibaba-ai</artifactId>
    <version>最新版本</version>
</dependency>
```

### 配置类示例

```java
@Configuration
@EnableConfigurationProperties
public class SpringAIConfig {
    
    @Bean
    @Primary
    public ImageModel dashScopeImageModel(
            @Value("${spring.ai.alibaba.dashscope.api-key}") String apiKey) {
        // 配置DashScope ImageModel
        return new DashScopeImageModel(apiKey);
    }
    
    @Bean
    @ConditionalOnProperty(name = "app.ai.models.openai.enabled", havingValue = "true")
    public ImageModel openAIImageModel(
            @Value("${spring.ai.openai.api-key}") String apiKey) {
        // 配置OpenAI ImageModel
        return new OpenAIImageModel(apiKey);
    }
}
```

### Testing Requirements

- 使用Spring Boot Test进行配置测试
- 测试文件位置：`backend/src/test/java/com/myshop/config/SpringAIConfigTest.java`
- 测试配置加载
- 测试Bean创建

## Testing

### Test File Location

测试文件应创建在：`backend/src/test/java/com/myshop/config/SpringAIConfigTest.java`

### Test Standards

- 使用JUnit 5和Spring Boot Test
- 使用@SpringBootTest加载完整配置
- 验证Bean创建

### Test Scenarios

1. **依赖加载测试**
   - 验证Spring Alibaba AI依赖已添加
   - 验证无依赖冲突

2. **配置加载测试**
   - 验证配置文件正确加载
   - 验证API Key配置正确
   - 验证模型配置正确

3. **Bean创建测试**
   - 验证ImageModel Bean创建成功
   - 验证多模型Bean创建（如果配置）

4. **配置验证测试**
   - 验证配置验证方法
   - 验证缺少配置时的错误处理

### Success Criteria

- Spring Alibaba AI依赖添加成功
- 配置文件更新成功
- 配置类创建成功
- 配置验证通过
- 无依赖冲突

## Change Log

| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2024-12-16 | 1.0 | 初始故事创建 | PM |

## Dev Agent Record

### Agent Model Used

_To be filled by Dev Agent_

### Debug Log References

_To be filled by Dev Agent_

### Completion Notes List

_To be filled by Dev Agent_

### File List

_To be filled by Dev Agent_

## QA Results

_To be filled by QA Agent_

