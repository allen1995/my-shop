# Story 2.1: 阿里百炼API集成

## Status

Draft

## Story

**As a** developer,
**I want** to integrate Alibaba DashScope API for image generation,
**so that** the application can generate images using AI.

## Acceptance Criteria

1. DashScope SDK依赖已添加到项目
2. DashScope配置类已创建，支持API Key配置
3. 文生图API调用方法已实现
4. 能够成功调用API并获取生成的图片
5. API调用错误处理完善
6. 支持异步调用，不阻塞主线程

## Tasks / Subtasks

- [ ] Task 1: 添加DashScope SDK依赖 (AC: 1)
  - [ ] 在pom.xml中添加dashscope-sdk-java依赖
  - [ ] 确认版本兼容性（Spring Boot 3.0+）
- [ ] Task 2: 创建DashScope配置类 (AC: 2)
  - [ ] 在application.yml中添加DashScope API Key配置
  - [ ] 创建DashScopeConfig配置类
  - [ ] 使用@Value注入API Key
  - [ ] 初始化DashScope客户端
- [ ] Task 3: 创建AIGenerationService (AC: 3, 4)
  - [ ] 创建AIGenerationService服务类
  - [ ] 实现文生图方法（textToImage）
  - [ ] 使用DashScope SDK调用文生图API
  - [ ] 处理API响应，提取生成的图片URL
  - [ ] 添加日志记录
- [ ] Task 4: 实现错误处理 (AC: 5)
  - [ ] 处理API调用异常
  - [ ] 处理网络错误
  - [ ] 处理API返回错误
  - [ ] 返回友好的错误信息
- [ ] Task 5: 实现异步调用 (AC: 6)
  - [ ] 使用@Async注解实现异步方法
  - [ ] 配置异步执行器
  - [ ] 验证异步调用不阻塞主线程
- [ ] Task 6: 创建单元测试 (AC: 3, 4, 5)
  - [ ] 创建AIGenerationServiceTest
  - [ ] Mock DashScope API调用
  - [ ] 测试文生图方法
  - [ ] 测试错误处理

## Dev Notes

### Previous Story Insights

依赖Story 1.1（后端项目初始化）完成，确保Spring Boot项目已配置。同时需要OSS服务用于存储生成的图片（后续故事）。

### Data Models

**文生图请求参数：**
- prompt: String - 提示词
- parameters: Map<String, Object> - 生成参数（尺寸、风格等）

**文生图响应：**
- 生成的图片URL（需要上传到OSS后返回）

[Source: docs/fullstack-architecture.md#AI生成相关]

### API Specifications

**DashScope API：**
- 模型：通义万相（wanx-v1）
- 端点：通过SDK调用，无需直接HTTP调用
- 参数：prompt（提示词）、size（尺寸）、style（风格）等

[Source: docs/fullstack-architecture.md#阿里云百炼API]

### File Locations

**后端文件位置：**
```
backend/src/main/java/com/myshop/
├── config/
│   └── DashScopeConfig.java         # DashScope配置类
└── service/
    └── AIGenerationService.java     # AI生成服务
```

[Source: docs/fullstack-architecture.md#Repository Structure]

### Technical Constraints

- **DashScope SDK**: dashscope-sdk-java（最新版本，支持Spring Boot 3.0+）
- **异步处理**: 使用Spring的@Async注解
- **配置管理**: API Key存储在application.yml中，使用环境变量（生产环境）
- **错误处理**: 完善的异常处理和日志记录

[Source: docs/fullstack-architecture.md#Tech Stack]

### Testing Requirements

- 使用JUnit 5进行单元测试
- 使用Mockito Mock DashScope SDK调用
- 测试文件位置：`backend/src/test/java/com/myshop/service/AIGenerationServiceTest.java`
- 测试正常API调用
- 测试错误处理

[Source: docs/fullstack-architecture.md#Tech Stack]

## Testing

### Test File Location

测试文件应创建在：`backend/src/test/java/com/myshop/service/AIGenerationServiceTest.java`

### Test Standards

- 使用JUnit 5和Spring Boot Test
- 使用Mockito Mock外部服务（DashScope SDK）
- 使用@MockBean注入Mock对象

### Test Scenarios

1. **正常API调用测试**
   - Mock DashScope API返回成功响应
   - 调用文生图方法
   - 验证返回图片URL

2. **错误处理测试**
   - Mock DashScope API返回错误
   - 验证异常处理正确
   - 验证错误信息友好

3. **异步调用测试**
   - 验证异步方法不阻塞主线程
   - 验证异步执行器配置正确

### Success Criteria

- DashScope SDK依赖添加成功
- 配置类创建成功
- 文生图方法能够成功调用API
- 错误处理完善
- 异步调用正常

## Change Log

| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2024-12-15 | 1.0 | 初始故事创建 | Scrum Master |

## Dev Agent Record

### Agent Model Used

_To be filled by Dev Agent_

### Debug Log References

_To be filled by Dev Agent_

### Completion Notes List

_To be filled by Dev Agent_

### File List

_To be filled by Dev Agent_

## QA Results

_To be filled by QA Agent_

