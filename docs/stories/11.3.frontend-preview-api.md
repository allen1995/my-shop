# Story 11.3: 前端预览生成接口实现

## Status

Ready

## Story

**As a** user,
**I want** to generate a preview image of my work on the bag,
**so that** I can see the final effect before adding to cart.

## Acceptance Criteria

1. 后端提供 `/api/preview/generate` 接口
2. 接口接收 workId、productId、color、size 参数
3. 调用通义万相图像编辑API生成预览图片
4. 提示词模板：将印花图片自然地合成到包包的中心位置
5. 预览图片上传到OSS并返回URL
6. 支持预览图片缓存（相同参数直接返回缓存）
7. 预览图片质量满足展示需求（分辨率1024x1024或更高）

## Tasks / Subtasks

- [x] Task 1: 创建预览生成Controller (AC: 1, 2)
  - [x] 创建PreviewController
  - [x] 实现POST /api/preview/generate接口
  - [x] 参数验证：workId、productId、color、size
  - [x] 用户认证

- [x] Task 2: 实现预览生成逻辑 (AC: 3, 4)
  - [x] 调用PreviewTaskService创建任务
  - [x] 返回任务ID给前端
  - [x] 前端轮询任务状态
  - [x] 任务完成后返回预览图片URL

- [x] Task 3: 实现任务状态查询接口 (AC: 6)
  - [x] 创建GET /api/preview/tasks/{taskId}接口
  - [x] 返回任务状态、进度、结果URL
  - [x] 支持轮询查询

- [x] Task 4: 集成图像编辑服务 (AC: 5)
  - [x] 获取作品图片URL
  - [x] 根据商品、颜色、尺寸获取包包底图URL
  - [x] 构造提示词
  - [x] 调用ImageEditService
  - [x] 将结果上传到OSS

- [x] Task 5: 实现缓存机制 (AC: 6)
  - [x] 检查是否存在相同参数的已完成任务
  - [x] 如果存在，直接返回缓存结果
  - [x] 如果不存在，创建新任务
  - [x] 缓存有效期7天

- [x] Task 6: 验证预览质量 (AC: 7)
  - [x] 设置输出尺寸1024x1024
  - [x] 验证生成图片清晰度
  - [x] 优化提示词提升效果
  - [x] 处理生成失败情况

## Dev Notes

### API Specifications

**生成预览接口：**
```
POST /api/preview/generate
Content-Type: application/json
Authorization: Bearer {token}

Request Body:
{
  "workId": 123,
  "productId": 456,
  "color": "白色",
  "size": "大"
}

Response:
{
  "code": 200,
  "message": "预览生成中",
  "data": {
    "taskId": 789,
    "status": "PROCESSING",
    "estimatedTime": 10
  }
}
```

**查询任务状态接口：**
```
GET /api/preview/tasks/{taskId}
Authorization: Bearer {token}

Response (处理中):
{
  "code": 200,
  "data": {
    "taskId": 789,
    "status": "PROCESSING",
    "progress": 50
  }
}

Response (完成):
{
  "code": 200,
  "data": {
    "taskId": 789,
    "status": "COMPLETED",
    "progress": 100,
    "resultUrl": "https://oss.example.com/preview/xxx.jpg"
  }
}

Response (失败):
{
  "code": 200,
  "data": {
    "taskId": 789,
    "status": "FAILED",
    "errorMessage": "图片生成失败，请重试"
  }
}
```

### Data Models

**预览生成请求：**
```java
@Data
public class PreviewGenerateRequest {
    @NotNull(message = "作品ID不能为空")
    private Long workId;
    
    @NotNull(message = "商品ID不能为空")
    private Long productId;
    
    @NotBlank(message = "颜色不能为空")
    private String color;
    
    @NotBlank(message = "尺寸不能为空")
    private String size;
}
```

**预览生成响应：**
```java
@Data
public class PreviewGenerateResponse {
    private Long taskId;
    private String status;
    private Integer estimatedTime;  // 预计时间（秒）
}
```

### File Locations

**后端文件位置：**
```
backend/
├── src/main/java/com/aiprint/
│   ├── controller/
│   │   └── PreviewController.java              # 预览Controller（新建）
│   ├── dto/
│   │   ├── PreviewGenerateRequest.java         # 生成请求DTO（新建）
│   │   └── PreviewGenerateResponse.java        # 生成响应DTO（新建）
│   └── service/
│       └── PreviewService.java                  # 预览服务（新建）
```

### Technical Constraints

- **认证**: 需要用户登录才能生成预览
- **参数验证**: 验证workId和productId是否存在且属于当前用户
- **并发限制**: 每个用户同时只能有一个预览任务
- **超时处理**: 生成超时时间30秒
- **降级方案**: 生成失败时返回作品原图

### 提示词模板

```java
public class PreviewPromptTemplate {
    
    public static String generate(String productType, String color, String size) {
        String basePrompt = "将图一作为印花图案自然地放置在图二包包的中心区域，" +
                           "保持包包原有的材质、光影和立体效果，" +
                           "印花大小为包包可视区域的30%左右，" +
                           "印花位置居中偏上，整体效果真实自然";
        
        // 根据商品类型和属性调整提示词
        if ("手提包".equals(productType)) {
            basePrompt += "，印花位于包包正面中央";
        } else if ("双肩包".equals(productType)) {
            basePrompt += "，印花位于包包主袋正面";
        }
        
        if ("小".equals(size)) {
            basePrompt += "，印花相对较小";
        } else if ("大".equals(size)) {
            basePrompt += "，印花相对较大";
        }
        
        return basePrompt;
    }
}
```

### 实现示例

**PreviewController实现：**
```java
@RestController
@RequestMapping("/api/preview")
public class PreviewController {
    
    @Autowired
    private PreviewService previewService;
    
    @PostMapping("/generate")
    public Result<PreviewGenerateResponse> generatePreview(
            @RequestBody @Valid PreviewGenerateRequest request,
            @AuthenticationPrincipal User currentUser) {
        
        // 1. 验证作品和商品是否存在
        Work work = workRepository.findById(request.getWorkId())
            .orElseThrow(() -> new BusinessException("作品不存在"));
        
        if (!work.getUserId().equals(currentUser.getId())) {
            throw new BusinessException("无权访问该作品");
        }
        
        Product product = productRepository.findById(request.getProductId())
            .orElseThrow(() -> new BusinessException("商品不存在"));
        
        // 2. 创建预览任务
        PreviewTask task = previewService.createPreviewTask(
            currentUser.getId(),
            request.getWorkId(),
            request.getProductId(),
            request.getColor(),
            request.getSize()
        );
        
        // 3. 返回任务信息
        PreviewGenerateResponse response = new PreviewGenerateResponse();
        response.setTaskId(task.getId());
        response.setStatus(task.getStatus().name());
        response.setEstimatedTime(10); // 预计10秒
        
        return Result.success(response);
    }
    
    @GetMapping("/tasks/{taskId}")
    public Result<PreviewTask> getTaskStatus(@PathVariable Long taskId) {
        PreviewTask task = previewService.getTask(taskId);
        if (task == null) {
            return Result.error("任务不存在");
        }
        return Result.success(task);
    }
}
```

### Testing Requirements

后端测试：
- 单元测试：测试Controller和Service
- 集成测试：测试完整预览生成流程
- 性能测试：测试并发预览生成

## Testing

### Test Scenarios

1. **预览生成测试**
   - 提供有效的参数
   - 验证返回任务ID
   - 验证任务状态为PROCESSING
   - 轮询查询任务状态
   - 验证最终返回预览图片URL

2. **参数验证测试**
   - 提供无效的workId
   - 验证返回错误提示
   - 提供不属于当前用户的workId
   - 验证返回权限错误

3. **缓存测试**
   - 生成预览
   - 再次请求相同参数的预览
   - 验证直接返回缓存结果
   - 验证不会重复调用API

4. **错误处理测试**
   - 模拟API调用失败
   - 验证返回错误信息
   - 验证支持重试
   - 验证降级方案

5. **并发控制测试**
   - 同时发起多个预览请求
   - 验证并发控制生效
   - 验证只有一个任务在执行

### Success Criteria

- 预览生成接口正常工作
- 任务状态查询接口正常
- 缓存机制有效
- 错误处理完善
- 预览质量满足要求
- 响应时间合理（10秒内）

## Change Log

| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2024-12-17 | 2.0 | 重构：改为后端API实现 | PM |
| 2024-12-16 | 1.0 | 初始故事创建（Canvas方案） | PM |

## Dev Agent Record

### Agent Model Used

Claude Sonnet 4.5

### Debug Log References

- Story 11.3 的核心功能已在 Story 11.2 中实现
- 本次主要增强了 API 接口的规范性和可维护性
- 添加了 DTO 层，使用 @Valid 进行参数验证
- 改进了错误处理和响应格式

### Completion Notes List

1. ✅ 创建 PreviewGenerateRequest DTO（包含 @NotNull 验证）
2. ✅ 创建 PreviewGenerateResponse DTO
3. ✅ 创建 PreviewTaskStatusResponse DTO
4. ✅ 重构 PreviewController，使用 @RequestBody 而非 @RequestParam
5. ✅ 添加参数验证（@Valid）
6. ✅ 优化错误处理和响应格式
7. ✅ 创建 PreviewControllerTest 单元测试（8个测试用例）
8. ✅ 支持缓存检查（如果任务已完成直接返回结果）
9. ✅ API 支持轮询查询任务状态

### File List

**新建文件：**
- `backend/src/main/java/com/myshop/dto/PreviewGenerateRequest.java`
- `backend/src/main/java/com/myshop/dto/PreviewGenerateResponse.java`
- `backend/src/main/java/com/myshop/dto/PreviewTaskStatusResponse.java`
- `backend/src/test/java/com/myshop/controller/PreviewControllerTest.java`

**修改文件：**
- `backend/src/main/java/com/myshop/controller/PreviewController.java` - 重构为使用DTO和参数验证

**注意：**
核心业务逻辑（PreviewTaskService、ImageEditService 等）已在 Story 11.2 中实现

## QA Results

_To be filled by QA Agent_

