# Story 2.3: 文生图API接口实现

## Status

Draft

## Story

**As a** user,
**I want** to submit a text prompt to generate an image,
**so that** I can create personalized artwork.

## Acceptance Criteria

1. 后端提供 `/api/image-generation/text-to-image` 接口
2. 接口接收prompt和parameters参数
3. 创建生成任务记录到数据库
4. 异步调用阿里百炼API
5. 生成完成后将图片上传到OSS
6. 更新任务状态和结果URL
7. 返回任务ID给前端
8. 接口包含参数验证和错误处理

## Tasks / Subtasks

- [ ] Task 1: 创建请求和响应DTO (AC: 2, 7)
  - [ ] 创建TextToImageRequest DTO
  - [ ] 创建TextToImageResponse DTO
  - [ ] 添加参数验证注解
- [ ] Task 2: 创建ImageGenerationController (AC: 1, 2, 7, 8)
  - [ ] 创建ImageGenerationController
  - [ ] 实现POST /api/image-generation/text-to-image接口
  - [ ] 接收并验证请求参数
  - [ ] 调用Service层处理
  - [ ] 返回任务ID
  - [ ] 添加错误处理
- [ ] Task 3: 实现文生图Service逻辑 (AC: 3, 4, 5, 6)
  - [ ] 在AIGenerationService中实现textToImage方法
  - [ ] 创建ImageGenerationTask记录（状态PENDING）
  - [ ] 异步调用DashScope API生成图片
  - [ ] 生成完成后上传图片到OSS
  - [ ] 更新任务状态为COMPLETED，保存resultUrl
  - [ ] 处理失败情况，更新状态为FAILED，保存errorMessage
- [ ] Task 4: 集成OSS服务 (AC: 5)
  - [ ] 创建OssService（如果尚未创建）
  - [ ] 实现图片上传方法
  - [ ] 在生成完成后调用上传
- [ ] Task 5: 创建单元测试 (AC: 1, 2, 3, 8)
  - [ ] 创建ImageGenerationControllerTest
  - [ ] 测试文生图接口
  - [ ] Mock DashScope API和OSS服务
  - [ ] 测试错误处理

## Dev Notes

### Previous Story Insights

依赖Story 2.1（DashScope API集成）和Story 2.2（任务实体）完成。需要OSS服务用于存储生成的图片。

### Data Models

使用Story 2.2创建的ImageGenerationTask实体类。

**请求DTO：**
- TextToImageRequest: { prompt: string, parameters: { size: string, style: string } }

**响应DTO：**
- TextToImageResponse: { taskId: number }

[Source: docs/fullstack-architecture.md#API Specification]

### API Specifications

**POST /api/image-generation/text-to-image**
- 描述：文生图
- 认证：需要JWT Token
- 请求体：`{ prompt: string, parameters: { size: string, style: string } }`
- 响应：`{ taskId: number }`

**工作流程：**
1. 创建任务记录（PENDING状态）
2. 异步调用DashScope API
3. 生成完成后上传到OSS
4. 更新任务状态和resultUrl

[Source: docs/fullstack-architecture.md#API Specification]
[Source: docs/fullstack-architecture.md#Workflow 2: AI图片生成流程]

### File Locations

**后端文件位置：**
```
backend/src/main/java/com/myshop/
├── controller/
│   └── ImageGenerationController.java  # 图片生成控制器
├── service/
│   ├── AIGenerationService.java       # AI生成服务（更新）
│   └── OssService.java                # OSS服务（如未创建）
└── dto/
    ├── TextToImageRequest.java        # 文生图请求DTO
    └── TextToImageResponse.java       # 文生图响应DTO
```

[Source: docs/fullstack-architecture.md#Repository Structure]

### Technical Constraints

- **异步处理**: 使用@Async注解，不阻塞主线程
- **任务管理**: 使用ImageGenerationTask跟踪任务状态
- **OSS存储**: 生成的图片必须上传到OSS
- **错误处理**: 完善的异常处理和日志记录

[Source: docs/fullstack-architecture.md#Tech Stack]

### Testing Requirements

- 使用JUnit 5和MockMvc进行Controller测试
- 使用Mockito Mock DashScope API和OSS服务
- 测试文件位置：`backend/src/test/java/com/myshop/controller/ImageGenerationControllerTest.java`
- 测试正常流程
- 测试错误处理

[Source: docs/fullstack-architecture.md#Tech Stack]

## Testing

### Test File Location

测试文件应创建在：`backend/src/test/java/com/myshop/controller/ImageGenerationControllerTest.java`

### Test Standards

- 使用JUnit 5和Spring Boot Test
- 使用MockMvc测试REST接口
- 使用Mockito Mock外部服务

### Test Scenarios

1. **正常文生图流程测试**
   - 发送有效的prompt和parameters
   - Mock DashScope API返回成功
   - Mock OSS上传成功
   - 验证任务创建成功
   - 验证返回taskId

2. **异步处理测试**
   - 验证接口立即返回taskId
   - 验证异步任务执行
   - 验证任务状态更新

3. **错误处理测试**
   - 测试DashScope API调用失败
   - 测试OSS上传失败
   - 验证错误信息保存
   - 验证任务状态更新为FAILED

### Success Criteria

- 文生图接口能够正常创建任务
- 异步调用DashScope API成功
- 生成的图片能够上传到OSS
- 任务状态能够正确更新
- 错误处理完善

## Change Log

| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2024-12-15 | 1.0 | 初始故事创建 | Scrum Master |

## Dev Agent Record

### Agent Model Used

_To be filled by Dev Agent_

### Debug Log References

_To be filled by Dev Agent_

### Completion Notes List

_To be filled by Dev Agent_

### File List

_To be filled by Dev Agent_

## QA Results

_To be filled by QA Agent_

