# Story 12.2: 重构文生图服务

## Status

Draft

## Story

**As a** developer,
**I want** to refactor the text-to-image service to use Spring Alibaba AI,
**so that** the code is more maintainable and extensible.

## Acceptance Criteria

1. 使用Spring Alibaba AI的ImageModel接口
2. 文生图功能正常工作
3. 保持与原有API接口兼容
4. 错误处理完善
5. 日志记录完整

## Tasks / Subtasks

- [ ] Task 1: 重构AIGenerationService (AC: 1, 2)
  - [ ] 注入ImageModel（使用@Autowired）
  - [ ] 重构generateTextToImage方法
  - [ ] 使用ImageModel.call()替代DashScope SDK调用
  - [ ] 处理ImageResponse响应
  - [ ] 提取生成的图片URL

- [ ] Task 2: 实现响应转换 (AC: 2)
  - [ ] 将ImageResponse转换为内部格式
  - [ ] 提取图片URL
  - [ ] 处理多图片响应（如果支持）
  - [ ] 保持与原有响应格式一致

- [ ] Task 3: 保持API兼容性 (AC: 3)
  - [ ] 保持原有API接口不变
  - [ ] 保持请求参数格式不变
  - [ ] 保持响应格式不变
  - [ ] 保持错误处理逻辑一致

- [ ] Task 4: 完善错误处理 (AC: 4)
  - [ ] 处理ImageModel调用异常
  - [ ] 处理响应解析异常
  - [ ] 处理图片URL提取失败
  - [ ] 返回友好的错误信息

- [ ] Task 5: 添加日志记录 (AC: 5)
  - [ ] 记录ImageModel调用
  - [ ] 记录响应信息
  - [ ] 记录错误信息
  - [ ] 记录性能指标（响应时间）

- [ ] Task 6: 更新单元测试
  - [ ] 更新AIGenerationServiceTest
  - [ ] Mock ImageModel
  - [ ] 测试文生图方法
  - [ ] 测试错误处理

## Dev Notes

### Previous Story Insights

依赖Story 12.1（Spring Alibaba AI依赖和配置）完成，确保ImageModel已配置。同时依赖Story 2.3（文生图API接口实现），确保原有功能正常。

### Data Models

**ImageModel调用：**
```java
ImagePrompt prompt = new ImagePrompt(task.getPrompt());
ImageResponse response = imageModel.call(prompt);
```

**响应处理：**
```java
// 从ImageResponse中提取图片URL
String imageUrl = extractImageUrl(response);
```

### API Specifications

**保持原有API接口：**
- POST /api/image-generation/text-to-image
- 请求格式不变
- 响应格式不变

### File Locations

**后端文件位置：**
```
backend/src/main/java/com/myshop/
└── service/
    └── AIGenerationService.java     # AI生成服务（重构）
```

### Technical Constraints

- **Spring Alibaba AI**: 使用ImageModel接口
- **兼容性**: 保持原有API接口和响应格式
- **错误处理**: 完善的异常处理
- **日志**: 使用SLF4J记录日志

### 重构示例

**原有实现：**
```java
private ImageSynthesisResult generateTextToImage(ImageGenerationTask task) {
    ImageSynthesis gen = new ImageSynthesis();
    ImageSynthesisParam param = ImageSynthesisParam.builder()
            .apiKey(apiKey)
            .model(ImageSynthesis.Models.WANX_V1)
            .prompt(task.getPrompt())
            .n(1)
            .size("1024*1024")
            .build();
    return gen.call(param);
}
```

**重构后：**
```java
private String generateTextToImage(ImageGenerationTask task) {
    ImagePrompt prompt = new ImagePrompt(task.getPrompt());
    ImageResponse response = imageModel.call(prompt);
    return extractImageUrl(response);
}
```

### 响应提取示例

```java
private String extractImageUrl(ImageResponse response) {
    if (response == null || response.getResult() == null) {
        throw new RuntimeException("Image generation failed: empty response");
    }
    
    ImageResponse.ImageResult result = response.getResult();
    if (result.getOutput() == null || result.getOutput().isEmpty()) {
        throw new RuntimeException("Image generation failed: no image in response");
    }
    
    // 提取第一张图片的URL
    return result.getOutput().get(0).getUrl();
}
```

### Testing Requirements

- 使用JUnit 5进行单元测试
- 使用Mockito Mock ImageModel
- 测试文件位置：`backend/src/test/java/com/myshop/service/AIGenerationServiceTest.java`
- 测试正常调用
- 测试错误处理

## Testing

### Test File Location

测试文件应更新：`backend/src/test/java/com/myshop/service/AIGenerationServiceTest.java`

### Test Standards

- 使用JUnit 5和Spring Boot Test
- 使用Mockito Mock ImageModel
- 使用@MockBean注入Mock对象

### Test Scenarios

1. **正常调用测试**
   - Mock ImageModel返回成功响应
   - 调用文生图方法
   - 验证返回图片URL
   - 验证响应格式正确

2. **错误处理测试**
   - Mock ImageModel抛出异常
   - 验证异常处理正确
   - 验证错误信息友好

3. **响应解析测试**
   - Mock不同格式的响应
   - 验证URL提取正确
   - 验证异常响应处理

4. **兼容性测试**
   - 验证API接口不变
   - 验证请求参数格式不变
   - 验证响应格式不变

### Success Criteria

- 使用Spring Alibaba AI的ImageModel
- 文生图功能正常工作
- API接口保持兼容
- 错误处理完善
- 日志记录完整
- 单元测试通过

## Change Log

| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2024-12-16 | 1.0 | 初始故事创建 | PM |

## Dev Agent Record

### Agent Model Used

_To be filled by Dev Agent_

### Debug Log References

_To be filled by Dev Agent_

### Completion Notes List

_To be filled by Dev Agent_

### File List

_To be filled by Dev Agent_

## QA Results

_To be filled by QA Agent_

