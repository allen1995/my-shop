# Story 12.5: 迁移测试和验证

## Status

Draft

## Story

**As a** developer,
**I want** to thoroughly test the migration,
**so that** the functionality remains intact.

## Acceptance Criteria

1. 单元测试覆盖所有AI生成方法
2. 集成测试验证API接口
3. 性能测试验证响应时间
4. 错误场景测试
5. 与原有功能对比测试（功能一致性）

## Tasks / Subtasks

- [ ] Task 1: 更新单元测试 (AC: 1)
  - [ ] 更新AIGenerationServiceTest
  - [ ] 测试文生图方法（使用Spring AI）
  - [ ] 测试图生图方法（使用Spring AI或封装接口）
  - [ ] 测试错误处理
  - [ ] 确保测试覆盖率 > 80%

- [ ] Task 2: 创建集成测试 (AC: 2)
  - [ ] 创建AIGenerationIntegrationTest
  - [ ] 测试文生图API接口
  - [ ] 测试图生图API接口
  - [ ] 验证请求和响应格式
  - [ ] 验证错误响应

- [ ] Task 3: 性能测试 (AC: 3)
  - [ ] 测试文生图响应时间
  - [ ] 测试图生图响应时间
  - [ ] 对比迁移前后的性能
  - [ ] 验证性能无明显下降

- [ ] Task 4: 错误场景测试 (AC: 4)
  - [ ] 测试API Key错误
  - [ ] 测试网络错误
  - [ ] 测试模型服务不可用
  - [ ] 测试参数错误
  - [ ] 验证错误处理正确

- [ ] Task 5: 功能对比测试 (AC: 5)
  - [ ] 对比迁移前后的功能
  - [ ] 验证响应格式一致
  - [ ] 验证错误处理一致
  - [ ] 验证性能一致或更好
  - [ ] 创建对比测试报告

- [ ] Task 6: 端到端测试
  - [ ] 测试完整生成流程
  - [ ] 测试前端调用
  - [ ] 验证用户体验一致

## Dev Notes

### Previous Story Insights

依赖Story 12.2（重构文生图服务）和Story 12.3（重构图生图服务）完成，确保迁移代码已实现。

### Data Models

本故事主要关注测试，不涉及新的数据模型。

### API Specifications

测试所有AI生成相关的API接口：
- POST /api/image-generation/text-to-image
- POST /api/image-generation/image-to-image
- GET /api/image-generation/tasks/{taskId}

### File Locations

**测试文件位置：**
```
backend/src/test/java/com/myshop/
├── service/
│   ├── AIGenerationServiceTest.java          # 单元测试（更新）
│   └── AIGenerationIntegrationTest.java      # 集成测试（新建）
└── performance/
    └── AIGenerationPerformanceTest.java      # 性能测试（新建）
```

### Technical Constraints

- **测试框架**: JUnit 5, Spring Boot Test, Mockito
- **性能测试**: 使用JMeter或类似工具
- **测试覆盖率**: > 80%
- **测试环境**: 使用测试配置，不调用真实API

### 测试策略

1. **单元测试**
   - Mock ImageModel
   - 测试各个方法
   - 测试错误处理

2. **集成测试**
   - 使用@SpringBootTest
   - Mock外部服务
   - 测试完整流程

3. **性能测试**
   - 使用JMeter或Gatling
   - 测试并发场景
   - 对比迁移前后性能

4. **对比测试**
   - 并行运行新旧实现
   - 对比响应格式
   - 对比性能指标

### Testing Requirements

- 使用JUnit 5进行单元测试和集成测试
- 使用Mockito Mock外部服务
- 使用Spring Boot Test进行集成测试
- 测试覆盖率 > 80%

## Testing

### Test File Location

测试文件应创建在：
- `backend/src/test/java/com/myshop/service/AIGenerationServiceTest.java`（更新）
- `backend/src/test/java/com/myshop/service/AIGenerationIntegrationTest.java`（新建）
- `backend/src/test/java/com/myshop/performance/AIGenerationPerformanceTest.java`（新建）

### Test Standards

- 使用JUnit 5和Spring Boot Test
- 使用Mockito Mock ImageModel和外部服务
- 使用@SpringBootTest进行集成测试
- 测试覆盖率 > 80%

### Test Scenarios

1. **单元测试场景**
   - 测试文生图正常调用
   - 测试图生图正常调用
   - 测试错误处理
   - 测试模型选择
   - 测试模型降级

2. **集成测试场景**
   - 测试文生图API接口
   - 测试图生图API接口
   - 测试任务状态查询接口
   - 测试错误响应

3. **性能测试场景**
   - 测试单次请求响应时间
   - 测试并发请求性能
   - 对比迁移前后性能

4. **错误场景测试**
   - 测试API Key错误
   - 测试网络超时
   - 测试模型服务不可用
   - 测试参数验证

5. **对比测试场景**
   - 并行运行新旧实现
   - 对比响应格式
   - 对比性能指标
   - 对比错误处理

### Success Criteria

- 单元测试覆盖率 > 80%
- 集成测试通过
- 性能测试通过（无明显下降）
- 错误场景测试通过
- 功能对比测试通过（功能一致性）
- 所有测试通过

## Change Log

| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2024-12-16 | 1.0 | 初始故事创建 | PM |

## Dev Agent Record

### Agent Model Used

_To be filled by Dev Agent_

### Debug Log References

_To be filled by Dev Agent_

### Completion Notes List

_To be filled by Dev Agent_

### File List

_To be filled by Dev Agent_

## QA Results

_To be filled by QA Agent_

