# Story 5.8: 微信支付集成

## Status

Draft

## Story

**As a** developer,
**I want** to integrate WeChat Pay API,
**so that** users can complete payment for their orders.

## Acceptance Criteria

1. 微信支付SDK已集成
2. 统一下单接口已实现
3. 支付回调接口已实现
4. 支付成功后更新订单状态
5. 支付失败处理完善
6. 支付参数签名验证

## Tasks / Subtasks

- [ ] Task 1: 集成微信支付SDK (AC: 1)
  - [ ] 添加微信支付SDK依赖（如weixin-java-pay）
  - [ ] 配置微信支付参数（appId、mchId、apiKey等）
  - [ ] 创建WeChatPayConfig配置类
- [ ] Task 2: 创建WeChatPayService (AC: 2, 6)
  - [ ] 创建WeChatPayService服务类
  - [ ] 实现统一下单方法
  - [ ] 构建统一下单请求参数
  - [ ] 调用微信支付统一下单API
  - [ ] 生成支付参数签名
  - [ ] 返回支付参数给前端
- [ ] Task 3: 实现支付回调接口 (AC: 3, 4, 6)
  - [ ] 创建PaymentController
  - [ ] 实现POST /api/payment/notify接口
  - [ ] 验证回调签名
  - [ ] 解析回调数据
  - [ ] 更新订单支付状态
  - [ ] 处理重复回调（幂等性）
  - [ ] 返回成功响应给微信
- [ ] Task 4: 订单状态更新 (AC: 4)
  - [ ] 支付成功后更新订单状态为PAID
  - [ ] 更新订单支付状态为PAID
  - [ ] 记录支付时间
- [ ] Task 5: 错误处理 (AC: 5)
  - [ ] 处理支付失败情况
  - [ ] 处理签名验证失败
  - [ ] 处理重复回调
  - [ ] 记录错误日志
- [ ] Task 6: 配置管理 (AC: 1)
  - [ ] 在application.yml中配置微信支付参数
  - [ ] 使用环境变量或配置中心管理敏感信息
  - [ ] 支持不同环境的配置

## Dev Notes

### Previous Story Insights

依赖Story 5.6（订单实体）和Story 5.7（创建订单API）完成，确保Order实体类和订单创建功能已实现。

### Data Models

使用Story 5.6创建的Order实体类。

**支付参数DTO：**
- WeChatPayParams: { appId, timeStamp, nonceStr, package, signType, paySign }

**回调数据：**
- 微信支付回调XML格式，包含订单号、支付状态、金额等信息

[Source: docs/fullstack-architecture.md#Order（订单）]

### API Specifications

**POST /api/payment/notify**
- 描述：微信支付回调接口
- 认证：不需要JWT Token（微信服务器调用）
- 请求体：XML格式的支付回调数据
- 响应：XML格式的成功响应

**业务逻辑：**
- 验证回调签名
- 解析回调数据
- 根据订单号查询订单
- 验证订单金额
- 更新订单支付状态和状态
- 处理重复回调（幂等性）
- 返回成功响应给微信

[Source: docs/fullstack-architecture.md#API Specification]

### File Locations

**后端文件位置：**
```
backend/src/main/java/com/myshop/
├── config/
│   └── WeChatPayConfig.java          # 微信支付配置
├── controller/
│   └── PaymentController.java       # 支付控制器
├── service/
│   └── WeChatPayService.java        # 微信支付服务
└── dto/
    └── WeChatPayParams.java          # 微信支付参数DTO
```

[Source: docs/fullstack-architecture.md#Repository Structure]

### Technical Constraints

- **支付SDK**: 使用微信官方SDK或第三方SDK（如weixin-java-pay）
- **签名验证**: 必须验证回调签名，确保安全性
- **幂等性**: 处理重复回调，避免重复更新订单状态
- **配置安全**: 敏感信息（如apiKey）应使用环境变量或配置中心管理

[Source: docs/fullstack-architecture.md#Tech Stack]

### Testing Requirements

- 使用JUnit 5进行单元测试
- 测试文件位置：`backend/src/test/java/com/myshop/service/WeChatPayServiceTest.java`
- 测试统一下单
- 测试签名生成
- 测试回调处理
- 测试幂等性

[Source: docs/fullstack-architecture.md#Tech Stack]

## Testing

### Test File Location

测试文件应创建在：`backend/src/test/java/com/myshop/service/WeChatPayServiceTest.java`

### Test Standards

- 使用JUnit 5和Spring Boot Test
- 使用Mockito Mock微信支付API调用
- 使用测试环境配置

### Test Scenarios

1. **统一下单测试**
   - 调用统一下单方法
   - 验证支付参数生成正确
   - 验证签名生成正确

2. **回调处理测试**
   - 模拟微信支付回调
   - 验证签名验证正确
   - 验证订单状态更新正确
   - 验证返回成功响应

3. **幂等性测试**
   - 发送相同的回调多次
   - 验证订单状态只更新一次
   - 验证每次都返回成功响应

4. **签名验证失败测试**
   - 发送签名错误的回调
   - 验证返回失败响应
   - 验证订单状态未更新

### Success Criteria

- 微信支付SDK集成成功
- 统一下单接口正常工作
- 支付回调接口正常工作
- 支付成功后订单状态正确更新
- 签名验证正确
- 幂等性处理正确

## Change Log

| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2024-12-15 | 1.0 | 初始故事创建 | Scrum Master |

## Dev Agent Record

### Agent Model Used

_To be filled by Dev Agent_

### Debug Log References

_To be filled by Dev Agent_

### Completion Notes List

_To be filled by Dev Agent_

### File List

_To be filled by Dev Agent_

## QA Results

_To be filled by QA Agent_

