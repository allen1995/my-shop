# Story 5.6: 订单实体和数据库设计

## Status

Draft

## Story

**As a** developer,
**I want** to create the Order entity and database schema,
**so that** orders can be stored and managed.

## Acceptance Criteria

1. Order实体类已创建，包含字段：id、userId、orderNo、status、totalAmount、items、addressId、paymentStatus、createTime、updateTime
2. OrderItem实体类已创建，包含订单项信息
3. OrderRepository接口已创建
4. 数据库表自动创建功能已配置
5. 订单状态枚举已定义（PENDING_PAYMENT、PAID、PROCESSING、SHIPPED、COMPLETED、CANCELLED）
6. 能够通过Repository进行订单的增删改查操作

## Tasks / Subtasks

- [ ] Task 1: 创建订单状态枚举 (AC: 5)
  - [ ] 创建OrderStatus枚举
  - [ ] 定义状态：PENDING_PAYMENT、PAID、PROCESSING、SHIPPED、COMPLETED、CANCELLED
- [ ] Task 2: 创建Order实体类 (AC: 1, 6)
  - [ ] 创建Order.java实体类
  - [ ] 添加JPA注解
  - [ ] 添加字段：id、userId、orderNo、status、totalAmount、addressId、paymentStatus、createTime、updateTime
  - [ ] 添加与OrderItem的一对多关系
  - [ ] 添加与User、Address的关联关系
  - [ ] 添加验证注解
  - [ ] 添加@PrePersist自动生成订单号
  - [ ] 添加@PrePersist和@PreUpdate自动设置时间
- [ ] Task 3: 创建OrderItem实体类 (AC: 2, 6)
  - [ ] 创建OrderItem.java实体类
  - [ ] 添加JPA注解
  - [ ] 添加字段：id、orderId、workId、productId、color、size、quantity、price、previewImageUrl
  - [ ] 添加与Order的多对一关系
  - [ ] 添加与Work、Product的关联关系
  - [ ] 添加验证注解
- [ ] Task 4: 创建OrderRepository接口 (AC: 3, 6)
  - [ ] 创建OrderRepository接口，继承JpaRepository
  - [ ] 添加findByUserId方法
  - [ ] 添加findByUserIdAndStatus方法
  - [ ] 添加findByOrderNo方法
- [ ] Task 5: 配置数据库自动创建 (AC: 4)
  - [ ] 确保application.yml中JPA配置正确
  - [ ] 验证数据库表能够自动创建
- [ ] Task 6: 创建单元测试 (AC: 6)
  - [ ] 创建OrderRepositoryTest
  - [ ] 测试保存订单
  - [ ] 测试查询订单
  - [ ] 测试按用户ID查询
  - [ ] 测试按状态查询

## Dev Notes

### Previous Story Insights

依赖Story 1.3（用户实体）、Story 3.1（作品实体）、Story 4.1（商品实体）、Story 9.2（地址实体）完成，确保相关实体类已创建。

### Data Models

**Order实体类字段定义：**
- id: Long - 订单ID，主键，自增
- userId: Long - 用户ID，外键，关联User
- orderNo: String - 订单号，唯一，自动生成（格式：ORDER + 时间戳 + 随机数）
- status: OrderStatus - 订单状态，枚举类型
- totalAmount: BigDecimal - 订单总金额
- addressId: Long - 收货地址ID，外键，关联Address
- paymentStatus: String - 支付状态（UNPAID、PAID、REFUNDED）
- createTime: LocalDateTime - 创建时间，自动设置
- updateTime: LocalDateTime - 更新时间，自动更新
- items: List<OrderItem> - 订单项列表，一对多关系

**OrderItem实体类字段定义：**
- id: Long - 订单项ID，主键，自增
- orderId: Long - 订单ID，外键，关联Order
- workId: Long - 作品ID，外键，关联Work
- productId: Long - 商品ID，外键，关联Product
- color: String - 选择的颜色
- size: String - 选择的尺寸
- quantity: Integer - 数量
- price: BigDecimal - 单价（下单时的价格）
- previewImageUrl: String - 预览图片URL

**订单状态枚举：**
- PENDING_PAYMENT: 待支付
- PAID: 已支付
- PROCESSING: 处理中
- SHIPPED: 已发货
- COMPLETED: 已完成
- CANCELLED: 已取消

**数据库表结构：**
```sql
CREATE TABLE orders (
    id BIGINT PRIMARY KEY AUTO_INCREMENT,
    user_id BIGINT NOT NULL,
    order_no VARCHAR(50) UNIQUE NOT NULL,
    status VARCHAR(20) NOT NULL,
    total_amount DECIMAL(10,2) NOT NULL,
    address_id BIGINT,
    payment_status VARCHAR(20) DEFAULT 'UNPAID',
    create_time TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    update_time TIMESTAMP DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP,
    FOREIGN KEY (user_id) REFERENCES users(id),
    FOREIGN KEY (address_id) REFERENCES addresses(id)
);

CREATE TABLE order_items (
    id BIGINT PRIMARY KEY AUTO_INCREMENT,
    order_id BIGINT NOT NULL,
    work_id BIGINT NOT NULL,
    product_id BIGINT NOT NULL,
    color VARCHAR(50),
    size VARCHAR(50),
    quantity INT NOT NULL,
    price DECIMAL(10,2) NOT NULL,
    preview_image_url VARCHAR(500),
    FOREIGN KEY (order_id) REFERENCES orders(id),
    FOREIGN KEY (work_id) REFERENCES works(id),
    FOREIGN KEY (product_id) REFERENCES products(id)
);
```

[Source: docs/fullstack-architecture.md#Order（订单）]

### API Specifications

本故事不涉及API接口，仅创建数据模型和Repository层。

### File Locations

**后端文件位置：**
```
backend/src/main/java/com/myshop/
├── entity/
│   ├── Order.java                    # 订单实体类
│   └── OrderItem.java                # 订单项实体类
├── enums/
│   └── OrderStatus.java              # 订单状态枚举
└── repository/
    └── OrderRepository.java         # 订单数据访问接口
```

[Source: docs/fullstack-architecture.md#Repository Structure]

### Technical Constraints

- **ORM框架**: Spring Data JPA
- **外键关联**: userId关联User，addressId关联Address，orderId关联Order
- **订单号生成**: 使用时间戳 + 随机数确保唯一性
- **价格存储**: 订单项价格需要保存下单时的价格，避免商品价格变化影响已下单的订单

[Source: docs/fullstack-architecture.md#Tech Stack]

### Testing Requirements

- 使用JUnit 5进行单元测试
- 测试文件位置：`backend/src/test/java/com/myshop/repository/OrderRepositoryTest.java`
- 测试Repository的CRUD操作
- 测试按用户ID查询
- 测试按状态查询
- 测试订单号唯一性

[Source: docs/fullstack-architecture.md#Tech Stack]

## Testing

### Test File Location

测试文件应创建在：`backend/src/test/java/com/myshop/repository/OrderRepositoryTest.java`

### Test Standards

- 使用JUnit 5和Spring Boot Test
- 使用@DataJpaTest进行Repository层测试
- 使用@Autowired注入Repository

### Test Scenarios

1. **创建订单测试**
   - 创建Order对象和OrderItem对象
   - 保存到数据库
   - 验证保存成功
   - 验证订单号自动生成

2. **查询订单测试**
   - 保存订单后查询
   - 验证查询结果正确
   - 验证关联的OrderItem正确加载

3. **按用户查询测试**
   - 创建多个用户的订单
   - 按userId查询
   - 验证只返回该用户的订单

4. **按状态查询测试**
   - 创建不同状态的订单
   - 按状态查询
   - 验证只返回指定状态的订单

5. **订单号唯一性测试**
   - 创建多个订单
   - 验证订单号唯一

### Success Criteria

- Order实体类创建成功
- OrderItem实体类创建成功
- OrderStatus枚举创建成功
- OrderRepository接口创建成功
- 数据库表自动创建成功
- 所有Repository方法测试通过

## Change Log

| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2024-12-15 | 1.0 | 初始故事创建 | Scrum Master |

## Dev Agent Record

### Agent Model Used

_To be filled by Dev Agent_

### Debug Log References

_To be filled by Dev Agent_

### Completion Notes List

_To be filled by Dev Agent_

### File List

_To be filled by Dev Agent_

## QA Results

_To be filled by QA Agent_

