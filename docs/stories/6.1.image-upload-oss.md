# Story 6.1: 图片上传到OSS

## Status

Draft

## Story

**As a** developer,
**I want** to implement image upload to OSS,
**so that** user-uploaded images can be stored and accessed.

## Acceptance Criteria

1. OSS SDK已集成
2. 图片上传方法已实现
3. 支持生成OSS签名URL供前端直传
4. 上传前进行图片压缩（可选）
5. 上传成功后返回图片URL
6. 错误处理完善

## Tasks / Subtasks

- [ ] Task 1: 集成OSS SDK (AC: 1)
  - [ ] 添加阿里云OSS SDK依赖
  - [ ] 配置OSS参数（endpoint、accessKeyId、accessKeySecret、bucketName）
  - [ ] 创建OssConfig配置类
- [ ] Task 2: 创建OssService (AC: 2, 5, 6)
  - [ ] 创建OssService服务类
  - [ ] 实现uploadImage方法
  - [ ] 支持文件流上传
  - [ ] 生成唯一文件名
  - [ ] 上传到OSS
  - [ ] 返回图片URL
  - [ ] 添加错误处理
- [ ] Task 3: 实现签名URL生成 (AC: 3)
  - [ ] 实现generatePresignedUrl方法
  - [ ] 生成OSS签名URL
  - [ ] 设置URL过期时间
  - [ ] 返回签名URL给前端
- [ ] Task 4: 实现图片压缩（可选）(AC: 4)
  - [ ] 添加图片压缩库依赖
  - [ ] 实现图片压缩方法
  - [ ] 在上传前压缩图片
  - [ ] 保持图片质量
- [ ] Task 5: 配置管理 (AC: 1)
  - [ ] 在application.yml中配置OSS参数
  - [ ] 使用环境变量管理敏感信息
  - [ ] 支持不同环境的配置

## Dev Notes

### Previous Story Insights

本故事是Epic 6的基础，为图生图功能提供图片存储能力。

### Data Models

**上传响应：**
- UploadResponse: { url: string }

**签名URL响应：**
- PresignedUrlResponse: { url: string, expiresIn: number }

[Source: docs/fullstack-architecture.md#OSS Service]

### API Specifications

**POST /api/image-generation/upload**
- 描述：上传图片到OSS
- 认证：需要JWT Token
- 请求体：multipart/form-data，包含file字段
- 响应：`{ url: string }`

**GET /api/image-generation/presigned-url**
- 描述：生成OSS签名URL（可选，用于前端直传）
- 认证：需要JWT Token
- 响应：`{ url: string, expiresIn: number }`

[Source: docs/fullstack-architecture.md#API Specification]

### File Locations

**后端文件位置：**
```
backend/src/main/java/com/myshop/
├── config/
│   └── OssConfig.java                # OSS配置
├── service/
│   └── OssService.java              # OSS服务
└── controller/
    └── ImageGenerationController.java # 图片上传控制器（扩展）
```

[Source: docs/fullstack-architecture.md#Repository Structure]

### Technical Constraints

- **OSS SDK**: 使用阿里云OSS Java SDK
- **文件命名**: 使用UUID或时间戳生成唯一文件名
- **文件路径**: 使用目录结构组织文件（如：uploads/{userId}/{timestamp}.jpg）
- **配置安全**: 敏感信息（如accessKeySecret）应使用环境变量管理

[Source: docs/fullstack-architecture.md#Tech Stack]

### Testing Requirements

- 使用JUnit 5进行单元测试
- 测试文件位置：`backend/src/test/java/com/myshop/service/OssServiceTest.java`
- 测试图片上传
- 测试签名URL生成
- 测试错误处理

[Source: docs/fullstack-architecture.md#Tech Stack]

## Testing

### Test File Location

测试文件应创建在：`backend/src/test/java/com/myshop/service/OssServiceTest.java`

### Test Standards

- 使用JUnit 5和Spring Boot Test
- 使用Mockito Mock OSS客户端
- 使用测试环境配置

### Test Scenarios

1. **图片上传测试**
   - 上传图片文件
   - 验证上传成功
   - 验证返回的URL正确
   - 验证文件在OSS中存在

2. **签名URL生成测试**
   - 生成签名URL
   - 验证URL格式正确
   - 验证URL可以访问
   - 验证URL过期时间正确

3. **错误处理测试**
   - 测试上传失败情况
   - 测试文件格式不支持
   - 测试文件大小超限
   - 验证返回友好的错误信息

### Success Criteria

- OSS SDK集成成功
- 图片上传功能正常工作
- 签名URL生成功能正常工作
- 错误处理完善

## Change Log

| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2024-12-15 | 1.0 | 初始故事创建 | Scrum Master |

## Dev Agent Record

### Agent Model Used

_To be filled by Dev Agent_

### Debug Log References

_To be filled by Dev Agent_

### Completion Notes List

_To be filled by Dev Agent_

### File List

_To be filled by Dev Agent_

## QA Results

_To be filled by QA Agent_

