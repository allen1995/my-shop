# Story 1.4: 微信登录API实现

## Status

Draft

## Story

**As a** user,
**I want** to log in using WeChat authorization,
**so that** I can access the application without creating a separate account.

## Acceptance Criteria

1. 后端提供 `/api/auth/wechat/login` 接口
2. 接口接收微信code参数
3. 接口调用微信API获取openId和sessionKey
4. 如果用户不存在则自动创建用户记录
5. 返回JWT token给前端
6. Token包含用户基本信息
7. 接口错误处理完善，返回友好的错误信息

## Tasks / Subtasks

- [ ] Task 1: 配置微信登录参数 (AC: 3)
  - [ ] 在application.yml中添加微信AppID和AppSecret配置
  - [ ] 创建WeChatConfig配置类
  - [ ] 使用@Value注入配置参数
- [ ] Task 2: 创建微信登录Service (AC: 3, 4)
  - [ ] 创建WeChatAuthService
  - [ ] 实现调用微信jscode2session API方法
  - [ ] 实现根据openId查询或创建用户逻辑
  - [ ] 处理微信API调用异常
- [ ] Task 3: 创建JWT工具类 (AC: 5, 6)
  - [ ] 添加JWT依赖（java-jwt或jjwt）
  - [ ] 创建JwtUtil工具类
  - [ ] 实现生成token方法（包含用户ID和基本信息）
  - [ ] 实现验证token方法
  - [ ] 配置JWT密钥和过期时间
- [ ] Task 4: 创建AuthController (AC: 1, 2, 7)
  - [ ] 创建AuthController
  - [ ] 实现POST /api/auth/wechat/login接口
  - [ ] 接收code参数并验证
  - [ ] 调用WeChatAuthService进行登录
  - [ ] 返回token和用户信息
  - [ ] 添加错误处理和异常捕获
- [ ] Task 5: 创建DTO类 (AC: 1, 2)
  - [ ] 创建WeChatLoginRequest DTO
  - [ ] 创建LoginResponse DTO
  - [ ] 添加参数验证注解
- [ ] Task 6: 创建单元测试 (AC: 1, 3, 4, 5)
  - [ ] 创建AuthControllerTest
  - [ ] 测试登录接口（Mock微信API）
  - [ ] 测试新用户自动创建
  - [ ] 测试已存在用户登录
  - [ ] 测试错误处理

## Dev Notes

### Previous Story Insights

依赖Story 1.3（用户实体和数据库设计）完成，确保User实体类和UserRepository已创建。

### Data Models

使用Story 1.3创建的User实体类。

**DTO类：**
- WeChatLoginRequest: { code: string }
- LoginResponse: { token: string, user: User }

[Source: docs/fullstack-architecture.md#User（用户）]

### API Specifications

**POST /api/auth/wechat/login**
- 描述：微信登录
- 请求体：`{ code: string }`
- 响应：`{ token: string, user: User }`
- 无需认证

**微信API调用：**
- 端点：`GET https://api.weixin.qq.com/sns/jscode2session`
- 参数：appid, secret, js_code, grant_type=authorization_code
- 响应：{ openid, session_key }

[Source: docs/fullstack-architecture.md#API Specification]
[Source: docs/fullstack-architecture.md#微信登录API]

### File Locations

**后端文件位置：**
```
backend/src/main/java/com/myshop/
├── controller/
│   └── AuthController.java          # 认证控制器
├── service/
│   └── WeChatAuthService.java       # 微信认证服务
├── config/
│   └── WeChatConfig.java            # 微信配置类
├── util/
│   └── JwtUtil.java                 # JWT工具类
└── dto/
    ├── WeChatLoginRequest.java      # 登录请求DTO
    └── LoginResponse.java           # 登录响应DTO
```

[Source: docs/fullstack-architecture.md#Repository Structure]

### Technical Constraints

- **JWT库**: java-jwt或jjwt
- **HTTP客户端**: Spring RestTemplate或WebClient（调用微信API）
- **配置管理**: 使用@Value或@ConfigurationProperties
- **错误处理**: 使用@ControllerAdvice统一异常处理

[Source: docs/fullstack-architecture.md#Tech Stack]

### Testing Requirements

- 使用JUnit 5和MockMvc进行Controller测试
- 使用Mockito Mock微信API调用
- 测试文件位置：`backend/src/test/java/com/myshop/controller/AuthControllerTest.java`
- 测试正常登录流程
- 测试新用户自动创建
- 测试错误处理

[Source: docs/fullstack-architecture.md#Tech Stack]

## Testing

### Test File Location

测试文件应创建在：`backend/src/test/java/com/myshop/controller/AuthControllerTest.java`

### Test Standards

- 使用JUnit 5和Spring Boot Test
- 使用MockMvc测试REST接口
- 使用Mockito Mock外部服务（微信API）

### Test Scenarios

1. **正常登录测试**
   - 发送有效的code
   - Mock微信API返回openId
   - 验证返回token和用户信息

2. **新用户自动创建测试**
   - 发送新用户的code
   - Mock微信API返回新的openId
   - 验证自动创建用户记录

3. **已存在用户登录测试**
   - 发送已存在用户的code
   - 验证返回已存在的用户信息

4. **错误处理测试**
   - 测试无效code
   - 测试微信API调用失败
   - 验证返回友好的错误信息

### Success Criteria

- 登录接口能够正常调用微信API
- 新用户能够自动创建
- 返回的token包含用户信息
- 错误处理完善

## Change Log

| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2024-12-15 | 1.0 | 初始故事创建 | Scrum Master |

## Dev Agent Record

### Agent Model Used

_To be filled by Dev Agent_

### Debug Log References

_To be filled by Dev Agent_

### Completion Notes List

_To be filled by Dev Agent_

### File List

_To be filled by Dev Agent_

## QA Results

_To be filled by QA Agent_

