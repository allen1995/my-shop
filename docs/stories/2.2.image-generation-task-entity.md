# Story 2.2: 图片生成任务实体和队列

## Status

Draft

## Story

**As a** developer,
**I want** to create image generation task entity and queue management,
**so that** generation requests can be tracked and managed.

## Acceptance Criteria

1. ImageGenerationTask实体已创建，包含字段：id、userId、prompt、parameters、status、resultUrl、errorMessage、createTime、updateTime
2. TaskRepository接口已创建
3. 任务状态枚举已定义（PENDING、PROCESSING、COMPLETED、FAILED）
4. 能够创建、查询、更新任务记录
5. 支持任务状态查询接口

## Tasks / Subtasks

- [ ] Task 1: 创建任务状态枚举 (AC: 3)
  - [ ] 创建TaskStatus枚举类
  - [ ] 定义状态：PENDING、PROCESSING、COMPLETED、FAILED
- [ ] Task 2: 创建ImageGenerationTask实体类 (AC: 1)
  - [ ] 创建ImageGenerationTask.java实体类
  - [ ] 添加JPA注解
  - [ ] 添加字段：id、userId、prompt、imageUrl（图生图）、parameters、taskType、status、resultUrl、errorMessage、createTime、updateTime
  - [ ] 添加@Enumerated注解处理状态枚举
  - [ ] 添加@PrePersist和@PreUpdate自动设置时间
- [ ] Task 3: 创建TaskRepository接口 (AC: 2, 4)
  - [ ] 创建ImageGenerationTaskRepository接口
  - [ ] 继承JpaRepository
  - [ ] 添加findByUserId方法
  - [ ] 添加findByUserIdAndStatus方法
- [ ] Task 4: 创建任务类型枚举 (AC: 1)
  - [ ] 创建TaskType枚举类
  - [ ] 定义类型：TEXT_TO_IMAGE、IMAGE_TO_IMAGE
- [ ] Task 5: 创建单元测试 (AC: 4, 5)
  - [ ] 创建ImageGenerationTaskRepositoryTest
  - [ ] 测试创建任务
  - [ ] 测试查询任务
  - [ ] 测试更新任务状态
  - [ ] 测试按用户和状态查询

## Dev Notes

### Previous Story Insights

依赖Story 1.3（用户实体和数据库设计）完成，确保User实体类已创建，用于关联userId。

### Data Models

**ImageGenerationTask实体类字段定义：**
- id: Long - 任务ID，主键，自增
- userId: Long - 用户ID，外键，关联User
- prompt: String - 提示词，不能为空
- imageUrl: String - 参考图片URL（图生图使用，可选）
- parameters: String - 生成参数（JSON格式）
- taskType: TaskType - 任务类型（TEXT_TO_IMAGE / IMAGE_TO_IMAGE）
- status: TaskStatus - 任务状态（PENDING / PROCESSING / COMPLETED / FAILED）
- resultUrl: String - 生成结果图片URL（可选）
- errorMessage: String - 错误信息（可选）
- createTime: LocalDateTime - 创建时间，自动设置
- updateTime: LocalDateTime - 更新时间，自动更新

**数据库表结构：**
```sql
CREATE TABLE image_generation_tasks (
    id BIGINT PRIMARY KEY AUTO_INCREMENT,
    user_id BIGINT NOT NULL,
    prompt TEXT NOT NULL,
    image_url VARCHAR(500),
    parameters TEXT,
    task_type VARCHAR(50) NOT NULL,
    status VARCHAR(50) NOT NULL,
    result_url VARCHAR(500),
    error_message TEXT,
    create_time TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    update_time TIMESTAMP DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP,
    FOREIGN KEY (user_id) REFERENCES users(id)
);
```

[Source: docs/fullstack-architecture.md#ImageGenerationTask（图片生成任务）]

### API Specifications

本故事不涉及API接口，仅创建数据模型和Repository层。任务状态查询接口在后续故事中实现。

### File Locations

**后端文件位置：**
```
backend/src/main/java/com/myshop/
├── entity/
│   ├── ImageGenerationTask.java    # 任务实体类
│   ├── TaskStatus.java             # 任务状态枚举
│   └── TaskType.java               # 任务类型枚举
└── repository/
    └── ImageGenerationTaskRepository.java  # 任务数据访问接口
```

[Source: docs/fullstack-architecture.md#Repository Structure]

### Technical Constraints

- **ORM框架**: Spring Data JPA
- **枚举处理**: 使用@Enumerated(EnumType.STRING)存储为字符串
- **JSON字段**: parameters字段存储JSON字符串，后续可考虑使用@Type注解支持JSON类型
- **外键关联**: userId关联User表

[Source: docs/fullstack-architecture.md#Tech Stack]

### Testing Requirements

- 使用JUnit 5进行单元测试
- 测试文件位置：`backend/src/test/java/com/myshop/repository/ImageGenerationTaskRepositoryTest.java`
- 测试Repository的CRUD操作
- 测试按用户和状态查询

[Source: docs/fullstack-architecture.md#Tech Stack]

## Testing

### Test File Location

测试文件应创建在：`backend/src/test/java/com/myshop/repository/ImageGenerationTaskRepositoryTest.java`

### Test Standards

- 使用JUnit 5和Spring Boot Test
- 使用@DataJpaTest进行Repository层测试
- 使用@Autowired注入Repository

### Test Scenarios

1. **创建任务测试**
   - 创建ImageGenerationTask对象
   - 保存到数据库
   - 验证保存成功

2. **查询任务测试**
   - 保存任务后查询
   - 验证查询结果正确

3. **按用户查询测试**
   - 创建多个用户的任务
   - 按userId查询
   - 验证只返回该用户的任务

4. **按状态查询测试**
   - 创建不同状态的任务
   - 按status查询
   - 验证查询结果正确

5. **更新任务状态测试**
   - 更新任务状态
   - 验证更新成功

### Success Criteria

- ImageGenerationTask实体类创建成功
- TaskRepository接口创建成功
- 任务状态和类型枚举定义成功
- 数据库表自动创建成功
- 所有Repository方法测试通过

## Change Log

| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2024-12-15 | 1.0 | 初始故事创建 | Scrum Master |

## Dev Agent Record

### Agent Model Used

_To be filled by Dev Agent_

### Debug Log References

_To be filled by Dev Agent_

### Completion Notes List

_To be filled by Dev Agent_

### File List

_To be filled by Dev Agent_

## QA Results

_To be filled by QA Agent_

