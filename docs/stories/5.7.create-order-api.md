# Story 5.7: 创建订单API

## Status

Draft

## Story

**As a** user,
**I want** to create an order from my cart,
**so that** I can proceed to payment.

## Acceptance Criteria

1. 后端提供 `/api/orders` POST接口
2. 接口接收cartItemIds和addressId参数
3. 验证购物车项属于当前用户
4. 计算订单总价
5. 创建订单和订单项记录
6. 清空购物车中的已下单项
7. 返回订单信息（包含订单号）
8. 接口包含参数验证和错误处理

## Tasks / Subtasks

- [ ] Task 1: 创建请求和响应DTO (AC: 2, 7)
  - [ ] 创建CreateOrderRequest DTO
  - [ ] 创建OrderResponse DTO
  - [ ] 添加参数验证注解
- [ ] Task 2: 创建OrderController (AC: 1, 2, 8)
  - [ ] 创建OrderController
  - [ ] 实现POST /api/orders接口
  - [ ] 接收并验证请求参数
  - [ ] 从UserContext获取当前用户ID
  - [ ] 调用Service层处理
  - [ ] 返回订单信息
  - [ ] 添加错误处理
- [ ] Task 3: 创建OrderService (AC: 3, 4, 5, 6)
  - [ ] 创建OrderService服务类
  - [ ] 实现createOrder方法
  - [ ] 验证购物车项存在且属于当前用户
  - [ ] 验证地址存在且属于当前用户
  - [ ] 查询购物车项和商品信息
  - [ ] 计算订单总价（使用商品当前价格）
  - [ ] 创建订单记录
  - [ ] 创建订单项记录（保存下单时的价格）
  - [ ] 删除已下单的购物车项
  - [ ] 返回订单信息
- [ ] Task 4: 实现参数验证 (AC: 8)
  - [ ] 验证cartItemIds不为空
  - [ ] 验证addressId不为空
  - [ ] 返回友好的验证错误信息
- [ ] Task 5: 事务管理 (AC: 5, 6)
  - [ ] 使用@Transactional确保订单创建和购物车删除的原子性
  - [ ] 处理异常回滚
- [ ] Task 6: 创建单元测试 (AC: 1, 2, 3, 4, 5, 6, 7, 8)
  - [ ] 创建OrderControllerTest
  - [ ] 测试创建订单
  - [ ] 测试参数验证
  - [ ] 测试权限验证
  - [ ] 测试事务回滚

## Dev Notes

### Previous Story Insights

依赖Story 5.1（购物车实体）、Story 5.6（订单实体）、Story 9.2（地址实体）和Story 1.6（JWT认证中间件）完成，确保相关实体类和UserContext已创建。

### Data Models

使用Story 5.6创建的Order和OrderItem实体类。

**请求DTO：**
- CreateOrderRequest: { cartItemIds: number[], addressId: number }

**响应DTO：**
- OrderResponse: { id, orderNo, status, totalAmount, items, addressId, paymentStatus, createTime }

[Source: docs/fullstack-architecture.md#Order（订单）]

### API Specifications

**POST /api/orders**
- 描述：创建订单
- 认证：需要JWT Token
- 请求体：`{ cartItemIds: number[], addressId: number }`
- 响应：`{ order: OrderResponse }`

**业务逻辑：**
- 验证购物车项存在且属于当前用户
- 验证地址存在且属于当前用户
- 查询购物车项和商品信息
- 计算订单总价（商品价格 × 数量）
- 创建订单记录（状态为PENDING_PAYMENT）
- 创建订单项记录（保存下单时的商品价格）
- 删除已下单的购物车项
- 返回订单信息（包含订单号）

[Source: docs/fullstack-architecture.md#API Specification]

### File Locations

**后端文件位置：**
```
backend/src/main/java/com/myshop/
├── controller/
│   └── OrderController.java          # 订单控制器
├── service/
│   └── OrderService.java              # 订单服务
└── dto/
    ├── CreateOrderRequest.java        # 创建订单请求DTO
    └── OrderResponse.java             # 订单响应DTO
```

[Source: docs/fullstack-architecture.md#Repository Structure]

### Technical Constraints

- **用户身份**: 从UserContext获取当前用户ID
- **事务管理**: 使用@Transactional确保订单创建和购物车删除的原子性
- **价格保存**: 订单项需要保存下单时的商品价格，避免价格变化影响已下单的订单
- **参数验证**: 使用Bean Validation注解

[Source: docs/fullstack-architecture.md#Tech Stack]

### Testing Requirements

- 使用JUnit 5和MockMvc进行Controller测试
- 测试文件位置：`backend/src/test/java/com/myshop/controller/OrderControllerTest.java`
- 测试创建订单
- 测试参数验证
- 测试权限验证
- 测试事务回滚

[Source: docs/fullstack-architecture.md#Tech Stack]

## Testing

### Test File Location

测试文件应创建在：`backend/src/test/java/com/myshop/controller/OrderControllerTest.java`

### Test Standards

- 使用JUnit 5和Spring Boot Test
- 使用MockMvc测试REST接口
- 使用Mockito Mock依赖

### Test Scenarios

1. **正常创建订单测试**
   - 创建购物车项和地址
   - 调用创建订单接口
   - 验证订单创建成功
   - 验证订单项创建成功
   - 验证购物车项已删除
   - 验证订单总价计算正确

2. **参数验证测试**
   - 测试cartItemIds为空
   - 测试addressId为空
   - 验证返回验证错误信息

3. **权限验证测试**
   - 尝试使用其他用户的购物车项创建订单
   - 尝试使用其他用户的地址创建订单
   - 验证返回403或404错误

4. **事务回滚测试**
   - 模拟订单创建过程中发生异常
   - 验证订单和订单项都未创建
   - 验证购物车项未被删除

### Success Criteria

- 创建订单接口能够正常工作
- 订单和订单项正确创建
- 购物车项正确删除
- 订单总价计算正确
- 权限验证正确
- 事务管理正确

## Change Log

| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2024-12-15 | 1.0 | 初始故事创建 | Scrum Master |

## Dev Agent Record

### Agent Model Used

_To be filled by Dev Agent_

### Debug Log References

_To be filled by Dev Agent_

### Completion Notes List

_To be filled by Dev Agent_

### File List

_To be filled by Dev Agent_

## QA Results

_To be filled by QA Agent_

