# Story 1.3: 用户实体和数据库设计

## Status

Draft

## Story

**As a** developer,
**I want** to create the User entity and database schema,
**so that** user information can be stored and managed.

## Acceptance Criteria

1. User实体类已创建，包含字段：id、openId、nickName、avatarUrl、phone、createTime、updateTime
2. UserRepository接口已创建
3. 数据库表自动创建功能已配置
4. 能够通过Repository进行用户的增删改查操作
5. 实体类包含必要的验证注解

## Tasks / Subtasks

- [ ] Task 1: 创建User实体类 (AC: 1, 5)
  - [ ] 创建User.java实体类
  - [ ] 添加JPA注解（@Entity, @Table, @Id, @GeneratedValue）
  - [ ] 添加字段：id, openId, nickName, avatarUrl, phone, createTime, updateTime
  - [ ] 添加验证注解（@NotBlank, @Size等）
  - [ ] 添加@PrePersist和@PreUpdate自动设置时间
- [ ] Task 2: 创建UserRepository接口 (AC: 2, 4)
  - [ ] 创建UserRepository接口，继承JpaRepository
  - [ ] 添加findByOpenId方法（用于登录时查找用户）
  - [ ] 验证Repository方法可用
- [ ] Task 3: 配置数据库自动创建 (AC: 3)
  - [ ] 在application.yml中配置JPA属性
  - [ ] 设置spring.jpa.hibernate.ddl-auto=update
  - [ ] 验证数据库表能够自动创建
- [ ] Task 4: 创建单元测试 (AC: 4)
  - [ ] 创建UserRepositoryTest
  - [ ] 测试保存用户
  - [ ] 测试查询用户
  - [ ] 测试更新用户
  - [ ] 测试删除用户
  - [ ] 测试findByOpenId方法

## Dev Notes

### Previous Story Insights

依赖Story 1.1（后端项目初始化）完成，确保Spring Boot项目和H2数据库已配置。

### Data Models

**User实体类字段定义：**
- id: Long - 用户ID，主键，自增
- openId: String - 微信openId，唯一标识，不能为空
- nickName: String - 用户昵称
- avatarUrl: String - 头像URL
- phone: String - 手机号（可选）
- createTime: LocalDateTime - 创建时间，自动设置
- updateTime: LocalDateTime - 更新时间，自动更新

**数据库表结构：**
```sql
CREATE TABLE users (
    id BIGINT PRIMARY KEY AUTO_INCREMENT,
    open_id VARCHAR(100) UNIQUE NOT NULL,
    nick_name VARCHAR(100),
    avatar_url VARCHAR(500),
    phone VARCHAR(20),
    create_time TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    update_time TIMESTAMP DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP
);
```

[Source: docs/fullstack-architecture.md#User（用户）]

### API Specifications

本故事不涉及API接口，仅创建数据模型和Repository层。

### File Locations

**后端文件位置：**
```
backend/src/main/java/com/myshop/
├── entity/
│   └── User.java                    # 用户实体类
└── repository/
    └── UserRepository.java          # 用户数据访问接口
```

[Source: docs/fullstack-architecture.md#Repository Structure]

### Technical Constraints

- **ORM框架**: Spring Data JPA
- **数据库**: H2（开发环境）
- **实体类注解**: JPA标准注解（@Entity, @Table, @Id等）
- **时间字段**: 使用LocalDateTime，通过@PrePersist和@PreUpdate自动设置

[Source: docs/fullstack-architecture.md#Tech Stack]

### Testing Requirements

- 使用JUnit 5进行单元测试
- 测试文件位置：`backend/src/test/java/com/myshop/repository/UserRepositoryTest.java`
- 测试Repository的CRUD操作
- 测试findByOpenId方法

[Source: docs/fullstack-architecture.md#Tech Stack]

## Testing

### Test File Location

测试文件应创建在：`backend/src/test/java/com/myshop/repository/UserRepositoryTest.java`

### Test Standards

- 使用JUnit 5和Spring Boot Test
- 使用@DataJpaTest进行Repository层测试
- 使用@Autowired注入Repository

### Test Scenarios

1. **保存用户测试**
   - 创建User对象
   - 保存到数据库
   - 验证保存成功

2. **查询用户测试**
   - 保存用户后查询
   - 验证查询结果正确

3. **findByOpenId测试**
   - 保存用户后通过openId查询
   - 验证查询结果正确

4. **更新用户测试**
   - 更新用户信息
   - 验证更新成功

5. **删除用户测试**
   - 删除用户
   - 验证删除成功

### Success Criteria

- User实体类创建成功
- UserRepository接口创建成功
- 数据库表自动创建成功
- 所有Repository方法测试通过

## Change Log

| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2024-12-15 | 1.0 | 初始故事创建 | Scrum Master |

## Dev Agent Record

### Agent Model Used

_To be filled by Dev Agent_

### Debug Log References

_To be filled by Dev Agent_

### Completion Notes List

_To be filled by Dev Agent_

### File List

_To be filled by Dev Agent_

## QA Results

_To be filled by QA Agent_

