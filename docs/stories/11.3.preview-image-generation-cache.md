# Story 11.3: 预览图片生成和缓存

## Status

Draft

## Story

**As a** user,
**I want** the preview image to be generated and cached,
**so that** I can quickly see the final effect when adding to cart.

## Acceptance Criteria

1. 使用uni.canvasToTempFilePath生成预览图片
2. 预览图片生成时间小于1秒
3. 生成的预览图片用于添加到购物车
4. 支持预览图片缓存，避免重复生成
5. 预览图片质量满足展示需求（分辨率不低于750x750）

## Tasks / Subtasks

- [ ] Task 1: 实现预览图片生成 (AC: 1, 2)
  - [ ] 使用uni.canvasToTempFilePath生成预览图片
  - [ ] 设置合适的图片质量（quality: 0.8-0.9）
  - [ ] 设置合适的图片格式（fileType: 'png'或'jpg'）
  - [ ] 优化生成时间，确保小于1秒

- [ ] Task 2: 实现预览图片缓存 (AC: 4)
  - [ ] 使用Map缓存生成的预览图片（key: 参数组合）
  - [ ] 缓存key包含：workId、productId、color、size、position、scale
  - [ ] 检查缓存，如果存在则直接使用
  - [ ] 实现缓存清理机制（内存管理）

- [ ] Task 3: 集成到购物车流程 (AC: 3)
  - [ ] 在加入购物车前生成预览图片
  - [ ] 将预览图片URL传递给购物车API
  - [ ] 处理生成失败的情况（使用临时预览或原图）

- [ ] Task 4: 优化图片质量 (AC: 5)
  - [ ] 设置合适的Canvas尺寸（至少750x750）
  - [ ] 设置合适的图片质量参数
  - [ ] 验证生成的图片质量满足展示需求

- [ ] Task 5: 性能优化
  - [ ] 使用异步生成（不阻塞UI）
  - [ ] 显示生成进度提示
  - [ ] 优化Canvas绘制性能

## Dev Notes

### Previous Story Insights

依赖Story 11.1（Canvas 2D实时预览实现）和Story 11.2（印花位置和大小调整交互）完成，确保Canvas已能正常绘制。

### Data Models

**预览图片缓存：**
```typescript
interface PreviewImageCache {
  key: string;                // 缓存key（参数组合的hash）
  imageUrl: string;           // 预览图片URL
  timestamp: number;          // 生成时间戳
}

// 缓存key生成
const generateCacheKey = (params: {
  workId: number;
  productId: number;
  color: string;
  size: string;
  position: { x: number, y: number };
  scale: number;
}) => {
  return `${params.workId}-${params.productId}-${params.color}-${params.size}-${params.position.x}-${params.position.y}-${params.scale}`
}
```

### API Specifications

**加入购物车API（更新）：**
- POST /api/cart/add
- 请求参数中需要包含previewImageUrl
- 如果previewImageUrl为空，使用原图

### File Locations

**前端文件位置：**
```
frontend/
├── pages/
│   └── preview/
│       └── preview.vue               # 印花预览页面（更新）
└── utils/
    └── preview-cache.js               # 预览图片缓存工具（新建）
```

### Technical Constraints

- **Canvas API**: 使用uni.canvasToTempFilePath
- **图片质量**: quality 0.8-0.9，平衡质量和文件大小
- **图片格式**: PNG（支持透明）或JPG（文件更小）
- **性能**: 生成时间小于1秒
- **缓存**: 使用内存缓存，注意内存管理

### 预览图片生成流程

```javascript
const generatePreviewImage = async () => {
  // 1. 检查缓存
  const cacheKey = generateCacheKey(currentParams)
  if (previewCache.has(cacheKey)) {
    return previewCache.get(cacheKey)
  }
  
  // 2. 生成预览图片
  uni.canvasToTempFilePath({
    canvasId: 'preview-canvas',
    fileType: 'png',
    quality: 0.9,
    success: (res) => {
      // 3. 缓存预览图片
      previewCache.set(cacheKey, res.tempFilePath)
      
      // 4. 返回预览图片URL
      return res.tempFilePath
    },
    fail: (err) => {
      console.error('预览图片生成失败', err)
      // 降级：使用原图
      return workImageUrl
    }
  })
}
```

### 缓存管理

```javascript
class PreviewImageCache {
  constructor(maxSize = 10) {
    this.cache = new Map()
    this.maxSize = maxSize
  }
  
  set(key, value) {
    // 如果缓存已满，删除最旧的
    if (this.cache.size >= this.maxSize) {
      const firstKey = this.cache.keys().next().value
      this.cache.delete(firstKey)
    }
    this.cache.set(key, value)
  }
  
  get(key) {
    return this.cache.get(key)
  }
  
  has(key) {
    return this.cache.has(key)
  }
  
  clear() {
    this.cache.clear()
  }
}
```

### Testing Requirements

前端测试暂不实施，主要进行手动验证：
- 验证预览图片生成
- 验证缓存功能
- 验证性能

## Testing

### Test File Location

前端测试暂不实施，后续添加。

### Test Standards

当前阶段主要进行手动验证：
- 在微信开发者工具中测试预览图片生成
- 验证生成时间
- 验证图片质量
- 验证缓存功能

### Test Scenarios

1. **预览图片生成测试**
   - 点击生成预览图片
   - 验证生成成功
   - 验证生成时间小于1秒
   - 验证图片质量满足要求

2. **缓存功能测试**
   - 生成预览图片
   - 修改参数后再次生成
   - 恢复原参数，验证使用缓存
   - 验证缓存命中率

3. **购物车集成测试**
   - 生成预览图片后加入购物车
   - 验证预览图片URL正确传递
   - 验证购物车中显示预览图片

4. **性能测试**
   - 验证生成时间小于1秒
   - 验证缓存命中时响应时间
   - 验证内存使用正常

### Success Criteria

- 预览图片生成功能正常
- 生成时间小于1秒
- 缓存功能正常
- 图片质量满足要求
- 购物车集成正常

## Change Log

| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2024-12-16 | 1.0 | 初始故事创建 | PM |

## Dev Agent Record

### Agent Model Used

_To be filled by Dev Agent_

### Debug Log References

_To be filled by Dev Agent_

### Completion Notes List

_To be filled by Dev Agent_

### File List

_To be filled by Dev Agent_

## QA Results

_To be filled by QA Agent_

