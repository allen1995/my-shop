# Story 5.2: 添加到购物车API

## Status

Draft

## Story

**As a** user,
**I want** to add a work to my shopping cart,
**so that** I can purchase it later.

## Acceptance Criteria

1. 后端提供 `/api/cart/items` POST接口
2. 接口接收workId、productId、color、size、quantity、previewImageUrl参数
3. 创建购物车项记录
4. 如果相同商品已存在，则更新数量
5. 返回购物车项信息
6. 接口包含参数验证和错误处理

## Tasks / Subtasks

- [ ] Task 1: 创建请求和响应DTO (AC: 2, 5)
  - [ ] 创建AddToCartRequest DTO
  - [ ] 创建CartItemResponse DTO
  - [ ] 添加参数验证注解
- [ ] Task 2: 创建CartController (AC: 1, 2, 6)
  - [ ] 创建CartController
  - [ ] 实现POST /api/cart/items接口
  - [ ] 接收并验证请求参数
  - [ ] 从UserContext获取当前用户ID
  - [ ] 调用Service层处理
  - [ ] 返回购物车项信息
  - [ ] 添加错误处理
- [ ] Task 3: 创建CartService (AC: 3, 4)
  - [ ] 创建CartService服务类
  - [ ] 实现addToCart方法
  - [ ] 检查是否存在相同的购物车项（相同用户、作品、商品、颜色、尺寸）
  - [ ] 如果存在，更新数量；如果不存在，创建新记录
  - [ ] 返回购物车项信息
- [ ] Task 4: 实现参数验证 (AC: 6)
  - [ ] 验证workId、productId不能为空
  - [ ] 验证quantity大于0
  - [ ] 返回友好的验证错误信息
- [ ] Task 5: 创建单元测试 (AC: 1, 2, 3, 4, 6)
  - [ ] 创建CartControllerTest
  - [ ] 测试添加到购物车
  - [ ] 测试相同商品更新数量
  - [ ] 测试参数验证

## Dev Notes

### Previous Story Insights

依赖Story 5.1（购物车实体和数据库设计）和Story 1.6（JWT认证中间件）完成，确保CartItem实体类和UserContext已创建。

### Data Models

使用Story 5.1创建的CartItem实体类。

**请求DTO：**
- AddToCartRequest: { workId: number, productId: number, color: string, size: string, quantity: number, previewImageUrl: string }

**响应DTO：**
- CartItemResponse: { id, userId, workId, productId, color, size, quantity, previewImageUrl, createTime, updateTime }

[Source: docs/fullstack-architecture.md#CartItem（购物车项）]

### API Specifications

**POST /api/cart/items**
- 描述：添加到购物车
- 认证：需要JWT Token
- 请求体：`{ workId: number, productId: number, color: string, size: string, quantity: number, previewImageUrl: string }`
- 响应：`{ cartItem: CartItem }`

**业务逻辑：**
- 如果相同用户、作品、商品、颜色、尺寸的购物车项已存在，则更新数量（累加）
- 否则创建新的购物车项

[Source: docs/fullstack-architecture.md#API Specification]

### File Locations

**后端文件位置：**
```
backend/src/main/java/com/myshop/
├── controller/
│   └── CartController.java           # 购物车控制器
├── service/
│   └── CartService.java              # 购物车服务
└── dto/
    ├── AddToCartRequest.java         # 添加到购物车请求DTO
    └── CartItemResponse.java         # 购物车项响应DTO
```

[Source: docs/fullstack-architecture.md#Repository Structure]

### Technical Constraints

- **用户身份**: 从UserContext获取当前用户ID
- **重复项处理**: 相同组合的购物车项应该合并数量
- **参数验证**: 使用Bean Validation注解

[Source: docs/fullstack-architecture.md#Tech Stack]

### Testing Requirements

- 使用JUnit 5和MockMvc进行Controller测试
- 测试文件位置：`backend/src/test/java/com/myshop/controller/CartControllerTest.java`
- 测试正常添加
- 测试重复项合并
- 测试参数验证

[Source: docs/fullstack-architecture.md#Tech Stack]

## Testing

### Test File Location

测试文件应创建在：`backend/src/test/java/com/myshop/controller/CartControllerTest.java`

### Test Standards

- 使用JUnit 5和Spring Boot Test
- 使用MockMvc测试REST接口
- 使用Mockito Mock依赖

### Test Scenarios

1. **正常添加到购物车测试**
   - 发送有效的购物车项信息
   - 验证创建成功
   - 验证返回信息正确

2. **重复项合并测试**
   - 添加相同的购物车项
   - 验证数量累加
   - 验证不创建新记录

3. **参数验证测试**
   - 测试必填参数为空
   - 测试quantity小于等于0
   - 验证返回验证错误信息

### Success Criteria

- 添加到购物车接口能够正常创建购物车项
- 重复项能够正确合并数量
- 参数验证正确
- 错误处理完善

## Change Log

| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2024-12-15 | 1.0 | 初始故事创建 | Scrum Master |

## Dev Agent Record

### Agent Model Used

_To be filled by Dev Agent_

### Debug Log References

_To be filled by Dev Agent_

### Completion Notes List

_To be filled by Dev Agent_

### File List

_To be filled by Dev Agent_

## QA Results

_To be filled by QA Agent_

