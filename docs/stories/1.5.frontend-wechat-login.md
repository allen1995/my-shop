# Story 1.5: 前端微信登录实现

## Status

Draft

## Story

**As a** user,
**I want** to log in with one click using WeChat on the frontend,
**so that** I can quickly access the application.

## Acceptance Criteria

1. 登录页面已创建
2. 调用微信 `wx.login()` 获取code
3. 调用后端登录接口获取token
4. Token存储到本地（uni.setStorage）
5. 登录成功后跳转到首页
6. 登录状态持久化，下次打开自动登录
7. 登录失败时显示错误提示

## Tasks / Subtasks

- [ ] Task 1: 创建登录页面 (AC: 1)
  - [ ] 创建pages/login/login.vue
  - [ ] 设计登录页面UI（使用uView UI组件）
  - [ ] 添加"微信登录"按钮
- [ ] Task 2: 实现微信登录功能 (AC: 2, 3, 4)
  - [ ] 在登录页面调用wx.login()获取code
  - [ ] 调用后端/api/auth/wechat/login接口
  - [ ] 接收token和用户信息
  - [ ] 使用uni.setStorage存储token
  - [ ] 更新userStore中的用户状态
- [ ] Task 3: 实现登录状态管理 (AC: 6)
  - [ ] 在App.vue的onLaunch中检查token
  - [ ] 如果token存在，验证token有效性（可选）
  - [ ] 如果token无效或不存在，跳转到登录页
  - [ ] 如果token有效，更新userStore状态
- [ ] Task 4: 实现登录跳转 (AC: 5)
  - [ ] 登录成功后使用uni.switchTab跳转到首页
  - [ ] 处理跳转异常
- [ ] Task 5: 实现错误处理 (AC: 7)
  - [ ] 捕获登录失败异常
  - [ ] 使用uni.showToast显示错误提示
  - [ ] 处理网络错误
  - [ ] 处理微信登录失败
- [ ] Task 6: 创建登录API封装 (AC: 3)
  - [ ] 在api/auth.js中创建login方法
  - [ ] 封装登录接口调用
  - [ ] 处理响应数据

## Dev Notes

### Previous Story Insights

依赖Story 1.4（微信登录API实现）完成，确保后端登录接口可用。同时依赖Story 1.2（前端项目初始化）完成，确保项目结构和网络请求封装已就绪。

### Data Models

**登录请求：**
```typescript
interface WeChatLoginRequest {
  code: string;
}
```

**登录响应：**
```typescript
interface LoginResponse {
  token: string;
  user: User;
}
```

[Source: docs/fullstack-architecture.md#API Specification]

### API Specifications

**POST /api/auth/wechat/login**
- 请求体：`{ code: string }`
- 响应：`{ token: string, user: User }`

前端需要：
- 调用wx.login()获取code
- 调用后端登录接口
- 存储token到本地
- 更新用户状态

[Source: docs/fullstack-architecture.md#API Specification]

### File Locations

**前端文件位置：**
```
frontend/
├── pages/
│   └── login/
│       └── login.vue                 # 登录页面
├── api/
│   └── auth.js                      # 认证API封装
├── store/
│   └── user.js                      # 用户状态管理（更新）
└── App.vue                          # 应用入口（更新）
```

[Source: docs/fullstack-architecture.md#Repository Structure]

### Technical Constraints

- **微信API**: 使用wx.login()获取code（小程序环境）
- **存储**: 使用uni.setStorage存储token
- **导航**: 使用uni.switchTab跳转到TabBar页面
- **状态管理**: 使用Pinia的userStore管理用户状态

[Source: docs/fullstack-architecture.md#Tech Stack]

### Testing Requirements

前端测试暂不实施，主要进行手动验证：
- 验证登录页面显示
- 验证微信登录功能
- 验证token存储
- 验证登录状态持久化

[Source: docs/fullstack-architecture.md#Tech Stack]

## Testing

### Test File Location

前端测试暂不实施，后续添加。

### Test Standards

当前阶段主要进行手动验证：
- 在微信开发者工具中测试登录流程
- 验证token存储和读取
- 验证登录状态持久化

### Test Scenarios

1. **登录流程测试**
   - 点击"微信登录"按钮
   - 验证调用wx.login()成功
   - 验证调用后端接口成功
   - 验证token存储成功
   - 验证跳转到首页

2. **登录状态持久化测试**
   - 登录成功后关闭小程序
   - 重新打开小程序
   - 验证自动登录（无需再次登录）

3. **错误处理测试**
   - 测试网络错误
   - 测试微信登录失败
   - 验证错误提示显示

### Success Criteria

- 登录页面能够正常显示
- 微信登录功能正常
- Token能够正确存储和读取
- 登录状态能够持久化
- 错误提示友好

## Change Log

| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2024-12-15 | 1.0 | 初始故事创建 | Scrum Master |

## Dev Agent Record

### Agent Model Used

_To be filled by Dev Agent_

### Debug Log References

_To be filled by Dev Agent_

### Completion Notes List

_To be filled by Dev Agent_

### File List

_To be filled by Dev Agent_

## QA Results

_To be filled by QA Agent_

