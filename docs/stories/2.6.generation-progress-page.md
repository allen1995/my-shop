# Story 2.6: 生成进度显示页面

## Status

Draft

## Story

**As a** user,
**I want** to see the progress of image generation,
**so that** I know how long I need to wait.

## Acceptance Criteria

1. 生成进度页面已创建
2. 显示生成进度条和预计剩余时间
3. 轮询后端接口获取任务状态
4. 任务完成时自动跳转到结果页面
5. 任务失败时显示错误信息，支持重试
6. 支持取消生成操作
7. 页面包含加载动画，提升用户体验

## Tasks / Subtasks

- [ ] Task 1: 创建生成进度页面 (AC: 1)
  - [ ] 创建pages/generate/generating.vue
  - [ ] 设计页面布局（进度条、状态提示）
- [ ] Task 2: 实现进度显示 (AC: 2)
  - [ ] 添加进度条组件（使用uView UI）
  - [ ] 显示当前进度百分比
  - [ ] 显示预计剩余时间（可选）
  - [ ] 显示状态文字（生成中、已完成、失败）
- [ ] Task 3: 实现轮询机制 (AC: 3, 4, 5)
  - [ ] 在onLoad中接收taskId参数
  - [ ] 实现轮询函数，每2-3秒查询一次任务状态
  - [ ] 使用setInterval或setTimeout实现
  - [ ] 任务完成时停止轮询，跳转到结果页
  - [ ] 任务失败时停止轮询，显示错误信息
- [ ] Task 4: 实现重试功能 (AC: 5)
  - [ ] 添加"重试"按钮（失败时显示）
  - [ ] 实现重试逻辑（返回文生图页面或重新生成）
- [ ] Task 5: 实现取消功能 (AC: 6)
  - [ ] 添加"取消"按钮
  - [ ] 实现取消逻辑（停止轮询，返回上一页）
  - [ ] 可选：调用后端取消接口（如果支持）
- [ ] Task 6: 优化用户体验 (AC: 7)
  - [ ] 添加加载动画
  - [ ] 优化页面过渡效果
  - [ ] 添加提示信息
- [ ] Task 7: 创建API封装 (AC: 3)
  - [ ] 在api/imageGeneration.js中创建getTaskStatus方法
  - [ ] 封装任务状态查询接口

## Dev Notes

### Previous Story Insights

依赖Story 2.4（生成进度查询接口）和Story 2.5（前端文生图页面）完成，确保后端接口可用，能够接收taskId参数。

### Data Models

**任务状态响应：**
```typescript
interface TaskStatusResponse {
  taskId: number;
  status: 'PENDING' | 'PROCESSING' | 'COMPLETED' | 'FAILED';
  progress: number;
  resultUrl?: string;
  errorMessage?: string;
}
```

[Source: docs/fullstack-architecture.md#ImageGenerationTask（图片生成任务）]

### API Specifications

**GET /api/image-generation/tasks/{taskId}**
- 响应：`{ taskId, status, progress, resultUrl, errorMessage }`

前端需要：
- 轮询调用此接口
- 根据status判断任务状态
- COMPLETED时跳转到结果页（传递resultUrl）
- FAILED时显示错误信息

[Source: docs/fullstack-architecture.md#API Specification]

### File Locations

**前端文件位置：**
```
frontend/
├── pages/
│   └── generate/
│       └── generating.vue           # 生成进度页面
└── api/
    └── imageGeneration.js           # 图片生成API封装（更新）
```

[Source: docs/fullstack-architecture.md#Repository Structure]

### Technical Constraints

- **轮询间隔**: 建议2-3秒，避免过于频繁
- **性能优化**: 页面离开时清除定时器
- **导航**: 使用uni.navigateTo跳转到结果页
- **动画**: 使用uView UI的加载组件或自定义动画

[Source: docs/fullstack-architecture.md#Tech Stack]

### Testing Requirements

前端测试暂不实施，主要进行手动验证：
- 验证进度显示
- 验证轮询机制
- 验证自动跳转
- 验证错误处理

[Source: docs/fullstack-architecture.md#Tech Stack]

## Testing

### Test File Location

前端测试暂不实施，后续添加。

### Test Standards

当前阶段主要进行手动验证：
- 在微信开发者工具中测试进度页面
- 验证轮询功能
- 验证自动跳转

### Test Scenarios

1. **进度显示测试**
   - 进入进度页面
   - 验证进度条显示
   - 验证状态文字显示

2. **轮询机制测试**
   - 验证每2-3秒查询一次
   - 验证任务状态更新
   - 验证页面离开时清除定时器

3. **自动跳转测试**
   - 任务完成时验证自动跳转到结果页
   - 验证传递resultUrl参数

4. **错误处理测试**
   - 任务失败时验证显示错误信息
   - 验证重试功能

5. **取消功能测试**
   - 点击取消按钮
   - 验证停止轮询
   - 验证返回上一页

### Success Criteria

- 生成进度页面能够正常显示
- 进度条和状态显示正确
- 轮询机制正常工作
- 自动跳转功能正常
- 错误处理和重试功能正常
- 用户体验良好

## Change Log

| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2024-12-15 | 1.0 | 初始故事创建 | Scrum Master |

## Dev Agent Record

### Agent Model Used

_To be filled by Dev Agent_

### Debug Log References

_To be filled by Dev Agent_

### Completion Notes List

_To be filled by Dev Agent_

### File List

_To be filled by Dev Agent_

## QA Results

_To be filled by QA Agent_

