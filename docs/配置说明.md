# 项目配置说明

本文档详细说明项目运行前需要修改的所有配置项。

## 一、后端配置 (backend/src/main/resources/application.yml)

### 1. JWT配置（必须修改）

```yaml
app:
  jwt:
    secret: ${JWT_SECRET:your-secret-key-change-in-production}  # ⚠️ 必须修改为强密码
    expiration: 604800000  # Token过期时间（7天，单位：毫秒）
```

**修改方式：**
- 方式1：在系统环境变量中设置 `JWT_SECRET`
- 方式2：直接修改配置文件中的默认值（不推荐用于生产环境）

**建议值：** 至少32位的随机字符串，例如：`MyJwtSecretKey2024!@#$%^&*()_+`

---

### 2. 微信小程序配置（必须修改）

```yaml
app:
  wechat:
    app-id: ${WECHAT_APP_ID:your-app-id}          # ⚠️ 必须修改为你的小程序AppID
    app-secret: ${WECHAT_APP_SECRET:your-app-secret}  # ⚠️ 必须修改为你的小程序AppSecret
```

**获取方式：**
1. 登录 [微信公众平台](https://mp.weixin.qq.com/)
2. 进入"开发" -> "开发管理" -> "开发设置"
3. 查看"AppID(小程序ID)"和"AppSecret(小程序密钥)"

**修改方式：**
- 推荐使用环境变量设置，避免泄露

---

### 3. 阿里云OSS配置（必须修改）

```yaml
app:
  aliyun:
    oss:
      endpoint: ${ALIYUN_OSS_ENDPOINT:your-endpoint}  # ⚠️ 必须修改
      access-key-id: ${ALIYUN_OSS_ACCESS_KEY_ID:your-access-key-id}  # ⚠️ 必须修改
      access-key-secret: ${ALIYUN_OSS_ACCESS_KEY_SECRET:your-access-key-secret}  # ⚠️ 必须修改
      bucket-name: ${ALIYUN_OSS_BUCKET_NAME:your-bucket-name}  # ⚠️ 必须修改
```

**获取方式：**
1. 登录 [阿里云控制台](https://oss.console.aliyun.com/)
2. 创建Bucket（如果还没有）
3. 获取Endpoint（例如：`oss-cn-hangzhou.aliyuncs.com`）
4. 在"访问控制"中创建AccessKey

**Endpoint示例：**
- 华东1（杭州）：`oss-cn-hangzhou.aliyuncs.com`
- 华东2（上海）：`oss-cn-shanghai.aliyuncs.com`
- 华北2（北京）：`oss-cn-beijing.aliyuncs.com`

---

### 4. 阿里云百炼API配置（必须修改）

```yaml
app:
  aliyun:
    dashscope:
      api-key: ${ALIYUN_DASHSCOPE_API_KEY:your-api-key}  # ⚠️ 必须修改
```

**获取方式：**
1. 登录 [阿里云百炼控制台](https://dashscope.console.aliyun.com/)
2. 进入"API-KEY管理"
3. 创建新的API Key

---

### 5. 微信支付配置（可选，支付功能需要）

```yaml
app:
  wechat-pay:
    app-id: ${WECHAT_PAY_APP_ID:your-app-id}  # 微信支付AppID（通常与小程序AppID相同）
    mch-id: ${WECHAT_PAY_MCH_ID:your-mch-id}  # 商户号
    api-v3-key: ${WECHAT_PAY_API_V3_KEY:your-api-v3-key}  # API v3密钥
    cert-path: ${WECHAT_PAY_CERT_PATH:your-cert-path}  # 证书路径
```

**获取方式：**
1. 登录 [微信支付商户平台](https://pay.weixin.qq.com/)
2. 在"账户中心" -> "API安全"中配置API密钥
3. 下载API证书

---

### 6. 服务器端口配置（可选）

```yaml
server:
  port: 8080  # 默认8080，如果端口被占用可以修改
  servlet:
    context-path: /api  # API路径前缀
```

---

### 7. 数据库配置（开发环境，可选）

```yaml
spring:
  datasource:
    url: jdbc:h2:file:./data/shopdb  # H2数据库文件路径
    username: sa
    password:  # 可以为空
```

**生产环境建议：** 迁移到MySQL，修改为：
```yaml
spring:
  datasource:
    url: jdbc:mysql://localhost:3306/shopdb?useUnicode=true&characterEncoding=utf8&useSSL=false
    username: your-username
    password: your-password
    driver-class-name: com.mysql.cj.jdbc.Driver
```

---

## 二、前端配置 (frontend/src/utils/request.js)

### 1. API基础地址（必须修改）

```javascript
const BASE_URL = 'http://localhost:8080/api' // ⚠️ 必须修改为实际后端地址
```

**修改说明：**
- **开发环境：** 如果后端运行在本地，保持 `http://localhost:8080/api`
- **测试环境：** 修改为测试服务器地址，例如：`https://test-api.yourdomain.com/api`
- **生产环境：** 修改为生产服务器地址，例如：`https://api.yourdomain.com/api`

**注意事项：**
- 微信小程序要求使用HTTPS（生产环境）
- 需要在微信公众平台配置"服务器域名"
- 开发环境可以使用本地IP，例如：`http://192.168.1.100:8080/api`

---

## 三、微信小程序配置 (frontend/manifest.json)

### 1. 小程序AppID（必须修改）

```json
{
  "mp-weixin": {
    "appid": "",  // ⚠️ 必须填写你的小程序AppID
    ...
  }
}
```

**修改方式：**
- 在微信开发者工具中也可以直接配置
- 必须与后端配置的 `WECHAT_APP_ID` 一致

---

### 2. 小程序名称和描述（可选）

```json
{
  "name": "AI印花电商",  // 可以修改为你的小程序名称
  "description": "AI印花电商小程序",  // 可以修改描述
  "appid": "__UNI__AIPRINTSHOP",  // 可以修改为你的唯一标识
}
```

---

## 四、环境变量配置（推荐方式）

### Windows系统

创建 `backend/.env` 文件（如果使用Spring Boot的env支持）或设置系统环境变量：

```bash
# 在PowerShell中设置
$env:JWT_SECRET="your-secret-key-here"
$env:WECHAT_APP_ID="wx1234567890abcdef"
$env:WECHAT_APP_SECRET="your-app-secret-here"
$env:ALIYUN_OSS_ENDPOINT="oss-cn-hangzhou.aliyuncs.com"
$env:ALIYUN_OSS_ACCESS_KEY_ID="your-access-key-id"
$env:ALIYUN_OSS_ACCESS_KEY_SECRET="your-access-key-secret"
$env:ALIYUN_OSS_BUCKET_NAME="your-bucket-name"
$env:ALIYUN_DASHSCOPE_API_KEY="sk-your-api-key"
```

### Linux/Mac系统

创建 `backend/.env` 文件或添加到 `~/.bashrc` / `~/.zshrc`：

```bash
export JWT_SECRET="your-secret-key-here"
export WECHAT_APP_ID="wx1234567890abcdef"
export WECHAT_APP_SECRET="your-app-secret-here"
export ALIYUN_OSS_ENDPOINT="oss-cn-hangzhou.aliyuncs.com"
export ALIYUN_OSS_ACCESS_KEY_ID="your-access-key-id"
export ALIYUN_OSS_ACCESS_KEY_SECRET="your-access-key-secret"
export ALIYUN_OSS_BUCKET_NAME="your-bucket-name"
export ALIYUN_DASHSCOPE_API_KEY="sk-your-api-key"
```

---

## 五、微信小程序服务器域名配置

在微信公众平台配置服务器域名：

1. 登录 [微信公众平台](https://mp.weixin.qq.com/)
2. 进入"开发" -> "开发管理" -> "开发设置"
3. 配置"服务器域名"：
   - **request合法域名：** 添加你的后端API地址（例如：`https://api.yourdomain.com`）
   - **uploadFile合法域名：** 添加OSS域名（例如：`https://your-bucket.oss-cn-hangzhou.aliyuncs.com`）
   - **downloadFile合法域名：** 添加OSS域名

**开发环境：**
- 可以在微信开发者工具中勾选"不校验合法域名"进行开发测试

---

## 六、配置检查清单

在启动项目前，请确认以下配置已正确设置：

### 后端配置 ✅
- [ ] JWT_SECRET 已设置（至少32位强密码）
- [ ] WECHAT_APP_ID 已设置
- [ ] WECHAT_APP_SECRET 已设置
- [ ] ALIYUN_OSS_ENDPOINT 已设置
- [ ] ALIYUN_OSS_ACCESS_KEY_ID 已设置
- [ ] ALIYUN_OSS_ACCESS_KEY_SECRET 已设置
- [ ] ALIYUN_OSS_BUCKET_NAME 已设置
- [ ] ALIYUN_DASHSCOPE_API_KEY 已设置
- [ ] 微信支付配置（如果使用支付功能）

### 前端配置 ✅
- [ ] `frontend/src/utils/request.js` 中的 BASE_URL 已修改
- [ ] `frontend/manifest.json` 中的 appid 已填写
- [ ] 微信小程序服务器域名已配置（生产环境）

### 服务配置 ✅
- [ ] 阿里云OSS Bucket已创建
- [ ] 阿里云百炼API Key已获取
- [ ] 微信小程序已注册并获取AppID和AppSecret
- [ ] 微信支付商户号已申请（如果使用支付功能）

---

## 七、快速配置脚本

### 创建配置模板文件

在 `backend/` 目录下创建 `.env.example` 文件（不要提交到Git）：

```bash
# JWT配置
JWT_SECRET=your-secret-key-change-in-production

# 微信小程序配置
WECHAT_APP_ID=your-app-id
WECHAT_APP_SECRET=your-app-secret

# 阿里云OSS配置
ALIYUN_OSS_ENDPOINT=oss-cn-hangzhou.aliyuncs.com
ALIYUN_OSS_ACCESS_KEY_ID=your-access-key-id
ALIYUN_OSS_ACCESS_KEY_SECRET=your-access-key-secret
ALIYUN_OSS_BUCKET_NAME=your-bucket-name

# 阿里云百炼配置
ALIYUN_DASHSCOPE_API_KEY=sk-your-api-key

# 微信支付配置（可选）
WECHAT_PAY_APP_ID=your-app-id
WECHAT_PAY_MCH_ID=your-mch-id
WECHAT_PAY_API_V3_KEY=your-api-v3-key
WECHAT_PAY_CERT_PATH=your-cert-path
```

然后复制为 `.env` 并填写实际值：
```bash
cp .env.example .env
# 编辑 .env 文件，填写实际配置值
```

---

## 八、常见问题

### 1. 后端启动失败
- 检查环境变量是否正确设置
- 检查端口8080是否被占用
- 检查数据库连接是否正常

### 2. 前端无法连接后端
- 检查 `BASE_URL` 是否正确
- 检查后端服务是否已启动
- 检查网络连接和防火墙设置
- 微信小程序需要配置服务器域名

### 3. 微信登录失败
- 检查 AppID 和 AppSecret 是否正确
- 检查是否在微信公众平台配置了服务器域名
- 检查后端日志查看具体错误信息

### 4. OSS上传失败
- 检查 OSS 配置是否正确
- 检查 Bucket 是否存在
- 检查 AccessKey 权限是否足够

### 5. AI生成失败
- 检查百炼API Key是否正确
- 检查账户余额是否充足
- 检查API调用频率限制

---

## 九、安全建议

1. **不要将敏感配置提交到Git**
   - 使用 `.gitignore` 忽略 `.env` 文件
   - 使用环境变量而不是硬编码

2. **生产环境使用强密码**
   - JWT_SECRET 至少32位随机字符串
   - 定期更换密钥

3. **限制API访问**
   - 配置OSS Bucket访问权限
   - 使用CDN加速并配置防盗链
   - 配置微信小程序服务器域名白名单

4. **监控和日志**
   - 配置日志级别
   - 监控API调用情况
   - 设置异常告警

---

## 十、配置优先级

Spring Boot配置优先级（从高到低）：
1. 命令行参数
2. 系统环境变量
3. application.yml 中的默认值

建议使用环境变量方式配置敏感信息。

