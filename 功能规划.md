# AI印花电商小程序 - 功能规划文档

## 一、核心功能模块

### 1. AI图片生成模块
> **技术实现**：基于阿里云百炼（通义万相）API实现文生图和图生图功能

#### 1.1 文生图功能
- **文本输入**
  - 支持多语言输入（中文、英文）
  - 提示词智能补全/推荐
  - 提示词模板库（风格、主题分类）
  - 负面提示词设置
  - 字数限制与提示

- **参数设置**
  - 图片尺寸选择（预设：正方形、横版、竖版）
    - 阿里百炼支持的尺寸规格
  - 自定义尺寸（宽高比限制）
  - 生成数量（单次1-4张）
  - 风格选择（写实、插画、抽象、水彩等）
    - 对应阿里百炼的风格参数
  - 质量等级（标准、高清、超高清）
  - 随机种子设置（可复现）

- **生成过程**
  - 实时生成进度显示（轮询任务状态）
  - 预计等待时间（基于历史数据估算）
  - 生成队列管理（Spring Boot异步任务队列）
  - 生成历史记录（H2数据库存储）

#### 1.2 图生图功能
- **图片上传**
  - 本地相册选择（uni.chooseImage）
  - 拍照上传
  - 从作品集选择
  - 图片格式支持（JPG、PNG、WebP）
  - 图片大小限制与压缩（上传前压缩，上传到OSS）

- **变换设置**
  - 相似度控制（0-100%）
    - 对应阿里百炼图生图的强度参数
  - 风格迁移强度
  - 局部重绘功能（涂抹区域）
    - 需要先上传原图到OSS，再调用API
  - 背景替换
  - 颜色调整（色温、饱和度、对比度）
    - 可在前端预处理或使用OSS图片处理

- **混合模式**
  - 图片叠加
  - 透明度调节
  - 混合算法选择

### 2. 作品集管理模块
#### 2.1 作品创建与编辑
- **作品信息**
  - 作品标题
  - 作品描述/标签
  - 创建时间
  - 生成参数记录（便于复现）

- **作品分类**
  - 自定义分类/文件夹
  - 标签系统（多标签）
  - 收藏夹
  - 最近生成
  - 最受欢迎

- **作品操作**
  - 查看大图（支持缩放、旋转）
  - 编辑作品信息
  - 删除作品
  - 分享作品（生成分享图、链接）
  - 导出作品（原图下载）
  - 复制作品（快速生成相似作品）

#### 2.2 作品预览与应用
- **印花预览**
  - 3D包包模型预览（多角度）
  - 不同包包款式选择（手提包、单肩包、双肩包等）
  - 不同材质效果（皮革、帆布、尼龙等）
  - 实时预览（拖拽调整位置、缩放）
  - 多款包包对比预览

- **应用设置**
  - 印花位置调整（居中、左上、右下等）
  - 印花大小调节
  - 印花透明度
  - 印花重复模式（单次、平铺、镜像）
  - 颜色适配（自动调整印花颜色匹配包包）

### 3. 购物车与订单模块
#### 3.1 购物车功能
- **商品管理**
  - 添加作品到购物车
  - 选择包包款式（颜色、尺寸）
  - 选择印花位置和大小
  - 数量选择
  - 删除商品
  - 批量操作（全选、删除）

- **价格计算**
  - 基础包包价格
  - 印花定制费用（按复杂度）
  - 数量折扣
  - 运费计算
  - 优惠券/折扣码

- **结算流程**
  - 购物车预览
  - 订单确认页面
  - 收货地址管理
  - 支付方式选择（微信支付、支付宝等）
  - 订单备注

#### 3.2 订单管理
- **订单状态**
  - 待支付
  - 已支付/待制作
  - 制作中
  - 已发货
  - 已完成
  - 已取消/退款

- **订单详情**
  - 订单编号
  - 商品信息（图片、规格）
  - 价格明细
  - 物流信息（快递单号、物流跟踪）
  - 预计送达时间
  - 订单操作（取消、申请退款、确认收货、评价）

- **订单历史**
  - 全部订单
  - 按状态筛选
  - 订单搜索
  - 订单导出

## 二、用户系统模块

### 1. 用户注册与登录
- 微信授权登录（一键登录）
- 手机号登录
- 账号密码登录
- 找回密码
- 用户协议与隐私政策

### 2. 个人中心
- **个人信息**
  - 头像、昵称编辑
  - 个人简介
  - 绑定手机号/邮箱

- **账户管理**
  - 余额查询
  - 充值功能
  - 消费记录
  - 优惠券管理
  - 积分系统

- **数据统计**
  - 生成作品数量
  - 收藏作品数
  - 购物车商品数
  - 订单统计（总订单、待支付、待收货等）

## 三、商城功能模块

### 1. 商品展示
- **包包分类**
  - 按类型分类（手提包、单肩包、双肩包、钱包等）
  - 按风格分类（商务、休闲、时尚、运动等）
  - 按价格区间
  - 按材质分类

- **商品详情**
  - 多角度商品图
  - 规格选择（尺寸、颜色）
  - 材质说明
  - 定制说明
  - 用户评价
  - 相关推荐

### 2. 推荐系统
- 热门作品推荐
- 相似作品推荐
- 个性化推荐（基于用户历史）
- 新品推荐
- 限时优惠

## 四、社交与分享模块

### 1. 作品分享
- 分享到微信好友/群
- 分享到朋友圈
- 生成分享海报（带二维码）
- 分享链接（他人可查看、收藏）

### 2. 社区功能（可选）
- 作品展示墙（公开作品集）
- 点赞、评论、收藏
- 关注用户
- 热门作品排行榜
- 每日精选

## 五、AI增强功能

### 1. 智能推荐
- 根据用户输入推荐提示词
- 根据用户喜好推荐风格
- 智能配色建议
- 图案优化建议

### 2. 批量处理
- 批量生成相似风格作品
- 批量应用印花
- 批量导出作品

### 3. 历史学习
- 记录用户偏好
- 推荐相似风格
- 快速复现历史作品

## 六、运营功能模块

### 1. 活动营销
- 新人优惠券
- 限时折扣
- 满减活动
- 会员权益
- 邀请好友奖励

### 2. 内容运营
- 使用教程（视频/图文）
- 设计灵感库
- 案例展示
- 常见问题FAQ

### 3. 数据统计（后台）
- 用户生成量统计
- 热门风格分析
- 转化率分析
- 用户行为分析

## 七、技术功能需求

### 1. 性能优化
- **图片压缩与优化**
  - 前端：uni.compressImage 压缩上传前图片
  - 后端：阿里云OSS图片处理（自动压缩、格式转换）
  - CDN加速访问
- **懒加载**：uni-app 图片懒加载组件
- **缓存策略**
  - 前端：uni.setStorage 本地缓存作品列表
  - 后端：Spring Cache（Redis，可选）缓存热点数据
  - H2数据库查询优化
- **离线功能**：查看已生成作品（本地缓存）

### 2. 用户体验
- **加载动画**：uni.showLoading / 骨架屏
- **错误提示与重试**：统一错误处理机制
- **操作引导**：新用户教程（使用 uni.showModal）
- **快捷操作**：手势操作、下拉刷新

### 3. 数据安全
- **作品云端同步**：所有作品存储在阿里云OSS
- **数据备份**：
  - H2数据库定期备份（文件模式）
  - OSS开启版本控制和跨区域复制
- **隐私保护**：用户作品仅本人可见（除非主动分享）
- **版权声明**：明确AI生成作品的使用权归属

### 4. AI服务集成
- **阿里百炼API集成**
  - 文生图：调用通义万相文生图接口
  - 图生图：调用通义万相图生图接口
  - 异步任务处理：使用Spring异步任务处理生成请求
  - 生成队列管理：使用数据库队列表管理生成任务
- **错误处理**：API调用失败重试机制、降级方案
- **成本控制**：生成次数限制、用户配额管理

## 八、功能优先级建议

### P0（核心功能，必须实现）
1. 用户登录/注册
2. AI文生图基础功能
3. 作品集基础管理（添加、查看、删除）
4. 购物车基础功能
5. 订单创建与支付
6. 包包印花预览

### P1（重要功能，尽快实现）
1. 图生图功能
2. 作品分类与标签
3. 订单管理
4. 个人中心
5. 分享功能
6. 多种包包款式选择

### P2（增强功能，后续迭代）
1. 社区功能
2. 智能推荐
3. 批量处理
4. 高级编辑功能
5. 会员系统
6. 数据分析

### P3（优化功能，长期规划）
1. 3D预览增强
2. AR试穿
3. 多语言支持
4. 高级定制选项
5. 供应链管理

## 九、用户体验流程

### 核心用户流程
1. **新用户流程**
   - 注册/登录 → 浏览示例 → 尝试生成 → 查看作品 → 添加到购物车 → 下单

2. **生成作品流程**
   - 选择生成方式（文生图/图生图）→ 输入/上传 → 设置参数 → 生成 → 预览 → 保存到作品集

3. **购买流程**
   - 浏览作品集 → 选择作品 → 预览印花效果 → 选择包包款式 → 加入购物车 → 结算 → 支付 → 查看订单

4. **复购流程**
   - 查看历史订单 → 快速复购 → 或重新生成新作品

## 十、技术栈选型

### 前端
- **小程序框架**：uni-app（Vue3）
- **UI组件库**：uView UI / Vant Weapp
- **状态管理**：Pinia（推荐）或 Vuex
- **图片处理**：Canvas API / uni.canvasToTempFilePath
- **网络请求**：uni.request / axios封装
- **路由管理**：uni-app 页面路由

### 后端
- **服务端框架**：Spring Boot 2.7+ / 3.0+
- **数据库**：H2 Database（嵌入式，开发/测试环境）
  - 支持内存模式（开发）和文件模式（持久化）
  - 可迁移到 MySQL/PostgreSQL（生产环境）
- **ORM框架**：Spring Data JPA / MyBatis-Plus
- **API文档**：Swagger / Knife4j
- **安全框架**：Spring Security + JWT
- **任务调度**：Spring Task / Quartz（用于AI生成队列）

### AI服务
- **图片生成服务**：阿里云百炼（通义万相）
  - 文生图 API
  - 图生图 API
  - 图片编辑 API
- **API集成方式**：Spring Boot 集成阿里云SDK
- **异步处理**：使用 Spring @Async 处理生成任务

### 文件存储
- **对象存储**：阿里云OSS（Object Storage Service）
  - 图片上传：使用 OSS SDK 直传或服务端签名后上传
  - 图片访问：CDN加速访问
  - 图片处理：OSS图片处理服务（缩放、裁剪、水印等）
- **存储结构**：
  - `/images/works/` - 用户生成的作品
  - `/images/previews/` - 预览图
  - `/images/products/` - 商品图片
  - `/images/avatars/` - 用户头像

### 第三方服务
- **支付服务**：微信支付（小程序支付）
- **推送服务**：微信模板消息 / 订阅消息
- **数据分析**：微信小程序统计
- **图片处理**：阿里云OSS图片处理 / 阿里云智能媒体管理（IMM）

### 开发工具
- **前端开发**：HBuilderX / VS Code
- **后端开发**：IntelliJ IDEA
- **API测试**：Postman / Apifox
- **版本控制**：Git

### 部署方案
- **前端部署**：微信小程序平台
- **后端部署**：
  - 开发环境：本地运行（H2文件模式）
  - 测试环境：阿里云ECS / 轻量应用服务器
  - 生产环境：阿里云ECS + RDS（如迁移MySQL）
- **数据库迁移**：H2 → MySQL（生产环境建议）

---

## 总结

这是一个以AI图片生成为核心的定制化电商小程序，重点在于：
1. **AI生成体验**：基于阿里云百炼（通义万相）实现流畅的生成流程，丰富的参数控制
2. **作品管理**：完善的分类、预览、编辑功能，作品存储在阿里云OSS
3. **购物体验**：直观的印花预览，便捷的购买流程
4. **用户留存**：作品集、历史记录、社交分享

### 技术架构特点
- **前端**：uni-app 跨平台开发，一套代码多端运行
- **后端**：Spring Boot + H2 快速开发，H2适合MVP阶段，后续可平滑迁移到MySQL
- **存储**：阿里云OSS统一存储，CDN加速访问
- **AI服务**：阿里云百炼提供稳定的图片生成能力

### 开发建议
建议采用MVP（最小可行产品）方式，先实现P0功能，快速上线验证，再逐步迭代P1、P2功能。

**MVP阶段优势**：
- H2数据库无需额外配置，快速启动
- 阿里云百炼API开箱即用，无需自建模型
- uni-app开发效率高，支持热更新
- OSS存储成本低，按量付费

---

## 十一、技术实现细节

### 1. 阿里云百炼集成方案

#### 1.1 服务开通
- 注册阿里云账号
- 开通百炼服务（通义万相）
- 获取 AccessKey ID 和 AccessKey Secret
- 配置API调用权限

#### 1.2 Spring Boot集成
```java
// 依赖配置（pom.xml）
<dependency>
    <groupId>com.aliyun</groupId>
    <artifactId>dashscope-sdk-java</artifactId>
    <version>最新版本</version>
</dependency>

// 配置类
@Configuration
public class DashScopeConfig {
    @Value("${aliyun.dashscope.api-key}")
    private String apiKey;
    
    @Bean
    public DashScopeClient dashScopeClient() {
        return new DashScopeClient(apiKey);
    }
}
```

#### 1.3 API调用示例
- **文生图**：调用 `TextToImageTask` API
- **图生图**：调用 `ImageToImageTask` API
- **异步处理**：使用 `@Async` 注解处理生成任务
- **结果存储**：生成完成后上传到OSS，保存URL到H2数据库

### 2. H2数据库配置

#### 2.1 开发环境配置
```yaml
# application-dev.yml
spring:
  datasource:
    url: jdbc:h2:mem:testdb  # 内存模式
    driver-class-name: org.h2.Driver
    username: sa
    password: 
  h2:
    console:
      enabled: true
      path: /h2-console
```

#### 2.2 测试/生产环境配置
```yaml
# application-prod.yml
spring:
  datasource:
    url: jdbc:h2:file:./data/shopdb  # 文件模式，持久化
    driver-class-name: org.h2.Driver
    username: sa
    password: ${DB_PASSWORD}
```

#### 2.3 数据库迁移准备
- 使用 Flyway 或 Liquibase 管理数据库版本
- 设计兼容MySQL的SQL语句
- 生产环境可平滑迁移到MySQL

### 3. 阿里云OSS集成

#### 3.1 SDK配置
```java
// 依赖
<dependency>
    <groupId>com.aliyun.oss</groupId>
    <artifactId>aliyun-sdk-oss</artifactId>
    <version>最新版本</version>
</dependency>

// 配置类
@Configuration
public class OssConfig {
    @Value("${aliyun.oss.endpoint}")
    private String endpoint;
    
    @Value("${aliyun.oss.access-key-id}")
    private String accessKeyId;
    
    @Value("${aliyun.oss.access-key-secret}")
    private String accessKeySecret;
    
    @Value("${aliyun.oss.bucket-name}")
    private String bucketName;
    
    @Bean
    public OSS ossClient() {
        return new OSSClientBuilder().build(endpoint, accessKeyId, accessKeySecret);
    }
}
```

#### 3.2 上传策略
- **前端直传**：后端生成OSS签名URL，前端直接上传（推荐）
- **服务端上传**：前端上传到后端，后端再上传到OSS
- **CDN配置**：OSS绑定CDN域名，加速图片访问

### 4. uni-app与Spring Boot通信

#### 4.1 API接口设计
- RESTful API设计
- 统一响应格式（Result<T>）
- 统一异常处理
- JWT Token认证

#### 4.2 跨域配置
```java
@Configuration
public class CorsConfig {
    @Bean
    public WebMvcConfigurer corsConfigurer() {
        return new WebMvcConfigurer() {
            @Override
            public void addCorsMappings(CorsRegistry registry) {
                registry.addMapping("/api/**")
                    .allowedOrigins("*")  // 生产环境配置具体域名
                    .allowedMethods("GET", "POST", "PUT", "DELETE")
                    .allowedHeaders("*");
            }
        };
    }
}
```

### 5. 微信支付集成

#### 5.1 小程序支付流程
1. 用户下单，后端创建订单
2. 调用微信支付统一下单API
3. 返回支付参数给前端
4. 前端调用 `uni.requestPayment` 发起支付
5. 支付成功后，微信回调后端更新订单状态

#### 5.2 支付安全
- 支付参数签名验证
- 支付回调验签
- 订单状态幂等性处理

### 6. 性能优化建议

#### 6.1 前端优化
- 图片懒加载
- 列表虚拟滚动（长列表）
- 请求防抖和节流
- 本地缓存策略

#### 6.2 后端优化
- H2数据库索引优化
- 异步任务处理（AI生成）
- 接口响应缓存（Redis，可选）
- 数据库连接池配置

#### 6.3 OSS优化
- 图片压缩（上传前）
- OSS图片处理（按需生成不同尺寸）
- CDN缓存策略
- 图片格式优化（WebP）

